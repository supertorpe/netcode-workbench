var t=Object.defineProperty,e=(e,i,s)=>(((e,i,s)=>{i in e?t(e,i,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[i]=s})(e,"symbol"!=typeof i?i+"":i,s),s);export function __vite_legacy_guard(){import("data:text/javascript,")}import{x as i,l as s,f as o,t as n,e as a,d as r,p as c,u as l,j as h,S as m,a as d,b as p}from"./vendor.c03453b5.js";!function(){const t=document.createElement("link").relList;if(!(t&&t.supports&&t.supports("modulepreload"))){for(const t of document.querySelectorAll('link[rel="modulepreload"]'))e(t);new MutationObserver((t=>{for(const i of t)if("childList"===i.type)for(const t of i.addedNodes)"LINK"===t.tagName&&"modulepreload"===t.rel&&e(t)})).observe(document,{childList:!0,subtree:!0})}function e(t){if(t.ep)return;t.ep=!0;const e=function(t){const e={};return t.integrity&&(e.integrity=t.integrity),t.referrerpolicy&&(e.referrerPolicy=t.referrerpolicy),"use-credentials"===t.crossorigin?e.credentials="include":"anonymous"===t.crossorigin?e.credentials="omit":e.credentials="same-origin",e}(t);fetch(t.href,e)}}();const g={};var f={canvas:{width:300,height:250},network:{tickMs:50,minLatency1:10,maxLatency1:30,packetLoss1:0,minLatency2:10,maxLatency2:30,packetLoss2:0},serializers:[{name:"json"},{name:"cbor-x"},{name:"msgpackr"}],netcodes:[{name:"p2p-naive",type:"p2p"},{name:"p2p-delayed",type:"p2p"},{name:"p2p-rollback",type:"p2p"},{name:"cs-lockstep",type:"cs"},{name:"custom",type:"custom"}],players:[{id:1,color:"#483D8B",x:10,y:10,size:20,keyUp:87,keyDown:83,keyLeft:65,keyRight:68},{id:2,color:"#6B8E23",x:270,y:220,size:20,keyUp:38,keyDown:40,keyLeft:37,keyRight:39}],coin:{color:"orange",x:150,y:125,size:10},npc:{color:"black"},border:{color:"#708090"},physics:{worldScale:30,strength:10,borderThickness:5}};const u=0,y=1,S=2,v=10,w=20,k=11,x=21,E=12,L=22;class _{constructor(t,e){this.name=t,this.type=e}}const C=f;class P{constructor(){e(this,"_listeners",[])}addEventListener(t){this._listeners.includes(t)||this._listeners.push(t)}removeEventListener(t){const e=this._listeners.indexOf(t);-1!==e&&this._listeners.splice(e,1)}removeListeners(){this._listeners=[]}notify(t){this._listeners.forEach((e=>{e(t)}))}}const I=(t,e)=>Math.floor(Math.random()*(e-t+1)+t),T=()=>(new Date).getTime();class b{constructor(t){e(this,"xorshift"),e(this,"randomValues",[]),this.xorshift=new i.exports.XorShift(t)}randomInt(t,e,i){t++;for(let s=this.randomValues.length;s<=t;s++){let t=this.internalRandomInt(e,i);this.randomValues.push(t)}return this.randomValues[t]}internalRandomInt(t,e){return Math.floor(t+this.xorshift.random()*(e-t))}}var D,G;(G=D||(D={})).INFO="INFO",G.WARN="WARN",G.ERROR="ERROR";const $=class{constructor(t,i,s){e(this,"_id"),this.level=t,this.timestamp=i,this.text=s,this._id=$.idCounter++}get id(){return this._id}toString(){const t=new Date;return t.setTime(this.timestamp),`${t.getHours().toString().padStart(2,"0")}:${t.getMinutes().toString().padStart(2,"0")}:${t.getSeconds().toString().padStart(2,"0")}.${t.getMilliseconds().toString().padStart(3,"0")} ${this.level.padEnd(5)} ${this.text}`}};let z=$;e(z,"idCounter",0);class B{constructor(){e(this,"_traces",[])}get traces(){return this._traces}log(t,e){this._traces.unshift(new z(t,T(),e))}logInfo(t){this.log(D.INFO,t)}logWarn(t){this.log(D.WARN,t)}logError(t){this.log(D.ERROR,t)}clear(){this._traces=[]}toString(){const t=this._traces.reverse().join("\n");return this._traces.reverse(),t}}class R{constructor(t,e){this.timestamp=t,this.size=e}}class O{constructor(){e(this,"timeIncoming",0),e(this,"sizeIncoming",0),e(this,"timeOutgoing",0),e(this,"sizeOutgoing",0),e(this,"latestTimeIncomingNotified",0),e(this,"latestTimeOutgoingNotified",0),e(this,"_outgoingEmitter",new P),e(this,"_incomingEmitter",new P)}get outgoingEmitter(){return this._outgoingEmitter}get incomingEmitter(){return this._incomingEmitter}logOut(t,e){const i=Math.floor(t/1e3);0===this.timeOutgoing&&(this.timeOutgoing=i),this.timeOutgoing!==i?(this.latestTimeOutgoingNotified=this.timeOutgoing,this._outgoingEmitter.notify(new R(this.timeOutgoing,this.sizeOutgoing)),this.timeOutgoing=i,this.sizeOutgoing=e):this.sizeOutgoing+=e}logIn(t,e){const i=Math.floor(t/1e3);0===this.timeIncoming&&(this.timeIncoming=i),this.timeIncoming!==i?(this.latestTimeIncomingNotified=this.timeIncoming,this._incomingEmitter.notify(new R(this.timeIncoming,this.sizeIncoming)),this.timeIncoming=i,this.sizeIncoming=e):this.sizeIncoming+=e}flush(){this.latestTimeOutgoingNotified!==this.timeOutgoing&&this._outgoingEmitter.notify(new R(this.timeOutgoing,this.sizeOutgoing)),this.latestTimeIncomingNotified!==this.timeIncoming&&this._incomingEmitter.notify(new R(this.timeIncoming,this.sizeIncoming)),this.timeIncoming=0,this.sizeIncoming=0,this.timeOutgoing=0,this.sizeOutgoing=0,this.latestTimeIncomingNotified=0,this.latestTimeOutgoingNotified=0}removeListeners(){this._outgoingEmitter.removeListeners(),this._incomingEmitter.removeListeners()}}class M{constructor(){e(this,"_trafficlog",new O),e(this,"connections",[]),e(this,"_connectionEmitter",new P),e(this,"_disconnectionEmitter",new P),e(this,"_messageSentEmitter",new P),e(this,"_messageReceivedEmitter",new P)}get trafficLog(){return this._trafficlog}get connectionCount(){return this.connections.length}get connectionEmitter(){return this._connectionEmitter}get disconnectionEmitter(){return this._disconnectionEmitter}get messageSentEmitter(){return this._messageSentEmitter}get messageReceivedEmitter(){return this._messageReceivedEmitter}connect(t,e){this.attachListeners(t),this.connections.push(t),t.connect(e)}attachListeners(t){t.connectionEmitter.addEventListener((t=>{this._connectionEmitter.notify(t)})),t.disconnectionEmitter.addEventListener((t=>{this._disconnectionEmitter.notify(t)})),t.messageReceivedEmitter.addEventListener((t=>{this._messageReceivedEmitter.notify(t)})),t.messageSentEmitter.addEventListener((t=>{this._messageSentEmitter.notify(t)}))}findConnection(t){return this.connections.find((e=>e.peer.peerId===t))}closeConnections(){this.connections.forEach((t=>{t.close(),t.removeListeners()})),this.connections=[]}removeListeners(){this._connectionEmitter.removeListeners(),this._disconnectionEmitter.removeListeners(),this._messageSentEmitter.removeListeners(),this._messageReceivedEmitter.removeListeners()}broadcast(t){this.connections.forEach((e=>{e.send(t)}))}send(t,e){var i;null==(i=this.findConnection(t))||i.send(e)}}class N{constructor(t,i,s,o){e(this,"_closed",!0),e(this,"_peer"),e(this,"_minLatency",0),e(this,"_maxLatency",0),e(this,"_packetLoss",0),e(this,"_totalSent",0),e(this,"_totalLost",0),e(this,"_connectionEmitter",new P),e(this,"_disconnectionEmitter",new P),e(this,"_messageSentEmitter",new P),e(this,"_messageReceivedEmitter",new P),this.intf=t,this.peerId=i,this.log=s,this.serializer=o}get connectionEmitter(){return this._connectionEmitter}get disconnectionEmitter(){return this._disconnectionEmitter}get messageSentEmitter(){return this._messageSentEmitter}get messageReceivedEmitter(){return this._messageReceivedEmitter}get peer(){return this._peer}set minLatency(t){this._minLatency=t}set maxLatency(t){this._maxLatency=t}set packetLoss(t){this._packetLoss=t}connect(t){this._peer=t,this._connectionEmitter.notify(t),this._closed=!1}send(t){if(this._closed)return;if(t.timestampOrigin=T(),t.origin=this.peerId,t.destination=this._peer.peerId,this._packetLoss>0&&this._totalLost+1<this._totalSent*this._packetLoss/100)return this.log.logWarn(`Message for tick ${t.tick} lost`),void this._totalLost++;this._totalSent++;const e=this.serializer.encode(t);this.intf.trafficLog.logOut(t.timestampOrigin,e.byteLength),this._messageSentEmitter.notify(t),0===this.maxLatency?this._peer.receive(e):setTimeout((()=>{this._peer.receive(e)}),I(this._minLatency,this._maxLatency))}receive(t){if(this._closed)return;const e=this.serializer.decode(t);e.timestampDestination=T(),this.intf.trafficLog.logIn(e.timestampDestination,t.byteLength),this._messageReceivedEmitter.notify(e)}close(){this._closed=!0,this._disconnectionEmitter.notify(this._peer)}removeListeners(){this._connectionEmitter.removeListeners(),this._disconnectionEmitter.removeListeners(),this._messageSentEmitter.removeListeners(),this._messageReceivedEmitter.removeListeners()}}class U{constructor(t,e,i,s){this.tick=t,this.playerId=e,this.value=i,this.cloned=s}}class H{static clone(t,e){return new U(t.tick+(e?1:0),t.playerId,t.value,!0)}static cloneArray(t){return t.map((t=>H.clone(t,!1)))}static toString(t){return`P${t.playerId}:${t.value}${t.cloned?"*":""}`}static arrayToString(t){let e="";return t.forEach((t=>{e+=`P${t.playerId}:${t.value}${t.cloned?"*":""} `})),e}static toFullString(t){return`tick ${t.tick} P${t.playerId}:${t.value}${t.cloned?"*":""}`}static arrayToFullString(t){let e="";return t.forEach((t=>{e+=`[tick ${t.tick} P${t.playerId}:${t.value}${t.cloned?"*":""}] `})),e}}class Y{constructor(t,e,i,s){this.id=t,this.x=e,this.y=i,this.score=s}toString(){return`P${this.id} x=${this.x} y=${this.y} score=${this.score}`}}class X{constructor(t,e){this.playerId=t,this.value=e}toString(){return`P${this.playerId}:${this.value}`}}class A{constructor(t,e,i,s=!1){this.tick=t,this.players=e,this.commands=i,this.mismatches=s}toString(){return`tick: ${this.tick}\n  ${this.players.join("\n  ")}\n  ${this.commands.length>0?"Commands:":""} ${this.commands.join(" ")}`}equals(t,e){return(!e||this.commands.length===t.commands.length)&&(this.players.length===t.players.length&&((!e||!this.commands.some((e=>{let i=t.commands.find((t=>t.playerId===e.playerId));return!i||i.value!=e.value})))&&!this.players.some((e=>{let i=t.players.find((t=>t.id===e.id));return!i||i.x!=e.x||i.y!=e.y||i.score!=e.score}))))}}class W{constructor(t,e,i){this.tick=t,this.commands=e,this.randomPointer=i}}const F=class{constructor(t,i,s){e(this,"kind",F.KIND_UNDEFINED),e(this,"timestampOrigin"),e(this,"timestampDestination"),this.tick=t,this.origin=i,this.destination=s}};let V=F;e(V,"KIND_COMMAND","CMD"),e(V,"KIND_GAMESTATE","GST"),e(V,"KIND_UNDEFINED","");class j extends V{constructor(t,i,s){super(t.tick,i,s),e(this,"command"),this.kind=V.KIND_COMMAND,this.command=t}}class K extends V{constructor(t,i,s){super(t.tick,i,s),e(this,"gameState"),this.kind=V.KIND_GAMESTATE,this.gameState=t}}class q{constructor(t,e,i,s,o,n,a,r,c){this.id=t,this.isStatic=e,this.posX=i,this.posY=s,this.velX=o,this.velY=n,this.width=a,this.height=r,this.color=c}}class J extends W{constructor(t,e,i,s){super(t,e,0),this.tick=t,this.commands=e,this.bodies=i,this.scores=s}}class Q{static bodyFromPlayer(t,e){return t.bodies.find((t=>t.id===e))}static toString(t){let e="";return t.bodies.forEach((t=>{t.isStatic||(e+=`    P${t.id} x=${t.posX*C.physics.worldScale} y=${t.posY*C.physics.worldScale}\n`)})),`\nGameState tick: ${t.tick}\n  bodies:\n${e}  ${t.commands.length>0?"commands    ":""}${H.arrayToString(t.commands)}`}static clone(t){const e=[];t.bodies.forEach((t=>{e.push(class{static clone(t){return new q(t.id,t.isStatic,t.posX,t.posY,t.velX,t.velY,t.width,t.height,t.color)}}.clone(t))}));return new J(t.tick,H.cloneArray(t.commands),t.bodies,[...t.scores])}static toLog(t){const e=[];t.bodies.forEach((i=>{i.isStatic||e.push(new Y(i.id,i.posX*C.physics.worldScale,i.posY*C.physics.worldScale,t.scores[i.id-1]))})),e.sort(((t,e)=>t.id>e.id?1:-1));const i=[];return t.commands.forEach((t=>{i.push(new X(t.playerId,t.value))})),i.sort(((t,e)=>t.playerId>e.playerId?1:-1)),new A(t.tick,e,i)}}class Z extends W{constructor(t,e,i,s,o,n,a){super(t,e,a),this.tick=t,this.commands=e,this.world=i,this.bodies=s,this.scores=o,this.playerWhoCollectedTheCoin=n,this.randomPointer=a}}class tt extends class{static incTick(t){t.tick++}static commandFromPlayer(t,e){return t.commands.find((t=>t.playerId===e))}static clearCommands(t){t.commands=[]}}{static extractBodies(t){const e=[];for(let i=t.getBodyList();i;i=i.getNext())e.unshift(i);return e}static bodyFromPlayer(t,e){return t.bodies.find((t=>t.getUserData().id===e))}static toString(t){let e="";return t.bodies.forEach((i=>{if(!i.isStatic()&&i.getUserData()){const s=i.getUserData().id;e+=`    P${s} x=${i.getPosition().x*C.physics.worldScale} y=${i.getPosition().y*C.physics.worldScale} ${s<3?"score="+t.scores[s-1]:""}\n`}})),`\nGameState tick: ${t.tick}\n  bodies:\n${e}  ${t.commands.length>0?"commands:":""}\n    ${H.arrayToString(t.commands)}`}static toLog(t){const e=[];t.bodies.forEach((i=>{if(!i.isStatic()&&i.getUserData()){let s=i.getUserData();e.push(new Y(s.id,i.getPosition().x*C.physics.worldScale,i.getPosition().y*C.physics.worldScale,t.scores[s.id-1]))}})),e.sort(((t,e)=>t.id>e.id?1:-1));const i=[];return t.commands.forEach((t=>{i.push(new X(t.playerId,t.value))})),i.sort(((t,e)=>t.playerId>e.playerId?1:-1)),new A(t.tick,e,i)}static buildSimpleGameState(t){const e=[];return t.bodies.forEach((t=>{if(!t.isStatic()){let i=t.getUserData();const s=new q(i.id,!1,t.getPosition().x,t.getPosition().y,t.getLinearVelocity().x,t.getLinearVelocity().y,i.size,i.size,i.color);e.push(s)}if(t.isStatic()){const i=new q(-1,!0,t.getPosition().x,t.getPosition().y,t.getLinearVelocity().x,t.getLinearVelocity().y,t.getUserData().width,t.getUserData().height,t.getUserData().color);e.push(i)}})),new J(t.tick,[],e,[...t.scores])}}class et{constructor(t,i,s){e(this,"_gameState"),e(this,"_startTime"),e(this,"_tickMs"),e(this,"_currentTick"),e(this,"_gamestateLogEmitter",new P),this.log=t,this.net=i,this.gameStateMachine=s,this._startTime=0,this._tickMs=50,this._currentTick=0,this.net.messageReceivedEmitter.addEventListener((t=>{t.kind===V.KIND_COMMAND?this.remoteCommandReceived(t.command):t.kind===V.KIND_GAMESTATE?this.gameStateReceived(t.gameState):this.log.logError(`Unknown message received: ${t}`)}))}get tickMs(){return this._tickMs}set tickMs(t){this._tickMs=t}get currentTick(){return this._currentTick}get gamestateLogEmitter(){return this._gamestateLogEmitter}start(t){return this._startTime=T(),this._currentTick=0,t&&(this._gameState=t),this._startTime}tickBasedOnTime(){return Math.floor((T()-this._startTime)/this._tickMs)}tickTime(t){return this._startTime+t*this.tickMs}}class it extends et{constructor(){super(...arguments),e(this,"localCommandTick",-1),e(this,"lastTickReturned",-1)}tick(){this.lastTickReturned<this._currentTick&&this._gameState&&(this.lastTickReturned=this._currentTick,this.log.logInfo(Q.toString(this._gameState)),this._gamestateLogEmitter.notify(Q.toLog(this._gameState)))}localCommandReceived(t,e){if(this.localCommandTick<this._currentTick){this.localCommandTick=this._currentTick;const i=new U(this._currentTick,t,e);this.log.logInfo(`sending local command: ${H.toFullString(i)}`),this.net.broadcast(new j(i))}}remoteCommandReceived(t){throw new Error("CSLockstepClientNetCode: does not support receiving remote commands")}gameStateReceived(t){this.log.logInfo(`received gamestate: ${Q.toLog(this._gameState)}`),t.tick<this._currentTick?this.log.logInfo(`ignoring old gamestate: ${t.tick}`):(this._gameState=t,this._currentTick=t.tick)}getGameStateToRender(){return this._gameState}getGameState(t){return this._gameState.tick===t?this._gameState:void 0}}class st extends et{constructor(){super(...arguments),e(this,"initialGameStateSent",!1),e(this,"remoteCommands",[])}tick(){if(!this.initialGameStateSent){this.initialGameStateSent=!0;const t=tt.buildSimpleGameState(this._gameState);this.log.logInfo(`sending gamestate: ${Q.toLog(t)}`),this.net.broadcast(new K(t)),this._gamestateLogEmitter.notify(tt.toLog(this._gameState))}if(this.tickBasedOnTime()>this._currentTick){let t=0;const e=this.remoteCommands.length;for(let i=0;i<e;i++){let e=this.remoteCommands[i-t];e&&e.tick===this._currentTick&&(this._gameState.commands.push(e),this.remoteCommands.splice(i-t++,1))}if(this._gameState.commands.length<this.net.connectionCount)this.log.logWarn(`Waiting commands for tick ${this._currentTick}: ${this._gameState.commands.length} of ${this.net.connectionCount}`);else{this._gameState.commands.sort(((t,e)=>t.playerId>e.playerId?1:-1)),this.log.logInfo(tt.toString(this._gameState)),this._gamestateLogEmitter.notify(tt.toLog(this._gameState)),this.gameStateMachine.compute(this._gameState),this._currentTick++,tt.incTick(this._gameState),tt.clearCommands(this._gameState);const t=tt.buildSimpleGameState(this._gameState);this.log.logInfo(`sending gamestate: ${Q.toLog(t)}`),this.net.broadcast(new K(t))}}}localCommandReceived(t,e){throw new Error("CSLockstepServerNetCode: does not support receiving local commands")}remoteCommandReceived(t){this.log.logInfo(`received command: ${H.toFullString(t)}`),this.remoteCommands.push(t)}gameStateReceived(t){throw new Error("CSLockstepServerNetCode: does not support receiving game states")}getGameStateToRender(){return this._gameState}getGameState(t){return this._gameState.tick===t?this._gameState:void 0}}class ot extends et{constructor(){super(...arguments),e(this,"localCommand"),e(this,"localCommandDumped",!1),e(this,"remoteCommands",[])}start(t){return super.start(t)}tick(){if(this.tickBasedOnTime()>this._currentTick){!this.localCommandDumped&&this.localCommand&&(this.localCommandDumped=!0,this._gameState.commands.push(this.localCommand));let t=0;const e=this.remoteCommands.length;for(let i=0;i<e;i++){let e=this.remoteCommands[i-t];e&&e.tick===this._currentTick&&(this._gameState.commands.push(e),this.remoteCommands.splice(i-t++,1))}this._gameState.commands.length<this.net.connectionCount+1?this.log.logWarn(`Waiting commands for tick ${this._currentTick}: ${this._gameState.commands.length} of ${this.net.connectionCount+1}`):(this._gameState.commands.sort(((t,e)=>t.playerId>e.playerId?1:-1)),this.log.logInfo(tt.toString(this._gameState)),this._gamestateLogEmitter.notify(tt.toLog(this._gameState)),this.gameStateMachine.compute(this._gameState),this._currentTick++,tt.incTick(this._gameState),tt.clearCommands(this._gameState),this.localCommand=void 0,this.localCommandDumped=!1)}}localCommandReceived(t,e){if(!this.localCommand){const i=new U(this._currentTick,t,e);this.localCommand=i,this.log.logInfo(`sending local command: ${H.toFullString(i)}`),this.net.broadcast(new j(i))}}remoteCommandReceived(t){this.log.logInfo(`received command: ${H.toFullString(t)}`),this.remoteCommands.push(t)}gameStateReceived(t){throw new Error("P2PNaiveNetCode: Method not implemented.")}getGameStateToRender(){return this._gameState}getGameState(t){return this._gameState.tick===t?this._gameState:void 0}}class nt extends et{constructor(){super(...arguments),e(this,"localCommand"),e(this,"localCommandDumped",!1),e(this,"remoteCommands",[]),e(this,"prevGameState")}start(t){return this.prevGameState=t,super.start(t)}tick(){if(this.tickBasedOnTime()>this._currentTick){!this.localCommandDumped&&this.localCommand&&(this.localCommandDumped=!0,this._gameState.commands.push(this.localCommand));let t=0;const e=this.remoteCommands.length;for(let i=0;i<e;i++){let e=this.remoteCommands[i-t];e&&e.tick===this._currentTick&&(this._gameState.commands.push(e),this.remoteCommands.splice(i-t++,1))}if(this._gameState.commands.length<this.net.connectionCount+1)this.log.logWarn(`Waiting commands for tick ${this._currentTick}: ${this._gameState.commands.length} of ${this.net.connectionCount+1}`);else{this._gameState.commands.sort(((t,e)=>t.playerId>e.playerId?1:-1));const t=this._gameState;this.log.logInfo(tt.toString(t)),this._gamestateLogEmitter.notify(tt.toLog(t)),this.prevGameState=this.gameStateMachine.clone(t),this.gameStateMachine.compute(this._gameState),this._currentTick++,tt.incTick(this._gameState),tt.clearCommands(this._gameState),this.localCommand=void 0,this.localCommandDumped=!1}}}localCommandReceived(t,e){if(!this.localCommand){const i=new U(this._currentTick,t,e);this.localCommand=i,this.log.logInfo(`sending local command: ${H.toFullString(i)}`),this.net.broadcast(new j(i))}}remoteCommandReceived(t){this.log.logInfo(`received command: ${H.toFullString(t)}`),this.remoteCommands.push(t)}gameStateReceived(t){throw new Error("P2PDelayedNetCode: Method not implemented.")}getGameStateToRender(){return this.prevGameState?this.prevGameState:this._gameState}getGameState(t){return this._gameState.tick===t?this._gameState:this.prevGameState&&this.prevGameState.tick===t?this.prevGameState:void 0}}class at extends et{constructor(){super(...arguments),e(this,"localCommand"),e(this,"latestCommandValueSent",u),e(this,"remoteCommands",[]),e(this,"gameStateHistory",[])}start(t){t.commands=[];return t.bodies.forEach((e=>{!e.isStatic()&&e.getUserData()&&t.commands.push(new U(0,e.getUserData().id,u,!0))})),this.gameStateHistory.push(t),super.start(t)}tick(){let t=this.gameStateHistory[this.gameStateHistory.length-1];if(this.tickBasedOnTime()>t.tick){if(this._currentTick=t.tick+1,this.log.logInfo(`Starting tick ${this._currentTick}`),this.localCommand&&this.localCommand.tick===t.tick){const e=t.commands.find((t=>{var e;return t.playerId===(null==(e=this.localCommand)?void 0:e.playerId)}));(!e||e.cloned&&e.value!==this.localCommand.value)&&(e?(e.cloned=!1,e.value=this.localCommand.value):t.commands.push(this.localCommand))}let e=!1,i=this.loadCommandsIntoGameStates();if(i&&i.tick<this._currentTick-1&&(this.rewriteHistory(i),e=!0),this.notifyGameStateLog(t,!1),!e){const e=this.computeNextGameState(t);this.gameStateHistory.push(e)}this.tickBasedOnTime()>this.gameStateHistory[this.gameStateHistory.length-1].tick&&this.tick()}}notifyGameStateLog(t,e){t.commands.sort(((t,e)=>t.playerId>e.playerId?1:-1)),this.log.logInfo(`${e?"RW":""} ${tt.toString(t)}`),this._gamestateLogEmitter.notify(tt.toLog(t))}loadCommandsIntoGameStates(){let t;const e=this.gameStateHistory.length,i=this.gameStateHistory[0].tick,s=this.remoteCommands.length;let o=0;for(let n=0;n<s;n++){let s=this.remoteCommands[n-o];if(this.log.logInfo(`evaluating command ${H.toString(s)}`),s.tick>=i&&s.tick<i+e){let e=this.gameStateHistory[s.tick-i];const a=e.commands.find((t=>t.playerId===s.playerId));let r=!1;a?(a.cloned=!1,a.value!==s.value&&(this.log.logInfo(`update command ${H.toString(a)} from value ${a.value} to value ${s.value} into gameState ${e.tick}`),a.value=s.value,r=!0)):(this.log.logInfo(`push command ${H.toString(s)} into gameState ${e.tick}`),e.commands.push(s),r=!0),r&&(!t||t>s.tick)&&(t=s.tick),this.remoteCommands.splice(n-o++,1)}}return t?this.gameStateHistory[t-i]:void 0}rewriteHistory(t){this.log.logInfo(`rewrite history from gameState ${t.tick}`);let e=this.gameStateHistory.findIndex((e=>e.tick===t.tick)),i=t.tick;for(;e>=0&&e<this.gameStateHistory.length-1;){let t=this.gameStateHistory[e];this.log.logInfo("rewriting gameState "+i++),this.notifyGameStateLog(t,!0);const s=this.gameStateHistory[e+1].commands;let o=this.computeNextGameState(t);this.gameStateHistory[e+1]=o,o.commands=s,t.commands.forEach((t=>{const e=o.commands.find((e=>e.playerId===t.playerId));(!e||e.cloned&&e.value!==t.value)&&(e?(e.cloned=!0,e.value=t.value):o.commands.push(H.clone(t,!0)))})),this.notifyGameStateLog(o,!0),e++}}computeNextGameState(t){let e=this.gameStateMachine.clone(t);return tt.incTick(e),this.gameStateMachine.compute(e),e}localCommandReceived(t,e){if((!this.localCommand||this.localCommand.tick!==this._currentTick)&&this.latestCommandValueSent!==e){this.latestCommandValueSent=e;const i=new U(this._currentTick,t,e,!1);this.localCommand=i,this.log.logInfo(`sending local command: ${H.toFullString(i)}`),this.net.broadcast(new j(i))}}remoteCommandReceived(t){this.log.logInfo(`received command: ${H.toFullString(t)}`),this.remoteCommands.push(t)}gameStateReceived(t){throw new Error("P2PDelayedNetCode: Method not implemented.")}getGameStateToRender(){return this.gameStateHistory.length>1?this.gameStateHistory[this.gameStateHistory.length-2]:this.gameStateHistory[this.gameStateHistory.length-1]}getGameState(t){return this.gameStateHistory.find((e=>e.tick===t))}}class rt{constructor(){}static build(t,e,i,s){switch(t){case"p2p-naive":return e.logInfo("Using p2p-naive netcode"),new ot(e,i,s);case"p2p-delayed":return e.logInfo("Using p2p-delayed netcode"),new nt(e,i,s);case"p2p-rollback":return e.logInfo("Using p2p-rollback netcode"),new at(e,i,s);case"cs-lockstep-client":return e.logInfo("Using cs-lockstep-client netcode"),new it(e,i,s);case"cs-lockstep-server":return e.logInfo("Using cs-lockstep-server netcode"),new st(e,i,s);default:return e.logInfo(`Netcode ${t} not found`),null}}static buildFromClass(t,e,i,s){return new t(e,i,s)}}class ct{constructor(t,e,i,s,o,n){this.log=t,this.step=e,this.canvasWidth=i,this.canvasHeight=s,this.npcs=o,this.randomizer=n}buildInitialGameState(){const t=this.createPlanckWorld(),e=tt.extractBodies(t),i=new Z(0,[],t,e,new Array(C.players.length).fill(0),void 0,-1);return this.attachWorldEvents(i),i}compute(t){var e,i;const o=t;if(o.playerWhoCollectedTheCoin){o.scores[o.playerWhoCollectedTheCoin-1]+=10;const e=this.randomizer.randomInt(t.randomPointer++,10,290),i=this.randomizer.randomInt(t.randomPointer++,10,240),n=o.bodies.find((t=>t.getUserData()&&t.getUserData().isCoin));n&&n.setPosition(s.Vec2(e/C.physics.worldScale,i/C.physics.worldScale)),o.playerWhoCollectedTheCoin=void 0}for(let n of o.commands){if(!n||n.value===u)continue;const t=o.bodies.find((t=>(t.getUserData()?t.getUserData().id:-1)==n.playerId));if(t){const e=n.value==w||n.value==L||n.value==x?C.physics.strength:n.value==v||n.value==E||n.value==k?-1*C.physics.strength:0,i=n.value==S||n.value==E||n.value==L?C.physics.strength:n.value==y||n.value==k||n.value==x?-1*C.physics.strength:0;this.log.logInfo(`apply command value ${n.value} to P${n.playerId}: force(x=${e} y=${i})`),t.applyForce(s.Vec2(e,i),t.getWorldCenter())}}null==(e=o.world)||e.step(this.step),null==(i=o.world)||i.clearForces()}attachWorldEvents(t){var e;null==(e=t.world)||e.on("begin-contact",(e=>{if(t.playerWhoCollectedTheCoin)return;if(e.getFixtureB().getBody().getUserData().isCoin){const i=e.getFixtureA().getBody().getUserData();i.id<=2&&(t.playerWhoCollectedTheCoin=i.id)}}))}createPlanckStaticBody(t,e,i,o,n,a){const r=t.createBody({type:"static"});r.setUserData({width:o,height:n,color:a}),r.createFixture(s.Box(o/2/C.physics.worldScale,n/2/C.physics.worldScale)),r.setPosition(s.Vec2((e+o/2)/C.physics.worldScale,(i+n/2)/C.physics.worldScale))}createPlanckWorld(){const t=s.Vec2(0,0),e=s.World(t);this.createPlanckStaticBody(e,0,0,this.canvasWidth,C.physics.borderThickness,C.border.color),this.createPlanckStaticBody(e,0,this.canvasHeight-C.physics.borderThickness,this.canvasWidth,C.physics.borderThickness,C.border.color),this.createPlanckStaticBody(e,0,0,C.physics.borderThickness,this.canvasHeight,C.border.color),this.createPlanckStaticBody(e,this.canvasWidth-C.physics.borderThickness,0,C.physics.borderThickness,this.canvasHeight,C.border.color);const i={density:0,restitution:.4};C.players.forEach((t=>{const o=e.createBody({type:"dynamic",position:s.Vec2((t.x+t.size/2)/C.physics.worldScale,(t.y+t.size/2)/C.physics.worldScale),allowSleep:!1,awake:!0});o.createFixture(s.Box(t.size/2/C.physics.worldScale,t.size/2/C.physics.worldScale),i),o.setUserData(t)}));const o=e.createBody({type:"static"});o.createFixture(s.Box(C.coin.size/2/C.physics.worldScale,C.coin.size/2/C.physics.worldScale),{isSensor:!0}),o.setPosition(s.Vec2(C.coin.x/C.physics.worldScale,C.coin.y/C.physics.worldScale)),o.setUserData({isCoin:!0,width:C.coin.size,height:C.coin.size,color:C.coin.color});const n={density:0,restitution:1};let a=20;for(let r=0;r<this.npcs;r++){const t=e.createBody({type:"dynamic",position:s.Vec2((35+r*a+10+8*(10-this.npcs))/C.physics.worldScale,(35+r*a+10+8*(10-this.npcs))/C.physics.worldScale),allowSleep:!1,awake:!0});t.createFixture(s.Box(10/C.physics.worldScale,10/C.physics.worldScale),n),t.setUserData({id:100+r,size:a,color:C.npc.color})}return e}clone(t){const e=this.cloneWorld(t.world,t.bodies),i=new Z(t.tick,H.cloneArray(t.commands),e,tt.extractBodies(e),[...t.scores],t.playerWhoCollectedTheCoin,t.randomPointer);return this.attachWorldEvents(i),i}cloneWorld(t,e){const i=o(n(t)),s=[];for(let o=i.getBodyList();o;o=o.getNext())s.unshift(o);for(let[o,n]of s.entries())null!==n&&n.setUserData(e[o].getUserData());return i}}class lt{constructor(){}buildInitialGameState(){return new J(0,[],[],[])}compute(t){}}class ht{constructor(){e(this,"encoder",new TextEncoder),e(this,"decoder",new TextDecoder)}encode(t){return this.encoder.encode(JSON.stringify(t))}decode(t){return JSON.parse(this.decoder.decode(t))}}class mt{encode(t){return a(t)}decode(t){return r(new Uint8Array(t))}}class dt{encode(t){return c(t)}decode(t){return l(new Uint8Array(t))}}class pt{constructor(){}static build(t,e){switch(t){case"json":return e.logInfo("Using json serializer"),new ht;case"cbor-x":return e.logInfo("Using cbor-x serializer"),new mt;case"msgpackr":return e.logInfo("Using msgpackr serializer"),new dt;default:return e.logInfo(`Serializer ${t} not found. Fallback to json serializer`),new ht}}}class gt{constructor(t,i){e(this,"running",!1),e(this,"_log"),e(this,"_gameStateHistory"),e(this,"_networkInterface"),e(this,"_networkListenersAttached",!1),e(this,"_deviceUpdatedEmitter",new P),e(this,"netcode"),e(this,"gameStateMachine"),this.isServer=t,this.playerId=i,this._log=new B,this._networkInterface=new M,this._gameStateHistory=[]}get log(){return this._log}get trafficLog(){return this._networkInterface.trafficLog}get deviceUpdatedEmitter(){return this._deviceUpdatedEmitter}get gameStateHistory(){return this._gameStateHistory}init(){this._networkListenersAttached||(this._networkListenersAttached=!0,this._networkInterface.connectionEmitter.addEventListener((t=>{0===t.peerId?this.log.logInfo("Connected to Server"):this.log.logInfo(`Connected to Player ${t.peerId}`)})),this._networkInterface.disconnectionEmitter.addEventListener((t=>{0===t.peerId?this.log.logInfo("Disconnected from Server"):this.log.logInfo(`Disconnected from Player ${t.peerId}`)})))}connect(t,e,i,s,o,n,a,r){const c=new N(this._networkInterface,this.playerId,this._log,pt.build(e,this.log));c.minLatency=i,c.maxLatency=s,c.packetLoss=o;const l=new N(t._networkInterface,t.playerId,t._log,pt.build(e,t.log));l.minLatency=n,l.maxLatency=a,l.packetLoss=r,this._networkInterface.connect(c,l),t._networkInterface.connect(l,c)}reset(){this._log.clear(),this._gameStateHistory=[]}play(t){let e;if(this.gameStateMachine=t.usePlanck?new ct(this._log,t.tickMs/1e3,t.width,t.height,t.npcs,new b(t.randomSeed)):new lt,null===t.netcodeClass){const i=t.algorithm.name+("cs"===t.algorithm.type?this.isServer?"-server":"-client":"");e=rt.build(i,this._log,this._networkInterface,this.gameStateMachine)}else e=rt.buildFromClass(t.netcodeClass,this.log,this._networkInterface,this.gameStateMachine);if(null===e)return;this.netcode=e,this.netcode.tickMs=t.tickMs,this.netcode.gamestateLogEmitter.addEventListener((t=>{const e=this._gameStateHistory.findIndex((e=>e.tick===t.tick));-1==e?this._gameStateHistory.unshift(t):this._gameStateHistory[e]=t}));const i=this.gameStateMachine.buildInitialGameState();this.netcode.start(i),this.running=!0,window.requestAnimationFrame((()=>{this.gameLoop()}))}stop(){this.running=!1,this.netcode&&this.netcode.gamestateLogEmitter.removeListeners(),this._networkInterface.trafficLog.flush(),this._networkInterface.trafficLog.removeListeners(),this._networkInterface.closeConnections(),this._networkInterface.removeListeners(),this._networkListenersAttached=!1}gameStateHistoryLog(){const t=this._gameStateHistory.reverse().join("\n");return this._gameStateHistory.reverse(),t}gameLoop(){if(this.running){window.requestAnimationFrame((()=>{this.gameLoop()}));try{this.update(),this.draw()}catch(t){this._log.logError(t)}}}update(){this.netcode.tick(),this._deviceUpdatedEmitter.notify()}draw(){}}class ft{constructor(t,i,s){e(this,"context"),e(this,"_debugBoxes",!0),this.log=t,this.canvas=i,this.netcode=s;const o=i.getContext("2d");if(!o)throw"Error getting context 2d";this.context=o}get debugBoxes(){return this._debugBoxes}set debugBoxes(t){this._debugBoxes=t}}class ut{constructor(t,e,i,s,o,n,a,r){this.currentTime=t,this.currentGameState=e,this.currentGameStateTime=i,this.elapsed=s,this.nextGameState=o,this.nextGameStateTime=n,this.nextElapsed=a,this.tickTimeDiff=r}}class yt extends ft{constructor(t,e,i){super(t,e,i),this.log=t,this.canvas=e,this.netcode=i}render(t){t?this.renderWithInterpolation():this.renderAsIs()}renderAsIs(){var t;this.context.clearRect(0,0,this.canvas.width,this.canvas.height);const e=this.netcode.getGameStateToRender();for(let i=null==(t=e.world)?void 0:t.getBodyList();i;i=i.getNext())i.getUserData()&&(i.isStatic()?this.drawStaticBody(i):this.drawDynamicBody(i));this.renderScores(e)}renderWithInterpolation(){var t;let e=T();const i=this.netcode.getGameStateToRender(),s=this.netcode.tickTime(i.tick),o=this.netcode.getGameState(i.tick+1),n=o?this.netcode.tickTime(o.tick):void 0;n&&(e-=n-s),e>s+this.netcode.tickMs&&(e=s+this.netcode.tickMs);const a=new ut(e,i,s,(e-s)/1e3,o,o?this.netcode.tickTime(o.tick):void 0,n?(e-n)/1e3:0,n?(n-s)/1e3:this.netcode.tickMs/1e3);this.context.clearRect(0,0,this.canvas.width,this.canvas.height);for(let r=null==(t=i.world)?void 0:t.getBodyList();r;r=r.getNext())r.getUserData()&&(r.isStatic()?this.drawStaticBody(r):this.drawDynamicBodyWithInterpolation(r,a));this.renderScores(i)}drawStaticBody(t){let e=t.getUserData().width,i=t.getUserData().height;this.context.fillStyle=t.getUserData().color,this.context.fillRect(t.getPosition().x*C.physics.worldScale-e/2,t.getPosition().y*C.physics.worldScale-i/2,e,i)}drawDynamicBody(t){let e=t.getUserData();this.context.fillStyle=e.color,this.context.fillRect(t.getPosition().x*C.physics.worldScale-e.size/2,t.getPosition().y*C.physics.worldScale-e.size/2,e.size,e.size)}drawDynamicBodyWithInterpolation(t,e){let i,s,o,n=t.getUserData(),a=0,r=0;if(e.nextGameState){if(i=tt.bodyFromPlayer(e.nextGameState,t.getUserData().id),i){const s=t.getPosition(),o=i.getPosition(),n=t.getLinearVelocity(),c=i.getLinearVelocity();a=Math.sign(n.x)===Math.sign(c.x)?s.x+e.elapsed*(o.x-s.x)/e.tickTimeDiff:e.elapsed<-e.nextElapsed?s.x+n.x*e.elapsed:o.x+c.x*e.nextElapsed,r=Math.sign(n.y)===Math.sign(c.y)?s.y+e.elapsed*(o.y-s.y)/e.tickTimeDiff:e.elapsed<-e.nextElapsed?s.y+n.y*e.elapsed:o.y+c.y*e.nextElapsed}}else a=t.getPosition().x+t.getLinearVelocity().x*e.elapsed,r=t.getPosition().y+t.getLinearVelocity().y*e.elapsed;this._debugBoxes&&(s=t.getPosition().x*C.physics.worldScale-n.size/2,o=t.getPosition().y*C.physics.worldScale-n.size/2,this.context.beginPath(),this.context.rect(s,o,n.size,n.size),this.context.strokeStyle="red",this.context.stroke(),i&&(s=i.getPosition().x*C.physics.worldScale-n.size/2,o=i.getPosition().y*C.physics.worldScale-n.size/2,this.context.beginPath(),this.context.rect(s,o,n.size,n.size),this.context.strokeStyle="blue",this.context.stroke())),s=a*C.physics.worldScale-n.size/2,o=r*C.physics.worldScale-n.size/2,this.context.fillStyle=n.color,this.context.fillRect(s,o,n.size,n.size)}renderScores(t){this.context.font="16px monospace";C.players.forEach(((e,i)=>{this.context.fillStyle=C.players[i].color,this.context.fillText(`P${e.id}: ${t.scores[i]}`,10+140*i,20)}))}}class St{constructor(t,e,i,s,o,n,a,r){this.currentTime=t,this.currentGameState=e,this.currentGameStateTime=i,this.elapsed=s,this.nextGameState=o,this.nextGameStateTime=n,this.nextElapsed=a,this.tickTimeDiff=r}}class vt extends ft{constructor(t,e,i){super(t,e,i),this.log=t,this.canvas=e,this.netcode=i}render(t){t?this.renderWithInterpolation():this.renderAsIs()}renderAsIs(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height);const t=this.netcode.getGameStateToRender();t.bodies.forEach((t=>{t.isStatic?this.drawStaticBody(t):this.drawDynamicBody(t)})),this.renderScores(t)}renderWithInterpolation(){let t=T();const e=this.netcode.getGameStateToRender();if(!e)return;const i=this.netcode.tickTime(e.tick),s=this.netcode.getGameState(e.tick+1),o=s?this.netcode.tickTime(s.tick):void 0;o&&(t-=o-i),t>i+this.netcode.tickMs&&(t=i+this.netcode.tickMs);const n=new St(t,e,i,(t-i)/1e3,s,s?this.netcode.tickTime(s.tick):void 0,o?(t-o)/1e3:0,o?(o-i)/1e3:this.netcode.tickMs/1e3);this.context.clearRect(0,0,this.canvas.width,this.canvas.height),e.bodies.forEach((t=>{t.isStatic?this.drawStaticBody(t):this.drawDynamicBodyWithInterpolation(t,n)})),this.renderScores(e)}drawStaticBody(t){this.context.fillStyle=t.color,this.context.fillRect(t.posX*C.physics.worldScale-t.width/2,t.posY*C.physics.worldScale-t.height/2,t.width,t.height)}drawDynamicBody(t){this.context.fillStyle=t.color,this.context.fillRect(t.posX*C.physics.worldScale-t.width/2,t.posY*C.physics.worldScale-t.height/2,t.width,t.height)}drawDynamicBodyWithInterpolation(t,e){let i,s,o,n=0,a=0;e.nextGameState?(i=Q.bodyFromPlayer(e.nextGameState,t.id),i&&(n=Math.sign(t.velX)===Math.sign(i.velX)?t.posX+e.elapsed*(i.posX-t.posX)/e.tickTimeDiff:e.elapsed<-e.nextElapsed?t.posX+t.velX*e.elapsed:i.posX+i.velX*e.nextElapsed,a=Math.sign(t.velY)===Math.sign(i.velY)?t.posY+e.elapsed*(i.posY-t.posY)/e.tickTimeDiff:e.elapsed<-e.nextElapsed?t.posY+t.velY*e.elapsed:i.posY+i.velY*e.nextElapsed)):(n=t.posX+t.velX*e.elapsed,a=t.posY+t.velY*e.elapsed),this._debugBoxes&&(s=t.posX*C.physics.worldScale-t.width/2,o=t.posY*C.physics.worldScale-t.height/2,this.context.beginPath(),this.context.rect(s,o,t.width,t.height),this.context.strokeStyle="red",this.context.stroke(),i&&(s=i.posX*C.physics.worldScale-i.width/2,o=i.posY*C.physics.worldScale-i.height/2,this.context.beginPath(),this.context.rect(s,o,i.width,i.height),this.context.strokeStyle="blue",this.context.stroke())),s=n*C.physics.worldScale-t.width/2,o=a*C.physics.worldScale-t.height/2,this.context.fillStyle=t.color,this.context.fillRect(s,o,t.width,t.height)}renderScores(t){this.context.font="16px monospace";C.players.forEach(((e,i)=>{this.context.fillStyle=C.players[i].color,this.context.fillText(`P${e.id}: ${t.scores[i]}`,10+140*i,20)}))}}class wt extends class{constructor(t,e,i,s,o,n,a,r){this.algorithm=t,this.netcodeClass=e,this.tickMs=i,this.npcs=s,this.width=o,this.height=n,this.usePlanck=a,this.randomSeed=r}}{constructor(t,e,i,s,o,n,a,r,c,l){super(t,e,i,s,o,n,a,r),this.algorithm=t,this.netcodeClass=e,this.tickMs=i,this.npcs=s,this.width=o,this.height=n,this.usePlanck=a,this.randomSeed=r,this.interpolation=c,this.debugBoxes=l}}class kt extends gt{constructor(t,i,s){super(t,i),e(this,"renderer"),e(this,"_interpolation",!0),this.isServer=t,this.playerId=i,this.canvas=s}get debugBoxes(){return this.renderer.debugBoxes}set debugBoxes(t){this.renderer.debugBoxes=t}get interpolation(){return this._interpolation}set interpolation(t){this._interpolation=t}play(t){super.play(t),this._interpolation=t.interpolation,this.renderer=t.usePlanck?new yt(this.log,this.canvas,this.netcode):new vt(this.log,this.canvas,this.netcode),this.renderer.debugBoxes=t.debugBoxes}draw(){this.renderer.render(this._interpolation)}}const xt=new class{constructor(){e(this,"pressedKeys",[]),document.onkeydown=document.onkeyup=t=>{this.pressedKeys[t.keyCode]="keydown"===t.type}}isPressed(t){return this.pressedKeys[t]}};class Et extends kt{constructor(t,e,i,s,o,n){super(!1,t,n),this.playerId=t,this.keyUp=e,this.keyDown=i,this.keyLeft=s,this.keyRight=o,this.canvas=n}update(){const t=(xt.isPressed(this.keyUp)?y:xt.isPressed(this.keyDown)?S:u)+(xt.isPressed(this.keyLeft)?v:xt.isPressed(this.keyRight)?w:u);this.netcode.localCommandReceived(this.playerId,t),super.update()}}class Lt extends kt{constructor(t,e){super(!0,t,e),this.playerId=t,this.canvas=e}}class _t extends gt{constructor(t){super(!1,t),e(this,"lastCommandTime",0),e(this,"commandValue",u),this.playerId=t}update(){if(0===this.lastCommandTime||T()>this.lastCommandTime+1e3){const t=I(0,1)?y:I(0,1)?S:u,e=I(0,1)?v:I(0,1)?w:u;this.commandValue=t+e}this.netcode.localCommandReceived(this.playerId,this.commandValue),super.update()}}(new class{constructor(){e(this,"deviceServer"),e(this,"devicePlayer1"),e(this,"devicePlayer2"),e(this,"p2pmode",!0),e(this,"panelControl"),e(this,"panelCanvas1"),e(this,"panelGamestates1"),e(this,"panelLog1"),e(this,"panelCanvas2"),e(this,"panelGamestates2"),e(this,"panelLog2"),e(this,"panelCanvasS"),e(this,"panelGamestatesS"),e(this,"panelLogS"),e(this,"panelTrafficChart"),e(this,"uplotChartPanel"),this.deviceServer=new Lt(0,document.getElementById("serverGameArea")),this.devicePlayer1=new Et(C.players[0].id,C.players[0].keyUp,C.players[0].keyDown,C.players[0].keyLeft,C.players[0].keyRight,document.getElementById("player1GameArea")),this.devicePlayer2=new Et(C.players[1].id,C.players[1].keyUp,C.players[1].keyDown,C.players[1].keyLeft,C.players[1].keyRight,document.getElementById("player2GameArea"))}build(){this.createWindows(),this.bootstrapAngular()}createWindows(){this.panelControl=h.create({id:"panelControl",headerTitle:"Control Panel",theme:"dimgrey",headerControls:{close:"remove",size:"xs"},panelSize:{width:"18em",height:"100%"},position:{my:"left-top",at:"left-top",offsetX:"0",offsetY:"0"},content:document.getElementById("controlPanel")}),this.panelGamestates1=h.create({id:"panelGamestates1",headerTitle:"Player 1 Game States",theme:"DarkSlateBlue",contentOverflow:"auto",headerControls:{close:"remove",size:"xs"},resizeit:{handles:"n,s"},panelSize:{width:"22em",height:"50%"},position:{my:"left-top",at:"left-top",offsetX:"calc(100vw - 22em)",offsetY:"0"},content:document.getElementById("player1GameStates")}),this.panelCanvas1=h.create({id:"panelCanvas1",headerTitle:"Player 1 Canvas",theme:"DarkSlateBlue",contentOverflow:"hide",headerControls:{close:"remove",size:"xs"},panelSize:{width:"310px",height:"calc(250px + 4.5em)"},position:{my:"left-top",at:"left-top",offsetX:"calc(18em + (100vw - 40em - 620px) / 3)",offsetY:"0"},content:document.getElementById("player1Canvas")}),this.panelLog1=h.create({id:"panelLog1",headerTitle:"Player 1 Logs",theme:"DarkSlateBlue",contentOverflow:"auto",headerControls:{close:"remove",size:"xs"},panelSize:{width:"calc(100vw - 40em)",height:"calc((100vh - 250px - 4.5em) / 2)"},position:{my:"left-top",at:"left-top",offsetX:"18em",offsetY:"calc(250px + 4.5em)"},content:document.getElementById("player1Logs")}),this.panelGamestates2=h.create({id:"panelGamestates2",headerTitle:"Player 2 Game States",theme:"OliveDrab",contentOverflow:"auto",headerControls:{close:"remove",size:"xs"},panelSize:{width:"350px",height:"50%"},position:{my:"left-top",at:"left-top",offsetX:"calc(100vw - 22em)",offsetY:"50%"},content:document.getElementById("player2GameStates")}),this.panelCanvas2=h.create({id:"panelCanvas2",headerTitle:"Player 2 Canvas",theme:"OliveDrab",contentOverflow:"hide",headerControls:{close:"remove",size:"xs"},panelSize:{width:"310px",height:"calc(250px + 4.5em)"},position:{my:"left-top",at:"left-top",offsetX:"calc(100vw - 22em - 310px - (100vw - 40em - 620px) / 3)",offsetY:"0"},content:document.getElementById("player2Canvas")}),this.panelLog2=h.create({id:"panelLog2",headerTitle:"Player 2 Logs",theme:"OliveDrab",contentOverflow:"auto",headerControls:{close:"remove",size:"xs"},panelSize:{width:"calc(100vw - 40em)",height:"calc((100vh - 250px - 4.5em) / 2)"},position:{my:"left-top",at:"left-top",offsetX:"18em",offsetY:"calc(250px + 4.5em + (100vh - 250px - 4.5em) / 2)"},content:document.getElementById("player2Logs")}),this.panelGamestatesS=h.create({id:"panelGamestatesS",headerTitle:"Server Game States",theme:"black",contentOverflow:"auto",headerControls:{close:"remove",size:"xs"},panelSize:{width:"350px",height:"50%"},position:{my:"left-top",at:"left-top",offsetX:"calc(100vw - 350px)",offsetY:"50%"},content:document.getElementById("serverGameStates")}),this.panelCanvasS=h.create({id:"panelCanvasS",headerTitle:'Server "Canvas"',theme:"black",contentOverflow:"hide",headerControls:{close:"remove",size:"xs"},panelSize:{width:"310px",height:"calc(250px + 4.5em)"},position:{my:"left-top",at:"left-top",offsetX:"calc(50vw + 350px)",offsetY:"0"},content:document.getElementById("serverCanvas")}),this.panelLogS=h.create({id:"panelLogS",headerTitle:"Server Logs",theme:"black",contentOverflow:"auto",headerControls:{close:"remove",size:"xs"},panelSize:{width:"calc(100vw - 40em)",height:"calc((100vh - 250px - 4.5em) / 2)"},position:{my:"left-top",at:"left-top",offsetX:"350px",offsetY:"75%"},content:document.getElementById("serverLogs")}),this.panelTrafficChart=h.create({id:"panelTrafficChart",headerTitle:"Network Traffic",theme:"dimgrey",contentOverflow:"auto",headerControls:{close:"remove",size:"xs"},panelSize:{width:"calc(100vw - 25em)",height:"calc(100vh - 250px - 4.5em)"},position:{my:"left-top",at:"left-top",offsetX:"1000vw",offsetY:"1000vh"},content:document.getElementById("trafficChart")}),this.uplotChartPanel=document.querySelector("#panelTrafficChart > div.jsPanel-content")}resetLayout(){this.panelControl.reposition({my:"left-top",at:"left-top",offsetX:"0",offsetY:"0"}),this.panelControl.resize({width:"18em",height:"100%"}),this.p2pmode?(this.panelGamestates1.reposition({my:"left-top",at:"left-top",offsetX:"calc(100vw - 22em)",offsetY:"0"}),this.panelGamestates1.resize({width:"22em",height:"50%"}),this.panelCanvas1.reposition({my:"left-top",at:"left-top",offsetX:"calc(18em + (100vw - 40em - 620px) / 3)",offsetY:"0"}),this.panelCanvas1.resize({width:"310px",height:"calc(250px + 4.5em)"}),this.panelLog1.reposition({my:"left-top",at:"left-top",offsetX:"18em",offsetY:"calc(250px + 4.5em)"}),this.panelLog1.resize({width:"calc(100vw - 40em)",height:"calc((100vh - 250px - 4.5em) / 2)"}),this.panelGamestates2.reposition({my:"left-top",at:"left-top",offsetX:"calc(100vw - 22em)",offsetY:"50%"}),this.panelGamestates2.resize({width:"22em",height:"50%"}),this.panelCanvas2.reposition({my:"left-top",at:"left-top",offsetX:"calc(100vw - 22em - 310px - (100vw - 40em - 620px) / 3)",offsetY:"0"}),this.panelCanvas2.resize({width:"310px",height:"calc(250px + 4.5em)"}),this.panelLog2.reposition({my:"left-top",at:"left-top",offsetX:"18em",offsetY:"calc(250px + 4.5em + (100vh - 250px - 4.5em) / 2)"}),this.panelLog2.resize({width:"calc(100vw - 40em)",height:"calc((100vh - 250px - 4.5em) / 2)"}),this.panelGamestatesS.reposition({my:"left-top",at:"left-top",offsetX:"1000vw",offsetY:"1000vh"}),this.panelCanvasS.reposition({my:"left-top",at:"left-top",offsetX:"1000vw",offsetY:"1000vh"}),this.panelLogS.reposition({my:"left-top",at:"left-top",offsetX:"1000vw",offsetY:"1000vh"})):(this.panelGamestates1.reposition({my:"left-top",at:"left-top",offsetX:"calc(100vw - 22em)",offsetY:"0"}),this.panelGamestates1.resize({width:"22em",height:"33%"}),this.panelCanvas1.reposition({my:"left-top",at:"left-top",offsetX:"18em",offsetY:"0"}),this.panelCanvas1.resize({width:"310px",height:"calc(250px + 4.5em)"}),this.panelLog1.reposition({my:"left-top",at:"left-top",offsetX:"18em",offsetY:"calc(250px + 4.5em)"}),this.panelLog1.resize({width:"calc(100vw - 40em - 4em)",height:"calc(100vh - 250px - 4.5em - 4em)"}),this.panelGamestates2.reposition({my:"left-top",at:"left-top",offsetX:"calc(100vw - 22em)",offsetY:"33%"}),this.panelGamestates2.resize({width:"22em",height:"33%"}),this.panelCanvas2.reposition({my:"left-top",at:"left-top",offsetX:"calc(18em + 310px)",offsetY:"0"}),this.panelCanvas2.resize({width:"310px",height:"calc(250px + 4.5em)"}),this.panelLog2.reposition({my:"left-top",at:"left-top",offsetX:"20em",offsetY:"calc(250px + 4.5em + 2em)"}),this.panelLog2.resize({width:"calc(100vw - 40em - 4em)",height:"calc(100vh - 250px - 4.5em - 4em)"}),this.panelGamestatesS.reposition({my:"left-top",at:"left-top",offsetX:"calc(100vw - 22em)",offsetY:"66%"}),this.panelGamestatesS.resize({width:"22em",height:"33%"}),this.panelCanvasS.reposition({my:"left-top",at:"left-top",offsetX:"calc(18em + 620px)",offsetY:"0"}),this.panelCanvasS.resize({width:"310px",height:"calc(250px + 4.5em)"}),this.panelLogS.reposition({my:"left-top",at:"left-top",offsetX:"22em",offsetY:"calc(250px + 4.5em + 4em)"}),this.panelLogS.resize({width:"calc(100vw - 40em - 4em)",height:"calc(100vh - 250px - 4.5em - 4em)"})),this.panelGamestates1.front(),this.panelGamestates2.front(),this.panelGamestatesS.front(),this.panelLog1.front(),this.panelLog2.front(),this.panelLogS.front(),this.panelCanvas1.front(),this.panelCanvas2.front(),this.panelCanvasS.front()}saveFile(t,e){const i=new Date,s=m.exports.createWriteStream(`${i.getFullYear()}${i.getMonth()}${i.getDate()}${i.getHours()}${i.getMinutes()}${i.getSeconds()}-${t}.log`).getWriter(),o=(new TextEncoder).encode(e);s.write(o),s.close()}showError(t,e){h.create({dragit:!1,resizeit:!1,headerControls:"closeonly  xs",position:"center-top 0 15 down",contentSize:"330 auto",content:`<p>${e}</p>`,theme:"warning filled",headerTitle:`${t}`})}bootstrapAngular(){d.module("app",[]).controller("mainCtrl",["$scope","$timeout",(t,e)=>{t.info={showSpinner:!1,btnStopEnabled:!1,btnPlayEnabled:!0,btnSaveEnabled:!0,playing:!1,tick:C.network.tickMs,netcodes:C.netcodes,algorithm:C.netcodes[0],serializers:C.serializers,serializer:C.serializers[0],latency1:{min:C.network.minLatency1,max:C.network.maxLatency1},packetLoss1:C.network.packetLoss1,latency2:{min:C.network.minLatency2,max:C.network.maxLatency2},packetLoss2:C.network.packetLoss2,npcs:0,realtimeGameStates:!0,realtimeLogs:!1,interpolation:!0,debugBoxes:!0,syncScrollGs1:!0,syncScrollGs2:!0,syncScrollGsS:!0,syncScrollLog1:!0,syncScrollLog2:!0,syncScrollLogS:!0,logsPlayer1:[],logsPlayer2:[],logsServer:[],gamestatesPlayer1:[],gamestatesPlayer2:[],gamestatesServer:[],deviceNPCs:[],uplot:void 0,uplotP2POpts:{width:this.uplotChartPanel.clientWidth-20,height:this.uplotChartPanel.clientHeight-50,pxAlign:0,scales:{x:{time:!1}},series:[{label:"(sec)"},{label:"P1 In",stroke:"#483D8B"},{label:"P1 Out",stroke:"blue"},{label:"P2 In",stroke:"#6B8E23"},{label:"P2 Out",stroke:"green"}]},uplotCSOpts:{width:this.uplotChartPanel.clientWidth-20,height:this.uplotChartPanel.clientHeight-50,pxAlign:0,scales:{x:{time:!1}},series:[{label:"(sec)"},{label:"P1 In",stroke:"#483D8B"},{label:"P1 Out",stroke:"blue"},{label:"P2 In",stroke:"#6B8E23"},{label:"P2 Out",stroke:"green"},{label:"SRV In",stroke:"black"},{label:"SRV Out",stroke:"gray"}]},uplotData:[]};const i="p2p"===t.info.algorithm.type;this.p2pmode=i,this.resetLayout(),t.resetLayout=()=>{this.resetLayout()};const s=document.getElementById("player1GameStates"),o=document.getElementById("player2GameStates"),n=document.getElementById("serverGameStates");d.element(s.parentElement).bind("scroll",(()=>{t.info.syncScrollGs1&&(t.info.syncScrollGs2&&(o.parentElement.scrollTop=s.parentElement.scrollTop),t.info.syncScrollGsS&&(n.parentElement.scrollTop=s.parentElement.scrollTop))})),d.element(o.parentElement).bind("scroll",(()=>{t.info.syncScrollGs2&&(t.info.syncScrollGs1&&(s.parentElement.scrollTop=o.parentElement.scrollTop),t.info.syncScrollGsS&&(n.parentElement.scrollTop=o.parentElement.scrollTop))})),d.element(n.parentElement).bind("scroll",(()=>{t.info.syncScrollGsS&&(t.info.syncScrollGs1&&(s.parentElement.scrollTop=n.parentElement.scrollTop),t.info.syncScrollGs2&&(o.parentElement.scrollTop=n.parentElement.scrollTop))}));const a=document.getElementById("player1Logs"),r=document.getElementById("player2Logs"),c=document.getElementById("serverLogs");d.element(a.parentElement).bind("scroll",(()=>{t.info.syncScrollLog1&&(t.info.syncScrollLog2&&(r.parentElement.scrollTop=a.parentElement.scrollTop),t.info.syncScrollLogS&&(c.parentElement.scrollTop=a.parentElement.scrollTop))})),d.element(r.parentElement).bind("scroll",(()=>{t.info.syncScrollLog2&&(t.info.syncScrollLog1&&(a.parentElement.scrollTop=r.parentElement.scrollTop),t.info.syncScrollLogS&&(c.parentElement.scrollTop=r.parentElement.scrollTop))})),d.element(c.parentElement).bind("scroll",(()=>{t.info.syncScrollLogS&&(t.info.syncScrollLog1&&(a.parentElement.scrollTop=c.parentElement.scrollTop),t.info.syncScrollLog2&&(r.parentElement.scrollTop=c.parentElement.scrollTop))})),this.deviceServer.deviceUpdatedEmitter.addEventListener((()=>{(t.info.realtimeGameStates||t.info.realtimeLogs)&&t.$apply()})),this.devicePlayer1.deviceUpdatedEmitter.addEventListener((()=>{(t.info.realtimeGameStates||t.info.realtimeLogs)&&t.$apply()})),this.devicePlayer2.deviceUpdatedEmitter.addEventListener((()=>{(t.info.realtimeGameStates||t.info.realtimeLogs)&&t.$apply()}));const l='<button class="jsPanel-btn jsPanel-btn-menu jsPanel-btn-md tooltip bottom" aria-label="Sync scroll"><span class="fas fa-arrows-alt-v toolbar-icon" style="vertical-align: text-top"></span><input type="checkbox" checked /></button>',h='<button class="jsPanel-btn jsPanel-btn-menu jsPanel-btn-md tooltip bottom" aria-label="Download"><span class="fas fa-download toolbar-icon"></span></button>';this.panelGamestates1.addControl({html:l,name:"sync",position:1,handler:()=>{t.info.syncScrollGs1=!t.info.syncScrollGs1}}),this.panelGamestates1.addControl({html:h,name:"download",position:2,handler:()=>{t.saveGamestates1()}}),this.panelGamestates2.addControl({html:l,name:"sync",position:1,handler:()=>{t.info.syncScrollGs2=!t.info.syncScrollGs2}}),this.panelGamestates2.addControl({html:h,name:"download",position:2,handler:()=>{t.saveGamestates2()}}),this.panelGamestatesS.addControl({html:l,name:"sync",position:1,handler:()=>{t.info.syncScrollGsS=!t.info.syncScrollGsS}}),this.panelGamestatesS.addControl({html:h,name:"download",position:2,handler:()=>{t.saveGamestatesS()}}),this.panelLog1.addControl({html:l,name:"sync",position:1,handler:()=>{t.info.syncScrollLog1=!t.info.syncScrollLog1}}),this.panelLog1.addControl({html:h,name:"download",position:2,handler:()=>{t.saveLogs1()}}),this.panelLog2.addControl({html:l,name:"sync",position:1,handler:()=>{t.info.syncScrollLog2=!t.info.syncScrollLog2}}),this.panelLog2.addControl({html:h,name:"download",position:2,handler:()=>{t.saveLogs2()}}),this.panelLogS.addControl({html:l,name:"sync",position:1,handler:()=>{t.info.syncScrollLogS=!t.info.syncScrollLogS}}),this.panelLogS.addControl({html:h,name:"download",position:2,handler:()=>{t.saveLogsS()}}),t.changeAlgorithm=()=>{if("custom"===t.info.algorithm.type)return;const e="p2p"===t.info.algorithm.type;e!==this.p2pmode&&(this.p2pmode=e,this.resetLayout())},["jspanelresizestop","jspanelmaximized","jspanelnormalized"].forEach((e=>{document.addEventListener(e,(e=>{"panelTrafficChart"===e.panel.id&&t.info.uplot.setSize({width:this.uplotChartPanel.clientWidth,height:this.uplotChartPanel.clientHeight-50})}),!1)})),t.showTrafficChart=()=>{t.info.uplot=new p(this.p2pmode?t.info.uplotP2POpts:t.info.uplotCSOpts,t.info.uplotData,this.uplotChartPanel),this.panelTrafficChart.reposition({my:"left-top",at:"left-top",offsetX:"23em",offsetY:"calc(250px + 4.5em)"}),this.panelTrafficChart.resize({width:"calc(100vw - 25em)",height:"calc(100vh - 250px - 4.5em)"}),this.panelTrafficChart.front()},t.stop=()=>{t.info.showSpinner=!0,e((()=>{this.deviceServer.stop(),this.devicePlayer1.stop(),this.devicePlayer2.stop(),t.findMismatches(),t.info.deviceNPCs.forEach((t=>{t.stop()})),t.info.btnStopEnabled=!1,t.info.btnPlayEnabled=!0,t.info.playing=!1,t.showTrafficChart(),e((()=>{t.info.showSpinner=!1}))}))},t.play=async()=>{if("custom"===t.info.algorithm.type){if(!t.info.algorithmUrl)return void this.showError("Loading algorithm","Empty Algorithm URL");const o=await fetch(t.info.algorithmUrl),n=await o.text();try{window.currentTimestamp=T,window.BaseNetCode=et,window.Command=U,window.CommandMessage=j,window.GameStateMessage=K,window.CommandUtils=H,window.SimpleGameStateUtils=Q,window.PlanckGameStateUtils=tt;const{type:s,name:o,ClientNetCode:a,ServerNetCode:r}=await(e=()=>import(`data:text/javascript;charset=utf-8,${encodeURIComponent(n)}`),i=[],i&&0!==i.length?Promise.all(i.map((t=>{if((t=`/netcode-workbench/${t}`)in g)return;g[t]=!0;const e=t.endsWith(".css"),i=e?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${t}"]${i}`))return;const s=document.createElement("link");return s.rel=e?"stylesheet":"modulepreload",e||(s.as="script",s.crossOrigin=""),s.href=t,document.head.appendChild(s),e?new Promise(((t,e)=>{s.addEventListener("load",t),s.addEventListener("error",e)})):void 0}))).then((()=>e())):e()),c=new _(o,s);this.p2pmode="p2p"===s,this.resetLayout(),this.p2pmode?t.internalPlay(c,a,null):t.internalPlay(c,a,r)}catch(s){this.showError("Loading algorithm",s)}}else t.internalPlay(t.info.algorithm,null,null);var e,i},t.internalPlay=(e,i,s)=>{this.deviceServer.reset(),this.devicePlayer1.reset(),this.devicePlayer2.reset(),t.info.deviceNPCs.forEach((t=>{t.reset()})),t.info.uplot&&(t.info.uplot.destroy(),t.info.uplot=void 0),this.panelTrafficChart.reposition({my:"left-top",at:"left-top",offsetX:"1000vw",offsetY:"1000vh"}),t.info.uplotData=this.p2pmode?[[],[],[],[],[]]:[[],[],[],[],[],[],[]];let o=0;this.devicePlayer1.trafficLog.incomingEmitter.addEventListener((e=>{this.devicePlayer1.log.logInfo(`incoming ${e.timestamp} ${e.size} bytes`),0===o&&(o=e.timestamp);const i=e.timestamp-o,s=t.info.uplotData[0].indexOf(i);-1===s?(t.info.uplotData[0].push(i),t.info.uplotData[1].push(e.size),t.info.uplotData[2].push(0),t.info.uplotData[3].push(0),t.info.uplotData[4].push(0),this.p2pmode||(t.info.uplotData[5].push(0),t.info.uplotData[6].push(0))):t.info.uplotData[1][s]=e.size})),this.devicePlayer1.trafficLog.outgoingEmitter.addEventListener((e=>{this.devicePlayer1.log.logInfo(`outgoing ${e.timestamp} ${e.size} bytes`),0===o&&(o=e.timestamp);const i=e.timestamp-o,s=t.info.uplotData[0].indexOf(i);-1===s?(t.info.uplotData[0].push(i),t.info.uplotData[1].push(0),t.info.uplotData[2].push(e.size),t.info.uplotData[3].push(0),t.info.uplotData[4].push(0),this.p2pmode||(t.info.uplotData[5].push(0),t.info.uplotData[6].push(0))):t.info.uplotData[2][s]=e.size})),this.devicePlayer2.trafficLog.incomingEmitter.addEventListener((e=>{this.devicePlayer2.log.logInfo(`incoming ${e.timestamp} ${e.size} bytes`),0===o&&(o=e.timestamp);const i=e.timestamp-o,s=t.info.uplotData[0].indexOf(i);-1===s?(t.info.uplotData[0].push(i),t.info.uplotData[1].push(0),t.info.uplotData[2].push(0),t.info.uplotData[3].push(e.size),t.info.uplotData[4].push(0),this.p2pmode||(t.info.uplotData[5].push(0),t.info.uplotData[6].push(0))):t.info.uplotData[3][s]=e.size})),this.devicePlayer2.trafficLog.outgoingEmitter.addEventListener((e=>{this.devicePlayer2.log.logInfo(`outgoing ${e.timestamp} ${e.size} bytes`),0===o&&(o=e.timestamp);const i=e.timestamp-o,s=t.info.uplotData[0].indexOf(i);-1===s?(t.info.uplotData[0].push(i),t.info.uplotData[1].push(0),t.info.uplotData[2].push(0),t.info.uplotData[3].push(0),t.info.uplotData[4].push(e.size),this.p2pmode||(t.info.uplotData[5].push(0),t.info.uplotData[6].push(0))):t.info.uplotData[4][s]=e.size})),this.deviceServer.trafficLog.incomingEmitter.addEventListener((e=>{this.deviceServer.log.logInfo(`incoming ${e.timestamp} ${e.size} bytes`),0===o&&(o=e.timestamp);const i=e.timestamp-o,s=t.info.uplotData[0].indexOf(i);-1===s?(t.info.uplotData[0].push(i),t.info.uplotData[1].push(0),t.info.uplotData[2].push(0),t.info.uplotData[3].push(0),t.info.uplotData[4].push(0),this.p2pmode||(t.info.uplotData[5].push(e.size),t.info.uplotData[6].push(0))):t.info.uplotData[5][s]=e.size})),this.deviceServer.trafficLog.outgoingEmitter.addEventListener((e=>{this.deviceServer.log.logInfo(`outgoing ${e.timestamp} ${e.size} bytes`),0===o&&(o=e.timestamp);const i=e.timestamp-o,s=t.info.uplotData[0].indexOf(i);-1===s?(t.info.uplotData[0].push(i),t.info.uplotData[1].push(0),t.info.uplotData[2].push(0),t.info.uplotData[3].push(0),t.info.uplotData[4].push(0),this.p2pmode||(t.info.uplotData[5].push(0),t.info.uplotData[6].push(e.size))):t.info.uplotData[6][s]=e.size}));const n=[I(0,16378),I(0,16378),I(0,16378),I(0,16378)];t.info.deviceNPCs=[];for(let a=0;a<t.info.npcs;a++)t.info.deviceNPCs.push(new _t(a+100));if(this.p2pmode){this.devicePlayer1.init(),this.devicePlayer2.init(),t.info.deviceNPCs.forEach((t=>{t.init()})),this.devicePlayer1.connect(this.devicePlayer2,t.info.serializer.name,t.info.latency1.min,t.info.latency1.max,t.info.packetLoss1,t.info.latency2.min,t.info.latency2.max,t.info.packetLoss2);for(let e=0;e<t.info.deviceNPCs.length;e++){const i=t.info.deviceNPCs[e];this.devicePlayer1.connect(i,t.info.serializer.name,t.info.latency1.min,t.info.latency1.max,t.info.packetLoss1,t.info.latency1.min,t.info.latency1.max,t.info.packetLoss1),this.devicePlayer2.connect(i,t.info.serializer.name,t.info.latency2.min,t.info.latency2.max,t.info.packetLoss2,t.info.latency2.min,t.info.latency2.max,t.info.packetLoss2);for(let s=e+1;s<t.info.deviceNPCs.length;s++){let e=t.info.deviceNPCs[s];i.connect(e,t.info.serializer.name,t.info.latency1.min,t.info.latency1.max,t.info.packetLoss1,t.info.latency2.min,t.info.latency2.max,t.info.packetLoss2)}}const s=new wt(e,i,t.info.tick,t.info.npcs,C.canvas.width,C.canvas.height,!0,n,t.info.interpolation,t.info.debugBoxes);this.devicePlayer1.play(s),this.devicePlayer2.play(s),t.info.deviceNPCs.forEach((t=>{t.play(s)}))}else{this.devicePlayer1.init(),this.devicePlayer2.init(),this.deviceServer.init(),t.info.deviceNPCs.forEach((t=>{t.init()})),this.devicePlayer1.connect(this.deviceServer,t.info.serializer.name,t.info.latency1.min,t.info.latency1.max,t.info.packetLoss1,t.info.latency1.min,t.info.latency1.max,t.info.packetLoss1),this.devicePlayer2.connect(this.deviceServer,t.info.serializer.name,t.info.latency2.min,t.info.latency2.max,t.info.packetLoss2,t.info.latency2.min,t.info.latency2.max,t.info.packetLoss2),t.info.deviceNPCs.forEach((e=>{e.connect(this.deviceServer,t.info.serializer.name,t.info.latency1.min,t.info.latency1.max,t.info.packetLoss1,t.info.latency2.min,t.info.latency2.max,t.info.packetLoss2)}));const o=new wt(e,s,t.info.tick,t.info.npcs,C.canvas.width,C.canvas.height,!0,n,!1,!1),a=new wt(e,i,t.info.tick,t.info.npcs,C.canvas.width,C.canvas.height,!1,n,t.info.interpolation,t.info.debugBoxes);this.deviceServer.play(o),this.devicePlayer1.play(a),this.devicePlayer2.play(a),t.info.deviceNPCs.forEach((t=>{t.play(a)}))}t.info.btnStopEnabled=!0,t.info.btnPlayEnabled=!1,t.info.playing=!0,t.info.gamestatesServer=this.deviceServer.gameStateHistory,t.info.gamestatesPlayer1=this.devicePlayer1.gameStateHistory,t.info.gamestatesPlayer2=this.devicePlayer2.gameStateHistory,t.info.logsServer=this.deviceServer.log.traces,t.info.logsPlayer1=this.devicePlayer1.log.traces,t.info.logsPlayer2=this.devicePlayer2.log.traces},t.findMismatches=()=>{this.p2pmode||this.deviceServer.gameStateHistory.forEach((t=>{const e=this.devicePlayer1.gameStateHistory.find((e=>e.tick===t.tick));e?t.equals(e,!1)||(t.mismatches=!0,e.mismatches=!0):t.mismatches=!0;const i=this.devicePlayer2.gameStateHistory.find((e=>e.tick===t.tick));i?t.equals(i,!1)||(t.mismatches=!0,i.mismatches=!0):t.mismatches=!0})),this.devicePlayer1.gameStateHistory.forEach((t=>{if(!t.mismatches){const e=this.devicePlayer2.gameStateHistory.find((e=>e.tick===t.tick));e?t.equals(e,this.p2pmode)||(t.mismatches=!0,e.mismatches=!0):t.mismatches=!0}})),this.devicePlayer2.gameStateHistory.forEach((t=>{if(!t.mismatches){const e=this.devicePlayer1.gameStateHistory.find((e=>e.tick===t.tick));e?t.equals(e,this.p2pmode)||(t.mismatches=!0,e.mismatches=!0):t.mismatches=!0}}))},t.changeInterpolation=()=>{this.devicePlayer1.interpolation=t.info.interpolation,this.devicePlayer2.interpolation=t.info.interpolation},t.changeDebugBoxes=()=>{this.devicePlayer1.debugBoxes=t.info.debugBoxes,this.devicePlayer2.debugBoxes=t.info.debugBoxes},t.saveAll=()=>{let e=`\n--------------------\nPLAYER 1 GAME STATES\n--------------------\n${this.devicePlayer1.gameStateHistoryLog()}\n-------------\nPLAYER 1 LOGS\n-------------\n${this.devicePlayer1.log}\n\n--------------------\nPLAYER 2 GAME STATES\n--------------------\n${this.devicePlayer2.gameStateHistoryLog()}\n-------------\nPLAYER 2 LOGS\n-------------\n${this.devicePlayer2.log}`;this.p2pmode||(e+=`-----------------\nSERVER GAME STATES\n------------------\n${this.deviceServer.gameStateHistoryLog()}\n-----------\nSERVER LOGS\n-----------\n${this.deviceServer.log}`),this.saveFile(t.info.algorithm.name,e)},t.saveGamestates1=()=>{this.saveFile(`${t.info.algorithm.name}-p1-states`,this.devicePlayer1.gameStateHistoryLog())},t.saveLogs1=()=>{this.saveFile(`${t.info.algorithm.name}-p1-logs`,this.devicePlayer1.log.toString())},t.saveGamestates2=()=>{this.saveFile(`${t.info.algorithm.name}-p2-states`,this.devicePlayer2.gameStateHistoryLog())},t.saveLogs2=()=>{this.saveFile(`${t.info.algorithm.name}-p2-logs`,this.devicePlayer2.log.toString())},t.saveGamestatesS=()=>{this.saveFile(`${t.info.algorithm.name}-srv-states`,this.deviceServer.gameStateHistoryLog())},t.saveLogsS=()=>{this.saveFile(`${t.info.algorithm.name}-srv-logs`,this.deviceServer.log.toString())}}])}}).build();
