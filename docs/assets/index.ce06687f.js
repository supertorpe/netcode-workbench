var e=Object.defineProperty,t=(t,s,i)=>(((t,s,i)=>{s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[s]=i})(t,"symbol"!=typeof s?s+"":s,i),i);export function __vite_legacy_guard(){import("data:text/javascript,")}import{l as s,j as i,a,S as o}from"./vendor.94d8e087.js";!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver((e=>{for(const s of e)if("childList"===s.type)for(const e of s.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)})).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerpolicy&&(t.referrerPolicy=e.referrerpolicy),"use-credentials"===e.crossorigin?t.credentials="include":"anonymous"===e.crossorigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();const n={canvas:{width:300,height:250},network:{tickMs:50,minLatency:10,maxLatency:30},players:[{id:1,color:"#483D8B",x:10,y:10,size:20,keyUp:87,keyDown:83,keyLeft:65,keyRight:68},{id:2,color:"#6B8E23",x:270,y:220,size:20,keyUp:38,keyDown:40,keyLeft:37,keyRight:39}],physics:{worldScale:30,strength:10,borderThickness:5}};class r{constructor(){t(this,"_listeners",[])}addEventListener(e){this._listeners.includes(e)||this._listeners.push(e)}removeEventListener(e){const t=this._listeners.indexOf(e);-1!==t&&this._listeners.splice(t,1)}notify(e){this._listeners.forEach((t=>{t(e)}))}}const l=(e,t)=>Math.floor(Math.random()*(t-e+1)+e),c=()=>(new Date).getTime();class h{constructor(e,t){this.playerId=e,this.command=t}}class d{constructor(e){t(this,"_peers",[]),t(this,"_minLatency",0),t(this,"_maxLatency",0),t(this,"_commandSentEmitter",new r),t(this,"_commandReceivedEmitter",new r),this.playerId=e}get commandSentEmitter(){return this._commandSentEmitter}get commandReceivedEmitter(){return this._commandReceivedEmitter}set minLatency(e){this._minLatency=e}set maxLatency(e){this._maxLatency=e}connect(e){this._peers.push(e)}closeConnections(){this._peers=[]}broadcast(e){this._peers.forEach((t=>{this._commandSentEmitter.notify(new h(t.playerId,e)),0===this.maxLatency?t.receive(this,e):setTimeout((()=>{t.receive(this,e)}),l(this._minLatency,this._maxLatency))}))}send(e,t){this._commandSentEmitter.notify(new h(e.playerId,t)),0===this.maxLatency?e.receive(this,t):setTimeout((()=>{e.receive(this,t)}),l(this._minLatency,this._maxLatency))}receive(e,t){this._commandReceivedEmitter.notify(new h(e.playerId,t))}}var m,y;(y=m||(m={})).INFO="INFO",y.WARN="WARN",y.ERROR="ERROR";class g{constructor(e,t,s){this.level=e,this.timestamp=t,this.text=s}toString(){const e=new Date;return e.setTime(this.timestamp),`${e.getHours().toString().padStart(2,"0")}:${e.getMinutes().toString().padStart(2,"0")}:${e.getSeconds().toString().padStart(2,"0")}.${e.getMilliseconds().toString().padStart(3,"0")} ${this.level.padEnd(5)} ${this.text}`}}class p{constructor(){t(this,"_traces",[])}get traces(){return this._traces}log(e,t){this._traces.unshift(new g(e,c(),t))}logInfo(e){this.log(m.INFO,e)}logWarn(e){this.log(m.WARN,e)}logError(e){this.log(m.ERROR,e)}clear(){this._traces=[]}toString(){const e=this._traces.reverse().join("\n");return this._traces.reverse(),e}}const u=new class{constructor(){t(this,"pressedKeys",[]),document.onkeydown=document.onkeyup=e=>{this.pressedKeys[e.keyCode]="keydown"===e.type}}isPressed(e){return this.pressedKeys[e]}};class f{constructor(e,s,i){t(this,"_tick"),t(this,"_playerId"),t(this,"_value"),this._tick=e,this._playerId=s,this._value=i}get tick(){return this._tick}get playerId(){return this._playerId}get value(){return this._value}clone(e){return new f(this._tick+(e?1:0),this._playerId,this._value)}toString(){return`P${this._playerId}:${this._value}`}toFullString(){return`tick ${this._tick} P${this._playerId}:${this._value}`}}class v{constructor(e,t,s){this.id=e,this.x=t,this.y=s}toString(){return`P${this.id} x=${this.x} y=${this.y}`}}class _{constructor(e,t){this.playerId=e,this.value=t}toString(){return`P${this.playerId}:${this.value}`}}class w{constructor(e,t,s){this.tick=e,this.players=t,this.commands=s}toString(){return`tick: ${this.tick}\n  ${this.players.join("\n  ")}\n  Commands: ${this.commands.join(" ")}`}}class S{constructor(e,s){t(this,"_tick"),t(this,"_peerCount"),t(this,"_world"),t(this,"_bodies"),t(this,"_commands"),this._tick=e,this._world=s,this._bodies=[];for(let t=s.getBodyList();t;t=t.getNext())this._bodies.unshift(t);this._commands=[]}get tick(){return this._tick}get peerCount(){return this._peerCount}set peerCount(e){this._peerCount=e}get world(){return this._world}get bodies(){return this._bodies}get commands(){return this._commands}toString(){let e="";return this._bodies.forEach((t=>{!t.isStatic()&&t.getUserData()&&(e+=`    P${t.getUserData().id} x=${t.getPosition().x*n.physics.worldScale} y=${t.getPosition().x*n.physics.worldScale}\n`)})),`\nGameState tick: ${this._tick}\n  bodies:\n${e}  commands:\n    ${this._commands.join("\n    ")}`}incTick(){this._tick++}commandFromPlayer(e){return this._commands.find((t=>t.playerId===e))}clearCommands(){this._commands=[]}toLog(){const e=[];this._bodies.forEach((t=>{if(!t.isStatic()&&t.getUserData()){let s=t.getUserData();e.push(new v(s.id,t.getPosition().x*n.physics.worldScale,t.getPosition().y*n.physics.worldScale))}})),e.sort(((e,t)=>e.id>t.id?1:-1));const t=[];return this._commands.forEach((e=>{t.push(new _(e.playerId,e.value))})),t.sort(((e,t)=>e.playerId>t.playerId?1:-1)),new w(this._tick,e,t)}}class k extends class{constructor(e,s){t(this,"_initialGameState"),t(this,"_startTime"),t(this,"_tickMs"),t(this,"_currentTick"),this.log=e,this.gameStateMachine=s,this._startTime=0,this._tickMs=50,this._currentTick=0}get tickMs(){return this._tickMs}set tickMs(e){this._tickMs=e}get currentTick(){return this._currentTick}start(e){this._startTime=c(),this._currentTick=0,this._initialGameState=e}tickBasedOnTime(){return Math.floor((c()-this._startTime)/this._tickMs)}}{constructor(){super(...arguments),t(this,"localCommand"),t(this,"localCommandDumped",!1),t(this,"remoteCommands",[])}start(e){super.start(e)}tick(){let e=null;if(this.tickBasedOnTime()>this._currentTick){!this.localCommandDumped&&this.localCommand&&(this.localCommandDumped=!0,this._initialGameState.commands.push(this.localCommand));let t=0;const s=this.remoteCommands.length;for(let e=0;e<s;e++){let s=this.remoteCommands[e];s&&s.tick===this._initialGameState.tick&&(this._initialGameState.commands.push(s),this.remoteCommands.splice(e-t++,1))}this._initialGameState.commands.length<this._initialGameState.peerCount?this.log.logWarn(`Waiting commands for tick ${this._currentTick}: ${this._initialGameState.commands.length} of ${this._initialGameState.peerCount}`):(this._initialGameState.commands.sort(((e,t)=>e.playerId>t.playerId?1:-1)),this.log.logInfo(this._initialGameState.toString()),e=this._initialGameState.toLog(),this.gameStateMachine.compute(this._initialGameState),this._currentTick++,this._initialGameState.incTick(),this._initialGameState.clearCommands(),this.localCommand=void 0,this.localCommandDumped=!1)}return e}localCommandReceived(e,t){let s;return this.localCommand||(s=new f(this._currentTick,e,t),this.log.logInfo(`local command: ${s.toFullString()}`),this.localCommand=s),s}remoteCommandReceived(e){this.log.logInfo(`received command: ${e.toFullString()}`),this.remoteCommands.push(e)}getGameStateToRender(){return this._initialGameState}}const P=0,x=1,$=2,L=10,E=20,C=11,b=21,I=12,T=22;class G{constructor(e,s,i,a,o,n){t(this,"running",!1),t(this,"_log"),t(this,"_gameStateHistory"),t(this,"_networkConn"),t(this,"_canvas"),t(this,"_context"),t(this,"_deviceUpdatedEmitter",new r),t(this,"netcode"),this.playerId=e,this.keyUp=s,this.keyDown=i,this.keyLeft=a,this.keyRight=o,this._log=new p,this._networkConn=new d(e),this._networkConn.commandReceivedEmitter.addEventListener((e=>{this.messageReceived(e)})),this._canvas=n,this._context=n.getContext("2d"),this._gameStateHistory=[]}get log(){return this._log}get deviceUpdatedEmitter(){return this._deviceUpdatedEmitter}get gameStateHistory(){return this._gameStateHistory}connect(e){this._log.logInfo(`Connected to player ${e.playerId}`),this._networkConn.connect(e._networkConn)}reset(){this._log.clear(),this._gameStateHistory=[],this._networkConn.closeConnections()}play(e,t,s,i){this._networkConn.minLatency=s,this._networkConn.maxLatency=i;const a=this.createWorld(),o=new S(0,a);o.peerCount=2,this.netcode=class{constructor(){}static build(e,t,s){return new k(t,s)}}.build(e,this._log,this),this.netcode.tickMs=t,this.netcode.start(o),this.running=!0,window.requestAnimationFrame((()=>{this.gameLoop()}))}pause(){this.running=!1}gameStateHistoryLog(){const e=this._gameStateHistory.reverse().join("\n");return this._gameStateHistory.reverse(),e}createStaticBody(e,t,i,a,o){const r=e.createBody({type:"static"});r.setUserData({width:a,height:o}),r.createFixture(s.Box(a/2/n.physics.worldScale,o/2/n.physics.worldScale)),r.setPosition(s.Vec2((t+a/2)/n.physics.worldScale,(i+o/2)/n.physics.worldScale))}createWorld(){const e=s.Vec2(0,0),t=s.World(e);this.createStaticBody(t,0,0,this._canvas.width,n.physics.borderThickness),this.createStaticBody(t,0,this._canvas.height-n.physics.borderThickness,this._canvas.width,n.physics.borderThickness),this.createStaticBody(t,0,0,n.physics.borderThickness,this._canvas.height),this.createStaticBody(t,this._canvas.width-n.physics.borderThickness,0,n.physics.borderThickness,this._canvas.height);const i={density:0,restitution:.4};return n.players.forEach((e=>{const a=t.createBody({type:"dynamic",position:s.Vec2((e.x+e.size/2)/n.physics.worldScale,(e.y+e.size/2)/n.physics.worldScale),allowSleep:!1,awake:!0});a.createFixture(s.Box(e.size/2/n.physics.worldScale,e.size/2/n.physics.worldScale),i),a.setUserData(e)})),t}gameLoop(){this.running&&(window.requestAnimationFrame((()=>{this.gameLoop()})),this.update(),this.draw())}update(){const e=(u.isPressed(this.keyUp)?x:u.isPressed(this.keyDown)?$:P)+(u.isPressed(this.keyLeft)?L:u.isPressed(this.keyRight)?E:P),t=this.netcode.localCommandReceived(this.playerId,e);t&&(this.log.logInfo(`sending command: ${t.toFullString()}`),this._networkConn.broadcast(t));let s=this.netcode.tick();null!=s&&this._gameStateHistory.unshift(s),this._deviceUpdatedEmitter.notify()}draw(){if(!this._context)return;const e=this._context;e.clearRect(0,0,this._canvas.width,this._canvas.height);for(let t=this.netcode.getGameStateToRender().world.getBodyList();t;t=t.getNext())if(t.getUserData())if(t.isStatic()){let s=t.getUserData().width,i=t.getUserData().height;e.fillStyle="#708090",e.fillRect(t.getPosition().x*n.physics.worldScale-s/2,t.getPosition().y*n.physics.worldScale-i/2,s,i)}else{let s=t.getUserData();e.fillStyle=s.color,e.fillRect(t.getPosition().x*n.physics.worldScale-s.size/2,t.getPosition().y*n.physics.worldScale-s.size/2,s.size,s.size)}}compute(e){for(let t of e.commands){if(!t||t.value===P)continue;const i=e.bodies.find((e=>(e.getUserData()?e.getUserData().id:-1)==t.playerId));if(i){const e=t.value==E||t.value==T||t.value==b?n.physics.strength:t.value==L||t.value==I||t.value==C?-1*n.physics.strength:0,a=t.value==$||t.value==I||t.value==T?n.physics.strength:t.value==x||t.value==C||t.value==b?-1*n.physics.strength:0;this.log.logInfo(`apply command value ${t.value} to P${t.playerId}: force(x=${e} y=${a})`),i.applyForce(s.Vec2(e,a),i.getWorldCenter())}}e.world.step(this.netcode.tickMs/1e3),e.world.clearForces()}messageReceived(e){this.netcode.remoteCommandReceived(e.command)}}(new class{constructor(){t(this,"devicePlayer1"),t(this,"devicePlayer2"),t(this,"panelGamestates1"),t(this,"panelLog1"),t(this,"panelGamestates2"),t(this,"panelLog2"),this.devicePlayer1=new G(n.players[0].id,n.players[0].keyUp,n.players[0].keyDown,n.players[0].keyLeft,n.players[0].keyRight,document.getElementById("player1GameArea")),this.devicePlayer2=new G(n.players[1].id,n.players[1].keyUp,n.players[1].keyDown,n.players[1].keyLeft,n.players[1].keyRight,document.getElementById("player2GameArea"))}build(){this.createWindows(),this.bootstrapAngular()}createWindows(){i.create({headerTitle:"Control Panel",theme:"dimgrey",dragit:!1,headerControls:{close:"remove",maximize:"remove",normalize:"remove",minimize:"remove",smallify:"remove"},panelSize:{width:"100%",height:"150px"},position:{my:"left-top",at:"left-top",offsetX:"0",offsetY:"calc(100vh - 150px)"},content:document.getElementById("controlPanel")}),this.panelGamestates1=i.create({headerTitle:"Player 1 Game States",theme:"navy",contentOverflow:"auto",headerControls:{close:"remove",size:"xs"},resizeit:{handles:"n,s"},panelSize:{width:"350px",height:"calc(100vh - 150px)"},position:{my:"left-top",at:"left-top",offsetX:"0",offsetY:"0"},content:document.getElementById("player1GameStates")}),i.create({headerTitle:"Player 1 Canvas",theme:"DarkSlateBlue",contentOverflow:"hide",headerControls:{close:"remove",size:"xs"},panelSize:{width:"calc(50vw - 350px)",height:"calc(100vh - 350px)"},position:{my:"left-top",at:"left-top",offsetX:"350px",offsetY:"0"},content:document.getElementById("player1Canvas")}),this.panelLog1=i.create({headerTitle:"Player 1 Logs",theme:"RoyalBlue",contentOverflow:"auto",headerControls:{close:"remove",size:"xs"},panelSize:{width:"calc(50vw - 350px)",height:"200px"},position:{my:"left-top",at:"left-top",offsetX:"350px",offsetY:"calc(100vh - 350px)"},content:document.getElementById("player1Logs")}),this.panelGamestates2=i.create({headerTitle:"Player 2 Game States",theme:"olive",contentOverflow:"auto",headerControls:{close:"remove",size:"xs"},panelSize:{width:"350px",height:"calc(100vh - 150px)"},position:{my:"left-top",at:"left-top",offsetX:"calc(100vw - 350px)",offsetY:"0"},content:document.getElementById("player2GameStates")}),i.create({headerTitle:"Player 2 Canvas",theme:"OliveDrab",contentOverflow:"hide",headerControls:{close:"remove",size:"xs"},panelSize:{width:"calc(50vw - 350px)",height:"calc(100vh - 350px)"},position:{my:"left-top",at:"left-top",offsetX:"50vw",offsetY:"0"},content:document.getElementById("player2Canvas")}),this.panelLog2=i.create({headerTitle:"Player 2 Logs",theme:"LightGreen",contentOverflow:"auto",headerControls:{close:"remove",size:"xs"},panelSize:{width:"calc(50vw - 350px)",height:"200px"},position:{my:"left-top",at:"left-top",offsetX:"50vw",offsetY:"calc(100vh - 350px)"},content:document.getElementById("player2Logs")})}bootstrapAngular(){a.module("app",[]).controller("mainCtrl",["$scope",e=>{e.info={btnBackwardEnabled:!1,btnPauseEnabled:!1,btnStopEnabled:!1,btnPlayEnabled:!0,btnForwardEnabled:!1,btnSaveEnabled:!0,slowFactor:20,tick:n.network.tickMs,algorithm:"naive",latency:{min:n.network.minLatency,max:n.network.maxLatency},realtimeGameStates:!0,realtimeLogs:!0,logsPlayer1:[],logsPlayer2:[],gamestatesPlayer1:[],gamestatesPlayer2:[]},this.devicePlayer1.deviceUpdatedEmitter.addEventListener((()=>{e.$apply()})),this.panelGamestates1.addControl({html:'<span class="fas fa-download"></span>',name:"download",position:1,handler:()=>{e.saveGamestates1()}}),this.panelLog1.addControl({html:'<span class="fas fa-download"></span>',name:"download",position:1,handler:()=>{e.saveLogs1()}}),this.panelGamestates2.addControl({html:'<span class="fas fa-download"></span>',name:"download",position:1,handler:()=>{e.saveGamestates2()}}),this.panelLog2.addControl({html:'<span class="fas fa-download"></span>',name:"download",position:1,handler:()=>{e.saveLogs2()}}),e.backward=()=>{alert("backward")},e.pause=()=>{alert("pause")},e.stop=()=>{this.devicePlayer1.pause(),this.devicePlayer2.pause(),e.info.btnStopEnabled=!1,e.info.btnPlayEnabled=!0,e.info.realtimeGameStates||(e.info.gamestatesPlayer1=this.devicePlayer1.gameStateHistory,e.info.gamestatesPlayer2=this.devicePlayer2.gameStateHistory),e.info.realtimeLogs||(e.info.logsPlayer1=this.devicePlayer1.log.traces,e.info.logsPlayer2=this.devicePlayer2.log.traces)},e.play=()=>{this.devicePlayer1.reset(),this.devicePlayer2.reset(),this.devicePlayer1.connect(this.devicePlayer2),this.devicePlayer2.connect(this.devicePlayer1),this.devicePlayer1.play(e.info.algorithm,e.info.tick,e.info.latency.min,e.info.latency.max),this.devicePlayer2.play(e.info.algorithm,e.info.tick,e.info.latency.min,e.info.latency.max),e.info.btnStopEnabled=!0,e.info.btnPlayEnabled=!1,e.checkRealtimeInfo()},e.checkRealtimeInfo=()=>{e.info.realtimeGameStates?(e.info.gamestatesPlayer1=this.devicePlayer1.gameStateHistory,e.info.gamestatesPlayer2=this.devicePlayer2.gameStateHistory):(e.info.gamestatesPlayer1=[],e.info.gamestatesPlayer2=[]),e.info.realtimeLogs?(e.info.logsPlayer1=this.devicePlayer1.log.traces,e.info.logsPlayer2=this.devicePlayer2.log.traces):(e.info.logsPlayer1=[],e.info.logsPlayer2=[])},e.forward=()=>{alert("forward")},e.saveAll=()=>{const t=new Date,s=o.exports.createWriteStream(`${t.getFullYear()}${t.getMonth()}${t.getDate()}${t.getHours()}${t.getMinutes()}${t.getSeconds()}-${e.info.algorithm}.log`).getWriter(),i=new TextEncoder,a=`--------------------\nPLAYER 1 GAME STATES\n--------------------\n${this.devicePlayer1.gameStateHistoryLog()}\n-------------\nPLAYER 1 LOGS\n-------------\n${this.devicePlayer1.log}\n\n--------------------\nPLAYER 2 GAME STATES\n--------------------\n${this.devicePlayer2.gameStateHistoryLog()}\n-------------\nPLAYER 2 LOGS\n-------------\n${this.devicePlayer2.log}`,n=i.encode(a);s.write(n),s.close()},e.saveGamestates1=()=>{const t=new Date,s=o.exports.createWriteStream(`${t.getFullYear()}${t.getMonth()}${t.getDate()}${t.getHours()}${t.getMinutes()}${t.getSeconds()}-${e.info.algorithm}-p1states.log`).getWriter(),i=(new TextEncoder).encode(this.devicePlayer1.gameStateHistoryLog());s.write(i),s.close()},e.saveLogs1=()=>{const t=new Date,s=o.exports.createWriteStream(`${t.getFullYear()}${t.getMonth()}${t.getDate()}${t.getHours()}${t.getMinutes()}${t.getSeconds()}-${e.info.algorithm}-p1logs.log`).getWriter(),i=(new TextEncoder).encode(this.devicePlayer1.log.toString());s.write(i),s.close()},e.saveGamestates2=()=>{const t=new Date,s=o.exports.createWriteStream(`${t.getFullYear()}${t.getMonth()}${t.getDate()}${t.getHours()}${t.getMinutes()}${t.getSeconds()}-${e.info.algorithm}-p2states.log`).getWriter(),i=(new TextEncoder).encode(this.devicePlayer2.gameStateHistoryLog());s.write(i),s.close()},e.saveLogs2=()=>{const t=new Date,s=o.exports.createWriteStream(`${t.getFullYear()}${t.getMonth()}${t.getDate()}${t.getHours()}${t.getMinutes()}${t.getSeconds()}-${e.info.algorithm}-p2logs.log`).getWriter(),i=(new TextEncoder).encode(this.devicePlayer2.log.toString());s.write(i),s.close()}}])}}).build();
