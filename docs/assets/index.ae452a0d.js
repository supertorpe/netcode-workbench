var e=Object.defineProperty,t=(t,s,i)=>(((t,s,i)=>{s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[s]=i})(t,"symbol"!=typeof s?s+"":s,i),i);export function __vite_legacy_guard(){import("data:text/javascript,")}import{f as s,t as i,l as o,j as n,S as a,a as r}from"./vendor.adc80e06.js";!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver((e=>{for(const s of e)if("childList"===s.type)for(const e of s.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)})).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerpolicy&&(t.referrerPolicy=e.referrerpolicy),"use-credentials"===e.crossorigin?t.credentials="include":"anonymous"===e.crossorigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();const c={};var l={canvas:{width:300,height:250},network:{tickMs:50,minLatency1:10,maxLatency1:30,packetLoss1:0,minLatency2:10,maxLatency2:30,packetLoss2:0},netcodes:[{name:"p2p-naive",type:"p2p"},{name:"p2p-delayed",type:"p2p"},{name:"cs-lockstep",type:"cs"},{name:"custom",type:"custom"}],players:[{id:1,color:"#483D8B",x:10,y:10,size:20,keyUp:87,keyDown:83,keyLeft:65,keyRight:68},{id:2,color:"#6B8E23",x:270,y:220,size:20,keyUp:38,keyDown:40,keyLeft:37,keyRight:39}],npc:{color:"black"},border:{color:"#708090"},physics:{worldScale:30,strength:10,borderThickness:5}};const h=0,m=1,d=2,p=10,g=20,y=11,f=21,S=12,u=22;class v{constructor(e,t){this.name=e,this.type=t}}const w=l;class _{constructor(){t(this,"_listeners",[])}addEventListener(e){this._listeners.includes(e)||this._listeners.push(e)}removeEventListener(e){const t=this._listeners.indexOf(e);-1!==t&&this._listeners.splice(t,1)}removeListeners(){this._listeners=[]}notify(e){this._listeners.forEach((t=>{t(e)}))}}const k=()=>(new Date).getTime();class x{constructor(e){t(this,"connections",[]),t(this,"_connectionEmitter",new _),t(this,"_disconnectionEmitter",new _),t(this,"_messageSentEmitter",new _),t(this,"_messageReceivedEmitter",new _),this.log=e}get connectionCount(){return this.connections.length}get connectionEmitter(){return this._connectionEmitter}get disconnectionEmitter(){return this._disconnectionEmitter}get messageSentEmitter(){return this._messageSentEmitter}get messageReceivedEmitter(){return this._messageReceivedEmitter}connect(e,t){this.attachListeners(e),this.connections.push(e),e.connect(t),0===t.peerId?this.log.logInfo("Connected to Server"):this.log.logInfo(`Connected to Player ${t.peerId}`)}attachListeners(e){e.connectionEmitter.addEventListener((e=>{this._connectionEmitter.notify(e)})),e.disconnectionEmitter.addEventListener((e=>{this._disconnectionEmitter.notify(e)})),e.messageReceivedEmitter.addEventListener((e=>{this._messageReceivedEmitter.notify(e)})),e.messageSentEmitter.addEventListener((e=>{this._messageSentEmitter.notify(e)}))}findConnection(e){return this.connections.find((t=>t.peer.peerId===e))}closeConnections(){this.connections.forEach((e=>{0===e.peer.peerId?this.log.logInfo("Disconnected from Server"):this.log.logInfo(`Disconnected from Player ${e.peer.peerId}`),this._disconnectionEmitter.notify(e)})),this.connections=[]}resetEmitters(){this._connectionEmitter.removeListeners(),this._disconnectionEmitter.removeListeners(),this._messageSentEmitter.removeListeners(),this._messageReceivedEmitter.removeListeners()}broadcast(e){this.connections.forEach((t=>{t.send(e)}))}send(e,t){var s;null==(s=this.findConnection(e))||s.send(t)}}class L{constructor(e,s){t(this,"_peer"),t(this,"_minLatency",0),t(this,"_maxLatency",0),t(this,"_packetLoss",0),t(this,"_totalSent",0),t(this,"_totalLost",0),t(this,"_connectionEmitter",new _),t(this,"_disconnectionEmitter",new _),t(this,"_messageSentEmitter",new _),t(this,"_messageReceivedEmitter",new _),this.peerId=e,this.log=s}get connectionEmitter(){return this._connectionEmitter}get disconnectionEmitter(){return this._disconnectionEmitter}get messageSentEmitter(){return this._messageSentEmitter}get messageReceivedEmitter(){return this._messageReceivedEmitter}get peer(){return this._peer}set minLatency(e){this._minLatency=e}set maxLatency(e){this._maxLatency=e}set packetLoss(e){this._packetLoss=e}connect(e){this._peer=e,this._connectionEmitter.notify(e)}send(e){if(e.timestampOrigin=k(),e.origin=this.peerId,e.destination=this._peer.peerId,this._packetLoss>0&&this._totalLost+1<this._totalSent*this._packetLoss/100)return this.log.logWarn(`Message for tick ${e.tick} lost`),void this._totalLost++;var t,s;this._totalSent++,this._messageSentEmitter.notify(e),0===this.maxLatency?this._peer.receive(e):setTimeout((()=>{this._peer.receive(e)}),(t=this._minLatency,s=this._maxLatency,Math.floor(Math.random()*(s-t+1)+t)))}receive(e){e.timestampDestination=k(),this._messageReceivedEmitter.notify(e)}}var E,C;(C=E||(E={})).INFO="INFO",C.WARN="WARN",C.ERROR="ERROR";const b=class{constructor(e,s,i){t(this,"_id"),this.level=e,this.timestamp=s,this.text=i,this._id=b.idCounter++}get id(){return this._id}toString(){const e=new Date;return e.setTime(this.timestamp),`${e.getHours().toString().padStart(2,"0")}:${e.getMinutes().toString().padStart(2,"0")}:${e.getSeconds().toString().padStart(2,"0")}.${e.getMilliseconds().toString().padStart(3,"0")} ${this.level.padEnd(5)} ${this.text}`}};let P=b;t(P,"idCounter",0);class T{constructor(){t(this,"_traces",[])}get traces(){return this._traces}log(e,t){this._traces.unshift(new P(e,k(),t))}logInfo(e){this.log(E.INFO,e)}logWarn(e){this.log(E.WARN,e)}logError(e){this.log(E.ERROR,e)}clear(){this._traces=[]}toString(){const e=this._traces.reverse().join("\n");return this._traces.reverse(),e}}class G{constructor(e,s,i){t(this,"_tick"),t(this,"_playerId"),t(this,"_value"),this._tick=e,this._playerId=s,this._value=i}get tick(){return this._tick}get playerId(){return this._playerId}get value(){return this._value}clone(e){return new G(this._tick+(e?1:0),this._playerId,this._value)}toString(){return`P${this._playerId}:${this._value}`}toFullString(){return`tick ${this._tick} P${this._playerId}:${this._value}`}}class I{constructor(e,t,s){this.id=e,this.x=t,this.y=s}toString(){return`P${this.id} x=${this.x} y=${this.y}`}}class ${constructor(e,t){this.playerId=e,this.value=t}toString(){return`P${this.playerId}:${this.value}`}}class B{constructor(e,t,s){this.tick=e,this.players=t,this.commands=s}toString(){return`tick: ${this.tick}\n  ${this.players.join("\n  ")}\n  Commands: ${this.commands.join(" ")}`}}class R{constructor(e){t(this,"_tick"),t(this,"_commands"),this._tick=e,this._commands=[]}get tick(){return this._tick}get commands(){return this._commands}incTick(){this._tick++}commandFromPlayer(e){return this._commands.find((t=>t.playerId===e))}clearCommands(){this._commands=[]}}class D{constructor(e,s,i){t(this,"_timestampOrigin"),t(this,"_timestampDestination"),this.tick=e,this.origin=s,this.destination=i}get timestampOrigin(){return this._timestampOrigin}set timestampOrigin(e){this._timestampOrigin=e}get timestampDestination(){return this._timestampDestination}set timestampDestination(e){this._timestampDestination=e}}class z extends D{constructor(e,s,i){super(e.tick,s,i),t(this,"_command"),this._command=e}get command(){return this._command}}class Y extends D{constructor(e,s,i){super(e.tick,s,i),t(this,"_gameState"),this._gameState=e}get gameState(){return this._gameState}}class M{constructor(e,t,s,i,o,n,a,r,c){this.id=e,this.isStatic=t,this.posX=s,this.posY=i,this.velX=o,this.velY=n,this.width=a,this.height=r,this.color=c}clone(){return new M(this.id,this.isStatic,this.posX,this.posY,this.velX,this.velY,this.width,this.height,this.color)}}class X extends R{constructor(e,s){super(e),t(this,"_bodies"),this._bodies=s}get bodies(){return this._bodies}bodyFromPlayer(e){return this._bodies.find((t=>t.id===e))}toString(){let e="";return this._bodies.forEach((t=>{t.isStatic||(e+=`    P${t.id} x=${t.posX*w.physics.worldScale} y=${t.posY*w.physics.worldScale}\n`)})),`\nGameState tick: ${this._tick}\n  bodies:\n${e}  commands:\n    ${this._commands.join("\n    ")}`}clone(){const e=[];this._bodies.forEach((t=>{e.push(t.clone())}));const t=new X(this._tick,this._bodies);return this._commands.forEach((e=>t.commands.push(e.clone(!1)))),t}toLog(){const e=[];this._bodies.forEach((t=>{t.isStatic||e.push(new I(t.id,t.posX*w.physics.worldScale,t.posY*w.physics.worldScale))})),e.sort(((e,t)=>e.id>t.id?1:-1));const t=[];return this._commands.forEach((e=>{t.push(new $(e.playerId,e.value))})),t.sort(((e,t)=>e.playerId>t.playerId?1:-1)),new B(this._tick,e,t)}}class U extends R{constructor(e,s){super(e),t(this,"_world"),t(this,"_bodies"),this._world=s,this._bodies=[];for(let t=s.getBodyList();t;t=t.getNext())this._bodies.unshift(t)}get world(){return this._world}get bodies(){return this._bodies}bodyFromPlayer(e){return this._bodies.find((t=>t.getUserData().id===e))}toString(){let e="";return this._bodies.forEach((t=>{!t.isStatic()&&t.getUserData()&&(e+=`    P${t.getUserData().id} x=${t.getPosition().x*w.physics.worldScale} y=${t.getPosition().y*w.physics.worldScale}\n`)})),`\nGameState tick: ${this._tick}\n  bodies:\n${e}  commands:\n    ${this._commands.join("\n    ")}`}clone(){const e=this.cloneWorld(this._world,this._bodies),t=new U(this._tick,e);return this._commands.forEach((e=>t.commands.push(e.clone(!1)))),t}cloneWorld(e,t){const o=s(i(e)),n=[];for(let s=o.getBodyList();s;s=s.getNext())n.unshift(s);for(let[s,i]of n.entries())null!==i&&i.setUserData(t[s].getUserData());return o}toLog(){const e=[];this._bodies.forEach((t=>{if(!t.isStatic()&&t.getUserData()){let s=t.getUserData();e.push(new I(s.id,t.getPosition().x*w.physics.worldScale,t.getPosition().y*w.physics.worldScale))}})),e.sort(((e,t)=>e.id>t.id?1:-1));const t=[];return this._commands.forEach((e=>{t.push(new $(e.playerId,e.value))})),t.sort(((e,t)=>e.playerId>t.playerId?1:-1)),new B(this._tick,e,t)}buildSimpleGameState(){const e=[];return this._bodies.forEach((t=>{if(!t.isStatic()){let s=t.getUserData();const i=new M(s.id,!1,t.getPosition().x,t.getPosition().y,t.getLinearVelocity().x,t.getLinearVelocity().y,s.size,s.size,s.color);e.push(i)}if(t.isStatic()){const s=new M(-1,!0,t.getPosition().x,t.getPosition().y,t.getLinearVelocity().x,t.getLinearVelocity().y,t.getUserData().width,t.getUserData().height,w.border.color);e.push(s)}})),new X(this.tick,e)}}class O{constructor(e,s,i){t(this,"_gameState"),t(this,"_startTime"),t(this,"_tickMs"),t(this,"_currentTick"),this.log=e,this.net=s,this.gameStateMachine=i,this._startTime=0,this._tickMs=50,this._currentTick=0,this.net.messageReceivedEmitter.addEventListener((e=>{e instanceof z?this.remoteCommandReceived(e.command):e instanceof Y?this.gameStateReceived(e.gameState):this.log.logError(`Unknown message received: ${e}`)}))}get tickMs(){return this._tickMs}set tickMs(e){this._tickMs=e}get currentTick(){return this._currentTick}start(e){return this._startTime=k(),this._currentTick=0,e&&(this._gameState=e),this._startTime}tickBasedOnTime(){return Math.floor((k()-this._startTime)/this._tickMs)}tickTime(e){return this._startTime+e*this.tickMs}}class W extends O{constructor(){super(...arguments),t(this,"localCommandTick",-1),t(this,"lastTickReturned",-1)}tick(){let e=null;return this.lastTickReturned<this._currentTick&&this._gameState&&(this.lastTickReturned=this._currentTick,this.log.logInfo(this._gameState.toString()),e=this._gameState.toLog()),e}localCommandReceived(e,t){if(this.localCommandTick<this._currentTick){this.localCommandTick=this._currentTick;const s=new G(this._currentTick,e,t);this.log.logInfo(`sending local command: ${s.toFullString()}`),this.net.broadcast(new z(s))}}remoteCommandReceived(e){throw new Error("CSLockstepClientNetCode: does not support receiving remote commands")}gameStateReceived(e){this.log.logInfo(`received gamestate: ${e.toLog()}`),e.tick<this._currentTick?this.log.logInfo(`ignoring old gamestate: ${e.tick}`):(this._gameState=e,this._currentTick=e.tick)}getGameStateToRender(){return this._gameState}getGameState(e){return this._gameState.tick===e?this._gameState:null}}class F extends O{constructor(){super(...arguments),t(this,"initialGameStateSent",!1),t(this,"remoteCommands",[])}tick(){let e=null;if(!this.initialGameStateSent){this.initialGameStateSent=!0;const t=this._gameState.buildSimpleGameState();this.log.logInfo(`sending gamestate: ${t.toLog()}`),this.net.broadcast(new Y(t)),e=this._gameState.toLog()}if(this.tickBasedOnTime()>this._currentTick){let t=0;const s=this.remoteCommands.length;for(let e=0;e<s;e++){let s=this.remoteCommands[e];s&&s.tick===this._gameState.tick&&(this._gameState.commands.push(s),this.remoteCommands.splice(e-t++,1))}if(this._gameState.commands.length<this.net.connectionCount)this.log.logWarn(`Waiting commands for tick ${this._currentTick}: ${this._gameState.commands.length} of ${this.net.connectionCount}`);else{this._gameState.commands.sort(((e,t)=>e.playerId>t.playerId?1:-1)),this.log.logInfo(this._gameState.toString()),e=this._gameState.toLog(),this.gameStateMachine.compute(this._gameState),this._currentTick++,this._gameState.incTick(),this._gameState.clearCommands();const t=this._gameState.buildSimpleGameState();this.log.logInfo(`sending gamestate: ${t.toLog()}`),this.net.broadcast(new Y(t))}}return e}localCommandReceived(e,t){throw new Error("CSLockstepServerNetCode: does not support receiving local commands")}remoteCommandReceived(e){this.log.logInfo(`received command: ${e.toFullString()}`),this.remoteCommands.push(e)}gameStateReceived(e){throw new Error("CSLockstepServerNetCode: does not support receiving game states")}getGameStateToRender(){return this._gameState}getGameState(e){return this._gameState.tick===e?this._gameState:null}}class A extends O{constructor(){super(...arguments),t(this,"localCommand"),t(this,"localCommandDumped",!1),t(this,"remoteCommands",[])}start(e){return super.start(e)}tick(){let e=null;if(this.tickBasedOnTime()>this._currentTick){!this.localCommandDumped&&this.localCommand&&(this.localCommandDumped=!0,this._gameState.commands.push(this.localCommand));let t=0;const s=this.remoteCommands.length;for(let e=0;e<s;e++){let s=this.remoteCommands[e];s&&s.tick===this._gameState.tick&&(this._gameState.commands.push(s),this.remoteCommands.splice(e-t++,1))}this._gameState.commands.length<this.net.connectionCount+1?this.log.logWarn(`Waiting commands for tick ${this._currentTick}: ${this._gameState.commands.length} of ${this.net.connectionCount+1}`):(this._gameState.commands.sort(((e,t)=>e.playerId>t.playerId?1:-1)),this.log.logInfo(this._gameState.toString()),e=this._gameState.toLog(),this.gameStateMachine.compute(this._gameState),this._currentTick++,this._gameState.incTick(),this._gameState.clearCommands(),this.localCommand=void 0,this.localCommandDumped=!1)}return e}localCommandReceived(e,t){if(!this.localCommand){const s=new G(this._currentTick,e,t);this.localCommand=s,this.log.logInfo(`sending local command: ${s.toFullString()}`),this.net.broadcast(new z(s))}}remoteCommandReceived(e){this.log.logInfo(`received command: ${e.toFullString()}`),this.remoteCommands.push(e)}gameStateReceived(e){throw new Error("P2PNaiveNetCode: Method not implemented.")}getGameStateToRender(){return this._gameState}getGameState(e){return this._gameState.tick===e?this._gameState:null}}class H extends O{constructor(){super(...arguments),t(this,"localCommand"),t(this,"localCommandDumped",!1),t(this,"remoteCommands",[]),t(this,"prevGameState")}start(e){return super.start(e)}tick(){let e=null;if(this.tickBasedOnTime()>this._currentTick){!this.localCommandDumped&&this.localCommand&&(this.localCommandDumped=!0,this._gameState.commands.push(this.localCommand));let t=0;const s=this.remoteCommands.length;for(let e=0;e<s;e++){let s=this.remoteCommands[e];s&&s.tick===this._gameState.tick&&(this._gameState.commands.push(s),this.remoteCommands.splice(e-t++,1))}this._gameState.commands.length<this.net.connectionCount+1?this.log.logWarn(`Waiting commands for tick ${this._currentTick}: ${this._gameState.commands.length} of ${this.net.connectionCount+1}`):(this._gameState.commands.sort(((e,t)=>e.playerId>t.playerId?1:-1)),this.log.logInfo(this._gameState.toString()),e=this._gameState.toLog(),this.prevGameState=this._gameState.clone(),this.gameStateMachine.compute(this._gameState),this._currentTick++,this._gameState.incTick(),this._gameState.clearCommands(),this.localCommand=void 0,this.localCommandDumped=!1)}return e}localCommandReceived(e,t){if(!this.localCommand){const s=new G(this._currentTick,e,t);this.localCommand=s,this.log.logInfo(`sending local command: ${s.toFullString()}`),this.net.broadcast(new z(s))}}remoteCommandReceived(e){this.log.logInfo(`received command: ${e.toFullString()}`),this.remoteCommands.push(e)}gameStateReceived(e){throw new Error("P2PDelayedNetCode: Method not implemented.")}getGameStateToRender(){return this.prevGameState?this.prevGameState:this._gameState}getGameState(e){return this._gameState.tick===e?this._gameState:this.prevGameState&&this.prevGameState.tick===e?this.prevGameState:null}}class N{constructor(){}static build(e,t,s,i){switch(e){case"p2p-naive":return t.logInfo("Using p2p-naive netcode"),new A(t,s,i);case"p2p-delayed":return t.logInfo("Using p2p-delayed netcode"),new H(t,s,i);case"cs-lockstep-client":return t.logInfo("Using cs-lockstep-client netcode"),new W(t,s,i);case"cs-lockstep-server":return t.logInfo("Using cs-lockstep-server netcode"),new F(t,s,i);default:return t.logInfo(`Netcode ${e} not found`),null}}static buildFromClass(e,t,s,i){return new e(t,s,i)}}class j{constructor(e,s,i){t(this,"context"),t(this,"_debugBoxes",!0),this.log=e,this.canvas=s,this.netcode=i;const o=s.getContext("2d");if(!o)throw"Error getting context 2d";this.context=o}get debugBoxes(){return this._debugBoxes}set debugBoxes(e){this._debugBoxes=e}}class V{constructor(e,t,s,i,o,n,a,r){this.currentTime=e,this.currentGameState=t,this.currentGameStateTime=s,this.elapsed=i,this.nextGameState=o,this.nextGameStateTime=n,this.nextElapsed=a,this.tickTimeDiff=r}}class q extends j{constructor(e,t,s){super(e,t,s),this.log=e,this.canvas=t,this.netcode=s}render(e){e?this.renderWithInterpolation():this.renderAsIs()}renderAsIs(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height);for(let e=this.netcode.getGameStateToRender().world.getBodyList();e;e=e.getNext())e.getUserData()&&(e.isStatic()?this.drawStaticBody(e):this.drawDynamicBody(e))}renderWithInterpolation(){let e=k();const t=this.netcode.getGameStateToRender(),s=this.netcode.tickTime(t.tick),i=this.netcode.getGameState(t.tick+1),o=i?this.netcode.tickTime(i.tick):void 0;o&&(e-=o-s),e>s+this.netcode.tickMs&&(e=s+this.netcode.tickMs);const n=new V(e,t,s,(e-s)/1e3,i,i?this.netcode.tickTime(i.tick):void 0,o?(e-o)/1e3:0,o?(o-s)/1e3:this.netcode.tickMs/1e3);this.context.clearRect(0,0,this.canvas.width,this.canvas.height);for(let a=t.world.getBodyList();a;a=a.getNext())a.getUserData()&&(a.isStatic()?this.drawStaticBody(a):this.drawDynamicBodyWithInterpolation(a,n))}drawStaticBody(e){let t=e.getUserData().width,s=e.getUserData().height;this.context.fillStyle=w.border.color,this.context.fillRect(e.getPosition().x*w.physics.worldScale-t/2,e.getPosition().y*w.physics.worldScale-s/2,t,s)}drawDynamicBody(e){let t=e.getUserData();this.context.fillStyle=t.color,this.context.fillRect(e.getPosition().x*w.physics.worldScale-t.size/2,e.getPosition().y*w.physics.worldScale-t.size/2,t.size,t.size)}drawDynamicBodyWithInterpolation(e,t){let s,i,o,n=e.getUserData(),a=0,r=0;if(t.nextGameState){if(s=t.nextGameState.bodyFromPlayer(e.getUserData().id),s){const i=e.getPosition(),o=s.getPosition(),n=e.getLinearVelocity(),c=s.getLinearVelocity();a=Math.sign(n.x)===Math.sign(c.x)?i.x+t.elapsed*(o.x-i.x)/t.tickTimeDiff:t.elapsed<-t.nextElapsed?i.x+n.x*t.elapsed:o.x+c.x*t.nextElapsed,r=Math.sign(n.y)===Math.sign(c.y)?i.y+t.elapsed*(o.y-i.y)/t.tickTimeDiff:t.elapsed<-t.nextElapsed?i.y+n.y*t.elapsed:o.y+c.y*t.nextElapsed}}else a=e.getPosition().x+e.getLinearVelocity().x*t.elapsed,r=e.getPosition().y+e.getLinearVelocity().y*t.elapsed;this._debugBoxes&&(i=e.getPosition().x*w.physics.worldScale-n.size/2,o=e.getPosition().y*w.physics.worldScale-n.size/2,this.context.beginPath(),this.context.rect(i,o,n.size,n.size),this.context.strokeStyle="red",this.context.stroke(),s&&(i=s.getPosition().x*w.physics.worldScale-n.size/2,o=s.getPosition().y*w.physics.worldScale-n.size/2,this.context.beginPath(),this.context.rect(i,o,n.size,n.size),this.context.strokeStyle="blue",this.context.stroke())),i=a*w.physics.worldScale-n.size/2,o=r*w.physics.worldScale-n.size/2,this.context.fillStyle=n.color,this.context.fillRect(i,o,n.size,n.size)}}class K{constructor(e,t,s,i,o,n,a,r){this.currentTime=e,this.currentGameState=t,this.currentGameStateTime=s,this.elapsed=i,this.nextGameState=o,this.nextGameStateTime=n,this.nextElapsed=a,this.tickTimeDiff=r}}class J extends j{constructor(e,t,s){super(e,t,s),this.log=e,this.canvas=t,this.netcode=s}render(e){e?this.renderWithInterpolation():this.renderAsIs()}renderAsIs(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height);this.netcode.getGameStateToRender().bodies.forEach((e=>{e.isStatic?this.drawStaticBody(e):this.drawDynamicBody(e)}))}renderWithInterpolation(){let e=k();const t=this.netcode.getGameStateToRender();if(!t)return;const s=this.netcode.tickTime(t.tick),i=this.netcode.getGameState(t.tick+1),o=i?this.netcode.tickTime(i.tick):void 0;o&&(e-=o-s),e>s+this.netcode.tickMs&&(e=s+this.netcode.tickMs);const n=new K(e,t,s,(e-s)/1e3,i,i?this.netcode.tickTime(i.tick):void 0,o?(e-o)/1e3:0,o?(o-s)/1e3:this.netcode.tickMs/1e3);this.context.clearRect(0,0,this.canvas.width,this.canvas.height),t.bodies.forEach((e=>{e.isStatic?this.drawStaticBody(e):this.drawDynamicBodyWithInterpolation(e,n)}))}drawStaticBody(e){this.context.fillStyle=e.color,this.context.fillRect(e.posX*w.physics.worldScale-e.width/2,e.posY*w.physics.worldScale-e.height/2,e.width,e.height)}drawDynamicBody(e){this.context.fillStyle=e.color,this.context.fillRect(e.posX*w.physics.worldScale-e.width/2,e.posY*w.physics.worldScale-e.height/2,e.width,e.height)}drawDynamicBodyWithInterpolation(e,t){let s,i,o,n=0,a=0;t.nextGameState?(s=t.nextGameState.bodyFromPlayer(e.id),s&&(n=Math.sign(e.velX)===Math.sign(s.velX)?e.posX+t.elapsed*(s.posX-e.posX)/t.tickTimeDiff:t.elapsed<-t.nextElapsed?e.posX+e.velX*t.elapsed:s.posX+s.velX*t.nextElapsed,a=Math.sign(e.velY)===Math.sign(s.velY)?e.posY+t.elapsed*(s.posY-e.posY)/t.tickTimeDiff:t.elapsed<-t.nextElapsed?e.posY+e.velY*t.elapsed:s.posY+s.velY*t.nextElapsed)):(n=e.posX+e.velX*t.elapsed,a=e.posY+e.velY*t.elapsed),this._debugBoxes&&(i=e.posX*w.physics.worldScale-e.width/2,o=e.posY*w.physics.worldScale-e.height/2,this.context.beginPath(),this.context.rect(i,o,e.width,e.height),this.context.strokeStyle="red",this.context.stroke(),s&&(i=s.posX*w.physics.worldScale-s.width/2,o=s.posY*w.physics.worldScale-s.height/2,this.context.beginPath(),this.context.rect(i,o,s.width,s.height),this.context.strokeStyle="blue",this.context.stroke())),i=n*w.physics.worldScale-e.width/2,o=a*w.physics.worldScale-e.height/2,this.context.fillStyle=e.color,this.context.fillRect(i,o,e.width,e.height)}}class Q{constructor(e,t,s,i,o){this.log=e,this.step=t,this.canvasWidth=s,this.canvasHeight=i,this.npcs=o}buildInitialGameState(){const e=this.createPlanckWorld();return new U(0,e)}compute(e){const t=e;for(let s of t.commands){if(!s||s.value===h)continue;const e=t.bodies.find((e=>(e.getUserData()?e.getUserData().id:-1)==s.playerId));if(e){const t=s.value==g||s.value==u||s.value==f?w.physics.strength:s.value==p||s.value==S||s.value==y?-1*w.physics.strength:0,i=s.value==d||s.value==S||s.value==u?w.physics.strength:s.value==m||s.value==y||s.value==f?-1*w.physics.strength:0;this.log.logInfo(`apply command value ${s.value} to P${s.playerId}: force(x=${t} y=${i})`),e.applyForce(o.Vec2(t,i),e.getWorldCenter())}}t.world.step(this.step),t.world.clearForces()}createPlanckStaticBody(e,t,s,i,n){const a=e.createBody({type:"static"});a.setUserData({width:i,height:n}),a.createFixture(o.Box(i/2/w.physics.worldScale,n/2/w.physics.worldScale)),a.setPosition(o.Vec2((t+i/2)/w.physics.worldScale,(s+n/2)/w.physics.worldScale))}createPlanckWorld(){const e=o.Vec2(0,0),t=o.World(e);this.createPlanckStaticBody(t,0,0,this.canvasWidth,w.physics.borderThickness),this.createPlanckStaticBody(t,0,this.canvasHeight-w.physics.borderThickness,this.canvasWidth,w.physics.borderThickness),this.createPlanckStaticBody(t,0,0,w.physics.borderThickness,this.canvasHeight),this.createPlanckStaticBody(t,this.canvasWidth-w.physics.borderThickness,0,w.physics.borderThickness,this.canvasHeight);const s={density:0,restitution:.4};w.players.forEach((e=>{const i=t.createBody({type:"dynamic",position:o.Vec2((e.x+e.size/2)/w.physics.worldScale,(e.y+e.size/2)/w.physics.worldScale),allowSleep:!1,awake:!0});i.createFixture(o.Box(e.size/2/w.physics.worldScale,e.size/2/w.physics.worldScale),s),i.setUserData(e)}));const i={density:0,restitution:1};let n=20;for(let a=0;a<this.npcs;a++){const e=t.createBody({type:"dynamic",position:o.Vec2((35+a*n+10+8*(10-this.npcs))/w.physics.worldScale,(35+a*n+10+8*(10-this.npcs))/w.physics.worldScale),allowSleep:!1,awake:!0});e.createFixture(o.Box(10/w.physics.worldScale,10/w.physics.worldScale),i),e.setUserData({id:100+a,size:n,color:w.npc.color})}return t}}class Z{constructor(){}buildInitialGameState(){return new X(0,[])}compute(e){}}class ee{constructor(e,s,i){t(this,"running",!1),t(this,"_log"),t(this,"_gameStateHistory"),t(this,"_networkInterface"),t(this,"_deviceUpdatedEmitter",new _),t(this,"netcode"),t(this,"gameStateMachine"),t(this,"renderer"),t(this,"_npcs",0),t(this,"_interpolation",!0),this.isServer=e,this.playerId=s,this.canvas=i,this._log=new T,this._networkInterface=new x(this._log),this._gameStateHistory=[]}get log(){return this._log}get deviceUpdatedEmitter(){return this._deviceUpdatedEmitter}get gameStateHistory(){return this._gameStateHistory}get interpolation(){return this._interpolation}set interpolation(e){this._interpolation=e}get debugBoxes(){return this.renderer.debugBoxes}set debugBoxes(e){this.renderer.debugBoxes=e}connect(e,t,s,i,o,n,a){const r=new L(this.playerId,this._log);r.minLatency=t,r.maxLatency=s,r.packetLoss=i;const c=new L(e.playerId,e._log);c.minLatency=o,c.maxLatency=n,c.packetLoss=a,this._networkInterface.connect(r,c),e._networkInterface.connect(c,r)}reset(){this._log.clear(),this._gameStateHistory=[]}play(e,t,s,i,o,n,a){let r;if(this.gameStateMachine=o?new Q(this._log,s/1e3,this.canvas.width,this.canvas.height,this._npcs):new Z,null===t){const t=e.name+("cs"===e.type?this.isServer?"-server":"-client":"");r=N.build(t,this._log,this._networkInterface,this.gameStateMachine)}else r=N.buildFromClass(t,this.log,this._networkInterface,this.gameStateMachine);if(null===r)return;this.netcode=r,this.netcode.tickMs=s,this._npcs=i,this._interpolation=n;const c=this.gameStateMachine.buildInitialGameState();this.renderer=o?new q(this.log,this.canvas,this.netcode):new J(this.log,this.canvas,this.netcode),this.renderer.debugBoxes=a,this.netcode.start(c),this.running=!0,window.requestAnimationFrame((()=>{this.gameLoop()}))}stop(){this.running=!1,this._networkInterface.closeConnections(),this._networkInterface.resetEmitters()}gameStateHistoryLog(){const e=this._gameStateHistory.reverse().join("\n");return this._gameStateHistory.reverse(),e}gameLoop(){this.running&&(window.requestAnimationFrame((()=>{this.gameLoop()})),this.update(),this.draw())}update(){try{let e=this.netcode.tick();null!=e&&this._gameStateHistory.unshift(e)}catch(e){this._log.logError(e)}this._deviceUpdatedEmitter.notify()}draw(){this.renderer.render(this._interpolation)}}const te=new class{constructor(){t(this,"pressedKeys",[]),document.onkeydown=document.onkeyup=e=>{this.pressedKeys[e.keyCode]="keydown"===e.type}}isPressed(e){return this.pressedKeys[e]}};class se extends ee{constructor(e,t,s,i,o,n){super(!1,e,n),this.playerId=e,this.keyUp=t,this.keyDown=s,this.keyLeft=i,this.keyRight=o,this.canvas=n}update(){const e=(te.isPressed(this.keyUp)?m:te.isPressed(this.keyDown)?d:h)+(te.isPressed(this.keyLeft)?p:te.isPressed(this.keyRight)?g:h);this.netcode.localCommandReceived(this.playerId,e),super.update()}}class ie extends ee{constructor(e,t){super(!0,e,t),this.playerId=e,this.canvas=t}}(new class{constructor(){t(this,"deviceServer"),t(this,"devicePlayer1"),t(this,"devicePlayer2"),t(this,"p2pmode",!0),t(this,"panelControl"),t(this,"panelCanvas1"),t(this,"panelGamestates1"),t(this,"panelLog1"),t(this,"panelCanvas2"),t(this,"panelGamestates2"),t(this,"panelLog2"),t(this,"panelCanvasS"),t(this,"panelGamestatesS"),t(this,"panelLogS"),this.deviceServer=new ie(0,document.getElementById("serverGameArea")),this.devicePlayer1=new se(w.players[0].id,w.players[0].keyUp,w.players[0].keyDown,w.players[0].keyLeft,w.players[0].keyRight,document.getElementById("player1GameArea")),this.devicePlayer2=new se(w.players[1].id,w.players[1].keyUp,w.players[1].keyDown,w.players[1].keyLeft,w.players[1].keyRight,document.getElementById("player2GameArea"))}build(){this.createWindows(),this.bootstrapAngular()}createWindows(){this.panelControl=n.create({headerTitle:"Control Panel",theme:"dimgrey",headerControls:{close:"remove",size:"xs"},panelSize:{width:"18em",height:"100%"},position:{my:"left-top",at:"left-top",offsetX:"0",offsetY:"0"},content:document.getElementById("controlPanel")}),this.panelGamestates1=n.create({headerTitle:"Player 1 Game States",theme:"DarkSlateBlue",contentOverflow:"auto",headerControls:{close:"remove",size:"xs"},resizeit:{handles:"n,s"},panelSize:{width:"22em",height:"50%"},position:{my:"left-top",at:"left-top",offsetX:"calc(100vw - 22em)",offsetY:"0"},content:document.getElementById("player1GameStates")}),this.panelCanvas1=n.create({headerTitle:"Player 1 Canvas",theme:"DarkSlateBlue",contentOverflow:"hide",headerControls:{close:"remove",size:"xs"},panelSize:{width:"310px",height:"calc(250px + 4.5em)"},position:{my:"left-top",at:"left-top",offsetX:"calc(18em + (100vw - 40em - 620px) / 3)",offsetY:"0"},content:document.getElementById("player1Canvas")}),this.panelLog1=n.create({headerTitle:"Player 1 Logs",theme:"DarkSlateBlue",contentOverflow:"auto",headerControls:{close:"remove",size:"xs"},panelSize:{width:"calc(100vw - 40em)",height:"calc((100vh - 250px - 4.5em) / 2)"},position:{my:"left-top",at:"left-top",offsetX:"18em",offsetY:"calc(250px + 4.5em)"},content:document.getElementById("player1Logs")}),this.panelGamestates2=n.create({headerTitle:"Player 2 Game States",theme:"OliveDrab",contentOverflow:"auto",headerControls:{close:"remove",size:"xs"},panelSize:{width:"350px",height:"50%"},position:{my:"left-top",at:"left-top",offsetX:"calc(100vw - 22em)",offsetY:"50%"},content:document.getElementById("player2GameStates")}),this.panelCanvas2=n.create({headerTitle:"Player 2 Canvas",theme:"OliveDrab",contentOverflow:"hide",headerControls:{close:"remove",size:"xs"},panelSize:{width:"310px",height:"calc(250px + 4.5em)"},position:{my:"left-top",at:"left-top",offsetX:"calc(100vw - 22em - 310px - (100vw - 40em - 620px) / 3)",offsetY:"0"},content:document.getElementById("player2Canvas")}),this.panelLog2=n.create({headerTitle:"Player 2 Logs",theme:"OliveDrab",contentOverflow:"auto",headerControls:{close:"remove",size:"xs"},panelSize:{width:"calc(100vw - 40em)",height:"calc((100vh - 250px - 4.5em) / 2)"},position:{my:"left-top",at:"left-top",offsetX:"18em",offsetY:"calc(250px + 4.5em + (100vh - 250px - 4.5em) / 2)"},content:document.getElementById("player2Logs")}),this.panelGamestatesS=n.create({headerTitle:"Server Game States",theme:"black",contentOverflow:"auto",headerControls:{close:"remove",size:"xs"},panelSize:{width:"350px",height:"50%"},position:{my:"left-top",at:"left-top",offsetX:"calc(100vw - 350px)",offsetY:"50%"},content:document.getElementById("serverGameStates")}),this.panelCanvasS=n.create({headerTitle:'Server "Canvas"',theme:"black",contentOverflow:"hide",headerControls:{close:"remove",size:"xs"},panelSize:{width:"310px",height:"calc(250px + 4.5em)"},position:{my:"left-top",at:"left-top",offsetX:"calc(50vw + 350px)",offsetY:"0"},content:document.getElementById("serverCanvas")}),this.panelLogS=n.create({headerTitle:"Server Logs",theme:"black",contentOverflow:"auto",headerControls:{close:"remove",size:"xs"},panelSize:{width:"calc(100vw - 40em)",height:"calc((100vh - 250px - 4.5em) / 2)"},position:{my:"left-top",at:"left-top",offsetX:"350px",offsetY:"75%"},content:document.getElementById("serverLogs")})}resetLayout(){this.panelControl.reposition({my:"left-top",at:"left-top",offsetX:"0",offsetY:"0"}),this.panelControl.resize({width:"18em",height:"100%"}),this.p2pmode?(this.panelGamestates1.reposition({my:"left-top",at:"left-top",offsetX:"calc(100vw - 22em)",offsetY:"0"}),this.panelGamestates1.resize({width:"22em",height:"50%"}),this.panelCanvas1.reposition({my:"left-top",at:"left-top",offsetX:"calc(18em + (100vw - 40em - 620px) / 3)",offsetY:"0"}),this.panelCanvas1.resize({width:"310px",height:"calc(250px + 4.5em)"}),this.panelLog1.reposition({my:"left-top",at:"left-top",offsetX:"18em",offsetY:"calc(250px + 4.5em)"}),this.panelLog1.resize({width:"calc(100vw - 40em)",height:"calc((100vh - 250px - 4.5em) / 2)"}),this.panelGamestates2.reposition({my:"left-top",at:"left-top",offsetX:"calc(100vw - 22em)",offsetY:"50%"}),this.panelGamestates2.resize({width:"22em",height:"50%"}),this.panelCanvas2.reposition({my:"left-top",at:"left-top",offsetX:"calc(100vw - 22em - 310px - (100vw - 40em - 620px) / 3)",offsetY:"0"}),this.panelCanvas2.resize({width:"310px",height:"calc(250px + 4.5em)"}),this.panelLog2.reposition({my:"left-top",at:"left-top",offsetX:"18em",offsetY:"calc(250px + 4.5em + (100vh - 250px - 4.5em) / 2)"}),this.panelLog2.resize({width:"calc(100vw - 40em)",height:"calc((100vh - 250px - 4.5em) / 2)"}),this.panelGamestatesS.reposition({my:"left-top",at:"left-top",offsetX:"1000vw",offsetY:"1000vh"}),this.panelCanvasS.reposition({my:"left-top",at:"left-top",offsetX:"1000vw",offsetY:"1000vh"}),this.panelLogS.reposition({my:"left-top",at:"left-top",offsetX:"1000vw",offsetY:"1000vh"})):(this.panelGamestates1.reposition({my:"left-top",at:"left-top",offsetX:"calc(100vw - 22em)",offsetY:"0"}),this.panelGamestates1.resize({width:"22em",height:"33%"}),this.panelCanvas1.reposition({my:"left-top",at:"left-top",offsetX:"18em",offsetY:"0"}),this.panelCanvas1.resize({width:"310px",height:"calc(250px + 4.5em)"}),this.panelLog1.reposition({my:"left-top",at:"left-top",offsetX:"18em",offsetY:"calc(250px + 4.5em)"}),this.panelLog1.resize({width:"calc(100vw - 40em - 4em)",height:"calc(100vh - 250px - 4.5em - 4em)"}),this.panelGamestates2.reposition({my:"left-top",at:"left-top",offsetX:"calc(100vw - 22em)",offsetY:"33%"}),this.panelGamestates2.resize({width:"22em",height:"33%"}),this.panelCanvas2.reposition({my:"left-top",at:"left-top",offsetX:"calc(18em + 310px)",offsetY:"0"}),this.panelCanvas2.resize({width:"310px",height:"calc(250px + 4.5em)"}),this.panelLog2.reposition({my:"left-top",at:"left-top",offsetX:"20em",offsetY:"calc(250px + 4.5em + 2em)"}),this.panelLog2.resize({width:"calc(100vw - 40em - 4em)",height:"calc(100vh - 250px - 4.5em - 4em)"}),this.panelGamestatesS.reposition({my:"left-top",at:"left-top",offsetX:"calc(100vw - 22em)",offsetY:"66%"}),this.panelGamestatesS.resize({width:"22em",height:"33%"}),this.panelCanvasS.reposition({my:"left-top",at:"left-top",offsetX:"calc(18em + 620px)",offsetY:"0"}),this.panelCanvasS.resize({width:"310px",height:"calc(250px + 4.5em)"}),this.panelLogS.reposition({my:"left-top",at:"left-top",offsetX:"22em",offsetY:"calc(250px + 4.5em + 4em)"}),this.panelLogS.resize({width:"calc(100vw - 40em - 4em)",height:"calc(100vh - 250px - 4.5em - 4em)"})),this.panelGamestates1.front(),this.panelGamestates2.front(),this.panelGamestatesS.front(),this.panelLog1.front(),this.panelLog2.front(),this.panelLogS.front(),this.panelCanvas1.front(),this.panelCanvas2.front(),this.panelCanvasS.front()}saveFile(e,t){const s=new Date,i=a.exports.createWriteStream(`${s.getFullYear()}${s.getMonth()}${s.getDate()}${s.getHours()}${s.getMinutes()}${s.getSeconds()}-${e}.log`).getWriter(),o=(new TextEncoder).encode(t);i.write(o),i.close()}showError(e,t){n.create({dragit:!1,resizeit:!1,headerControls:"closeonly  xs",position:"center-top 0 15 down",contentSize:"330 auto",content:`<p>${t}</p>`,theme:"warning filled",headerTitle:`${e}`})}bootstrapAngular(){r.module("app",[]).controller("mainCtrl",["$scope","$timeout",(e,t)=>{e.info={showSpinner:!1,btnStopEnabled:!1,btnPlayEnabled:!0,btnSaveEnabled:!0,playing:!1,tick:w.network.tickMs,netcodes:w.netcodes,algorithm:w.netcodes[0],latency1:{min:w.network.minLatency1,max:w.network.maxLatency1},packetLoss1:w.network.packetLoss1,latency2:{min:w.network.minLatency2,max:w.network.maxLatency2},packetLoss2:w.network.packetLoss2,npcs:0,realtimeGameStates:!0,realtimeLogs:!1,interpolation:!0,debugBoxes:!0,syncScrollGs1:!0,syncScrollGs2:!0,syncScrollGsS:!0,syncScrollLog1:!0,syncScrollLog2:!0,syncScrollLogS:!0,logsPlayer1:[],logsPlayer2:[],logsServer:[],gamestatesPlayer1:[],gamestatesPlayer2:[],gamestatesServer:[]};const s="p2p"===e.info.algorithm.type;this.p2pmode=s,this.resetLayout(),e.resetLayout=()=>{this.resetLayout()};const i=document.getElementById("player1GameStates"),o=document.getElementById("player2GameStates"),n=document.getElementById("serverGameStates");r.element(i.parentElement).bind("scroll",(()=>{e.info.syncScrollGs1&&(e.info.syncScrollGs2&&(o.parentElement.scrollTop=i.parentElement.scrollTop),e.info.syncScrollGsS&&(n.parentElement.scrollTop=i.parentElement.scrollTop))})),r.element(o.parentElement).bind("scroll",(()=>{e.info.syncScrollGs2&&(e.info.syncScrollGs1&&(i.parentElement.scrollTop=o.parentElement.scrollTop),e.info.syncScrollGsS&&(n.parentElement.scrollTop=o.parentElement.scrollTop))})),r.element(n.parentElement).bind("scroll",(()=>{e.info.syncScrollGsS&&(e.info.syncScrollGs1&&(i.parentElement.scrollTop=n.parentElement.scrollTop),e.info.syncScrollGs2&&(o.parentElement.scrollTop=n.parentElement.scrollTop))}));const a=document.getElementById("player1Logs"),l=document.getElementById("player2Logs"),h=document.getElementById("serverLogs");r.element(a.parentElement).bind("scroll",(()=>{e.info.syncScrollLog1&&(e.info.syncScrollLog2&&(l.parentElement.scrollTop=a.parentElement.scrollTop),e.info.syncScrollLogS&&(h.parentElement.scrollTop=a.parentElement.scrollTop))})),r.element(l.parentElement).bind("scroll",(()=>{e.info.syncScrollLog2&&(e.info.syncScrollLog1&&(a.parentElement.scrollTop=l.parentElement.scrollTop),e.info.syncScrollLogS&&(h.parentElement.scrollTop=l.parentElement.scrollTop))})),r.element(h.parentElement).bind("scroll",(()=>{e.info.syncScrollLogS&&(e.info.syncScrollLog1&&(a.parentElement.scrollTop=h.parentElement.scrollTop),e.info.syncScrollLog2&&(l.parentElement.scrollTop=h.parentElement.scrollTop))})),this.deviceServer.deviceUpdatedEmitter.addEventListener((()=>{(e.info.realtimeGameStates||e.info.realtimeLogs)&&e.$apply()})),this.devicePlayer1.deviceUpdatedEmitter.addEventListener((()=>{(e.info.realtimeGameStates||e.info.realtimeLogs)&&e.$apply()})),this.devicePlayer2.deviceUpdatedEmitter.addEventListener((()=>{(e.info.realtimeGameStates||e.info.realtimeLogs)&&e.$apply()}));const m='<button class="jsPanel-btn jsPanel-btn-menu jsPanel-btn-md tooltip bottom" aria-label="Sync scroll"><span class="fas fa-arrows-alt-v toolbar-icon" style="vertical-align: text-top"></span><input type="checkbox" checked /></button>',d='<button class="jsPanel-btn jsPanel-btn-menu jsPanel-btn-md tooltip bottom" aria-label="Download"><span class="fas fa-download toolbar-icon"></span></button>';this.panelGamestates1.addControl({html:m,name:"sync",position:1,handler:()=>{e.info.syncScrollGs1=!e.info.syncScrollGs1}}),this.panelGamestates1.addControl({html:d,name:"download",position:2,handler:()=>{e.saveGamestates1()}}),this.panelGamestates2.addControl({html:m,name:"sync",position:1,handler:()=>{e.info.syncScrollGs2=!e.info.syncScrollGs2}}),this.panelGamestates2.addControl({html:d,name:"download",position:2,handler:()=>{e.saveGamestates2()}}),this.panelGamestatesS.addControl({html:m,name:"sync",position:1,handler:()=>{e.info.syncScrollGsS=!e.info.syncScrollGsS}}),this.panelGamestatesS.addControl({html:d,name:"download",position:2,handler:()=>{e.saveGamestatesS()}}),this.panelLog1.addControl({html:m,name:"sync",position:1,handler:()=>{e.info.syncScrollLog1=!e.info.syncScrollLog1}}),this.panelLog1.addControl({html:d,name:"download",position:2,handler:()=>{e.saveLogs1()}}),this.panelLog2.addControl({html:m,name:"sync",position:1,handler:()=>{e.info.syncScrollLog2=!e.info.syncScrollLog2}}),this.panelLog2.addControl({html:d,name:"download",position:2,handler:()=>{e.saveLogs2()}}),this.panelLogS.addControl({html:m,name:"sync",position:1,handler:()=>{e.info.syncScrollLogS=!e.info.syncScrollLogS}}),this.panelLogS.addControl({html:d,name:"download",position:2,handler:()=>{e.saveLogsS()}}),e.changeAlgorithm=()=>{if("custom"===e.info.algorithm.type)return;const t="p2p"===e.info.algorithm.type;t!==this.p2pmode&&(this.p2pmode=t,this.resetLayout())},e.stop=()=>{e.info.showSpinner=!0,t((()=>{this.deviceServer.stop(),this.devicePlayer1.stop(),this.devicePlayer2.stop(),e.info.btnStopEnabled=!1,e.info.btnPlayEnabled=!0,e.info.playing=!1,t((()=>{e.info.showSpinner=!1}))}))},e.play=async()=>{if("custom"===e.info.algorithm.type){if(!e.info.algorithmUrl)return void this.showError("Loading algorithm","Empty Algorithm URL");const o=await fetch(e.info.algorithmUrl),n=await o.text();try{window.currentTimestamp=k,window.BaseNetCode=O,window.Command=G,window.CommandMessage=z,window.GameStateMessage=Y;const{type:i,name:o,ClientNetCode:a,ServerNetCode:r}=await(t=()=>import(`data:text/javascript;charset=utf-8,${encodeURIComponent(n)}`),s=[],s&&0!==s.length?Promise.all(s.map((e=>{if((e=`/netcode-workbench/${e}`)in c)return;c[e]=!0;const t=e.endsWith(".css"),s=t?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${e}"]${s}`))return;const i=document.createElement("link");return i.rel=t?"stylesheet":"modulepreload",t||(i.as="script",i.crossOrigin=""),i.href=e,document.head.appendChild(i),t?new Promise(((e,t)=>{i.addEventListener("load",e),i.addEventListener("error",t)})):void 0}))).then((()=>t())):t()),l=new v(o,i);this.p2pmode="p2p"===i,this.resetLayout(),this.p2pmode?e.internalPlay(l,a,null):e.internalPlay(l,a,r)}catch(i){this.showError("Loading algorithm",i)}}else e.internalPlay(e.info.algorithm,null,null);var t,s},e.internalPlay=(t,s,i)=>{this.deviceServer.reset(),this.devicePlayer1.reset(),this.devicePlayer2.reset(),"p2p"===t.type?(this.devicePlayer1.connect(this.devicePlayer2,e.info.latency1.min,e.info.latency1.max,e.info.packetLoss1,e.info.latency2.min,e.info.latency2.max,e.info.packetLoss2),this.devicePlayer1.play(t,s,e.info.tick,e.info.npcs,!0,e.info.interpolation,e.info.debugBoxes),this.devicePlayer2.play(t,s,e.info.tick,e.info.npcs,!0,e.info.interpolation,e.info.debugBoxes)):(this.devicePlayer1.connect(this.deviceServer,e.info.latency1.min,e.info.latency1.max,e.info.packetLoss1,e.info.latency1.min,e.info.latency1.max,e.info.packetLoss1),this.devicePlayer2.connect(this.deviceServer,e.info.latency2.min,e.info.latency2.max,e.info.packetLoss2,e.info.latency2.min,e.info.latency2.max,e.info.packetLoss2),this.deviceServer.play(t,i,e.info.tick,e.info.npcs,!0,!1,!1),this.devicePlayer1.play(t,s,e.info.tick,e.info.npcs,!1,e.info.interpolation,e.info.debugBoxes),this.devicePlayer2.play(t,s,e.info.tick,e.info.npcs,!1,e.info.interpolation,e.info.debugBoxes)),e.info.btnStopEnabled=!0,e.info.btnPlayEnabled=!1,e.info.playing=!0,e.info.gamestatesServer=this.deviceServer.gameStateHistory,e.info.gamestatesPlayer1=this.devicePlayer1.gameStateHistory,e.info.gamestatesPlayer2=this.devicePlayer2.gameStateHistory,e.info.logsServer=this.deviceServer.log.traces,e.info.logsPlayer1=this.devicePlayer1.log.traces,e.info.logsPlayer2=this.devicePlayer2.log.traces},e.changeInterpolation=()=>{this.devicePlayer1.interpolation=e.info.interpolation,this.devicePlayer2.interpolation=e.info.interpolation},e.changeDebugBoxes=()=>{this.devicePlayer1.debugBoxes=e.info.debugBoxes,this.devicePlayer2.debugBoxes=e.info.debugBoxes},e.saveAll=()=>{let t=`\n--------------------\nPLAYER 1 GAME STATES\n--------------------\n${this.devicePlayer1.gameStateHistoryLog()}\n-------------\nPLAYER 1 LOGS\n-------------\n${this.devicePlayer1.log}\n\n--------------------\nPLAYER 2 GAME STATES\n--------------------\n${this.devicePlayer2.gameStateHistoryLog()}\n-------------\nPLAYER 2 LOGS\n-------------\n${this.devicePlayer2.log}`;"p2p"!==e.info.algorithm.type&&(t+=`-----------------\nSERVER GAME STATES\n------------------\n${this.deviceServer.gameStateHistoryLog()}\n-----------\nSERVER LOGS\n-----------\n${this.deviceServer.log}`),this.saveFile(e.info.algorithm.name,t)},e.saveGamestates1=()=>{this.saveFile(`${e.info.algorithm.name}-p1-states`,this.devicePlayer1.gameStateHistoryLog())},e.saveLogs1=()=>{this.saveFile(`${e.info.algorithm.name}-p1-logs`,this.devicePlayer1.log.toString())},e.saveGamestates2=()=>{this.saveFile(`${e.info.algorithm.name}-p2-states`,this.devicePlayer2.gameStateHistoryLog())},e.saveLogs2=()=>{this.saveFile(`${e.info.algorithm.name}-p2-logs`,this.devicePlayer2.log.toString())},e.saveGamestatesS=()=>{this.saveFile(`${e.info.algorithm.name}-srv-states`,this.deviceServer.gameStateHistoryLog())},e.saveLogsS=()=>{this.saveFile(`${e.info.algorithm.name}-srv-logs`,this.deviceServer.log.toString())}}])}}).build();
