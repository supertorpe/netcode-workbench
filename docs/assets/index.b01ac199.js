var e=Object.defineProperty,t=(t,i,s)=>(((t,i,s)=>{i in t?e(t,i,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[i]=s})(t,"symbol"!=typeof i?i+"":i,s),s);export function __vite_legacy_guard(){import("data:text/javascript,")}import{x as i,l as s,f as o,t as n,e as a,d as r,p as c,u as l,j as h,S as m,a as d,b as p}from"./vendor.e1363f84.js";!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver((e=>{for(const i of e)if("childList"===i.type)for(const e of i.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)})).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerpolicy&&(t.referrerPolicy=e.referrerpolicy),"use-credentials"===e.crossorigin?t.credentials="include":"anonymous"===e.crossorigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();const g={};var f={canvas:{width:300,height:250},network:{tickMs:50,minLatency1:10,maxLatency1:30,packetLoss1:0,minLatency2:10,maxLatency2:30,packetLoss2:0},serializers:[{name:"json"},{name:"cbor-x"},{name:"msgpackr"}],netcodes:[{name:"p2p-naive",type:"p2p"},{name:"p2p-delayed",type:"p2p"},{name:"cs-lockstep",type:"cs"},{name:"custom",type:"custom"}],players:[{id:1,color:"#483D8B",x:10,y:10,size:20,keyUp:87,keyDown:83,keyLeft:65,keyRight:68},{id:2,color:"#6B8E23",x:270,y:220,size:20,keyUp:38,keyDown:40,keyLeft:37,keyRight:39}],coin:{color:"orange",x:150,y:125,size:10},npc:{color:"black"},border:{color:"#708090"},physics:{worldScale:30,strength:10,borderThickness:5}};const u=0,y=1,S=2,v=10,w=20,k=11,x=21,E=12,_=22;class L{constructor(e,t){this.name=e,this.type=t}}const C=f;class P{constructor(){t(this,"_listeners",[])}addEventListener(e){this._listeners.includes(e)||this._listeners.push(e)}removeEventListener(e){const t=this._listeners.indexOf(e);-1!==t&&this._listeners.splice(t,1)}removeListeners(){this._listeners=[]}notify(e){this._listeners.forEach((t=>{t(e)}))}}const T=(e,t)=>Math.floor(Math.random()*(t-e+1)+e),I=()=>(new Date).getTime();class b{constructor(e){t(this,"xorshift"),this.xorshift=new i.exports.XorShift(e)}randomInt(e,t){return Math.floor(e+this.xorshift.random()*(t-e))}}var D,z;(z=D||(D={})).INFO="INFO",z.WARN="WARN",z.ERROR="ERROR";const G=class{constructor(e,i,s){t(this,"_id"),this.level=e,this.timestamp=i,this.text=s,this._id=G.idCounter++}get id(){return this._id}toString(){const e=new Date;return e.setTime(this.timestamp),`${e.getHours().toString().padStart(2,"0")}:${e.getMinutes().toString().padStart(2,"0")}:${e.getSeconds().toString().padStart(2,"0")}.${e.getMilliseconds().toString().padStart(3,"0")} ${this.level.padEnd(5)} ${this.text}`}};let $=G;t($,"idCounter",0);class B{constructor(){t(this,"_traces",[])}get traces(){return this._traces}log(e,t){this._traces.unshift(new $(e,I(),t))}logInfo(e){this.log(D.INFO,e)}logWarn(e){this.log(D.WARN,e)}logError(e){this.log(D.ERROR,e)}clear(){this._traces=[]}toString(){const e=this._traces.reverse().join("\n");return this._traces.reverse(),e}}class R{constructor(e,t){this.timestamp=e,this.size=t}}class O{constructor(){t(this,"timeIncoming",0),t(this,"sizeIncoming",0),t(this,"timeOutgoing",0),t(this,"sizeOutgoing",0),t(this,"latestTimeIncomingNotified",0),t(this,"latestTimeOutgoingNotified",0),t(this,"_outgoingEmitter",new P),t(this,"_incomingEmitter",new P)}get outgoingEmitter(){return this._outgoingEmitter}get incomingEmitter(){return this._incomingEmitter}logOut(e,t){const i=Math.floor(e/1e3);0===this.timeOutgoing&&(this.timeOutgoing=i),this.timeOutgoing!==i?(this.latestTimeOutgoingNotified=this.timeOutgoing,this._outgoingEmitter.notify(new R(this.timeOutgoing,this.sizeOutgoing)),this.timeOutgoing=i,this.sizeOutgoing=t):this.sizeOutgoing+=t}logIn(e,t){const i=Math.floor(e/1e3);0===this.timeIncoming&&(this.timeIncoming=i),this.timeIncoming!==i?(this.latestTimeIncomingNotified=this.timeIncoming,this._incomingEmitter.notify(new R(this.timeIncoming,this.sizeIncoming)),this.timeIncoming=i,this.sizeIncoming=t):this.sizeIncoming+=t}flush(){this.latestTimeOutgoingNotified!==this.timeOutgoing&&this._outgoingEmitter.notify(new R(this.timeOutgoing,this.sizeOutgoing)),this.latestTimeIncomingNotified!==this.timeIncoming&&this._incomingEmitter.notify(new R(this.timeIncoming,this.sizeIncoming)),this.timeIncoming=0,this.sizeIncoming=0,this.timeOutgoing=0,this.sizeOutgoing=0,this.latestTimeIncomingNotified=0,this.latestTimeOutgoingNotified=0}removeListeners(){this._outgoingEmitter.removeListeners(),this._incomingEmitter.removeListeners()}}class M{constructor(){t(this,"_trafficlog",new O),t(this,"connections",[]),t(this,"_connectionEmitter",new P),t(this,"_disconnectionEmitter",new P),t(this,"_messageSentEmitter",new P),t(this,"_messageReceivedEmitter",new P)}get trafficLog(){return this._trafficlog}get connectionCount(){return this.connections.length}get connectionEmitter(){return this._connectionEmitter}get disconnectionEmitter(){return this._disconnectionEmitter}get messageSentEmitter(){return this._messageSentEmitter}get messageReceivedEmitter(){return this._messageReceivedEmitter}connect(e,t){this.attachListeners(e),this.connections.push(e),e.connect(t)}attachListeners(e){e.connectionEmitter.addEventListener((e=>{this._connectionEmitter.notify(e)})),e.disconnectionEmitter.addEventListener((e=>{this._disconnectionEmitter.notify(e)})),e.messageReceivedEmitter.addEventListener((e=>{this._messageReceivedEmitter.notify(e)})),e.messageSentEmitter.addEventListener((e=>{this._messageSentEmitter.notify(e)}))}findConnection(e){return this.connections.find((t=>t.peer.peerId===e))}closeConnections(){this.connections.forEach((e=>{e.close(),e.removeListeners()})),this.connections=[]}removeListeners(){this._connectionEmitter.removeListeners(),this._disconnectionEmitter.removeListeners(),this._messageSentEmitter.removeListeners(),this._messageReceivedEmitter.removeListeners()}broadcast(e){this.connections.forEach((t=>{t.send(e)}))}send(e,t){var i;null==(i=this.findConnection(e))||i.send(t)}}class N{constructor(e,i,s,o){t(this,"_closed",!0),t(this,"_peer"),t(this,"_minLatency",0),t(this,"_maxLatency",0),t(this,"_packetLoss",0),t(this,"_totalSent",0),t(this,"_totalLost",0),t(this,"_connectionEmitter",new P),t(this,"_disconnectionEmitter",new P),t(this,"_messageSentEmitter",new P),t(this,"_messageReceivedEmitter",new P),this.intf=e,this.peerId=i,this.log=s,this.serializer=o}get connectionEmitter(){return this._connectionEmitter}get disconnectionEmitter(){return this._disconnectionEmitter}get messageSentEmitter(){return this._messageSentEmitter}get messageReceivedEmitter(){return this._messageReceivedEmitter}get peer(){return this._peer}set minLatency(e){this._minLatency=e}set maxLatency(e){this._maxLatency=e}set packetLoss(e){this._packetLoss=e}connect(e){this._peer=e,this._connectionEmitter.notify(e),this._closed=!1}send(e){if(this._closed)return;if(e.timestampOrigin=I(),e.origin=this.peerId,e.destination=this._peer.peerId,this._packetLoss>0&&this._totalLost+1<this._totalSent*this._packetLoss/100)return this.log.logWarn(`Message for tick ${e.tick} lost`),void this._totalLost++;this._totalSent++;const t=this.serializer.encode(e);this.intf.trafficLog.logOut(e.timestampOrigin,t.byteLength),this._messageSentEmitter.notify(e),0===this.maxLatency?this._peer.receive(t):setTimeout((()=>{this._peer.receive(t)}),T(this._minLatency,this._maxLatency))}receive(e){if(this._closed)return;const t=this.serializer.decode(e);t.timestampDestination=I(),this.intf.trafficLog.logIn(t.timestampDestination,e.byteLength),this._messageReceivedEmitter.notify(t)}close(){this._closed=!0,this._disconnectionEmitter.notify(this._peer)}removeListeners(){this._connectionEmitter.removeListeners(),this._disconnectionEmitter.removeListeners(),this._messageSentEmitter.removeListeners(),this._messageReceivedEmitter.removeListeners()}}class U{constructor(e,t,i){this.tick=e,this.playerId=t,this.value=i}}class Y{static clone(e,t){return new U(e.tick+(t?1:0),e.playerId,e.value)}static cloneArray(e){return e.map((e=>Y.clone(e,!1)))}static toString(e){return`P${e.playerId}:${e.value}`}static arrayToString(e){let t="";return e.forEach((e=>{t+=`P${e.playerId}:${e.value} `})),t}static toFullString(e){return`tick ${e.tick} P${e.playerId}:${e.value}`}static arrayToFullString(e){let t="";return e.forEach((e=>{t+=`[tick ${e.tick} P${e.playerId}:${e.value}] `})),t}}class X{constructor(e,t,i,s){this.id=e,this.x=t,this.y=i,this.score=s}toString(){return`P${this.id} x=${this.x} y=${this.y} score=${this.score}`}}class A{constructor(e,t){this.playerId=e,this.value=t}toString(){return`P${this.playerId}:${this.value}`}}class W{constructor(e,t,i){this.tick=e,this.players=t,this.commands=i}toString(){return`tick: ${this.tick}\n  ${this.players.join("\n  ")}\n  ${this.commands.length>0?"Commands:":""} ${this.commands.join(" ")}`}}class F{constructor(e,t){this.tick=e,this.commands=t}}const H=class{constructor(e,i,s){t(this,"kind",H.KIND_UNDEFINED),t(this,"timestampOrigin"),t(this,"timestampDestination"),this.tick=e,this.origin=i,this.destination=s}};let j=H;t(j,"KIND_COMMAND","CMD"),t(j,"KIND_GAMESTATE","GST"),t(j,"KIND_UNDEFINED","");class V extends j{constructor(e,i,s){super(e.tick,i,s),t(this,"command"),this.kind=j.KIND_COMMAND,this.command=e}}class K extends j{constructor(e,i,s){super(e.tick,i,s),t(this,"gameState"),this.kind=j.KIND_GAMESTATE,this.gameState=e}}class q{constructor(e,t,i,s,o,n,a,r,c){this.id=e,this.isStatic=t,this.posX=i,this.posY=s,this.velX=o,this.velY=n,this.width=a,this.height=r,this.color=c}}class J extends F{constructor(e,t,i,s){super(e,t),this.tick=e,this.commands=t,this.bodies=i,this.scores=s}}class Q{static bodyFromPlayer(e,t){return e.bodies.find((e=>e.id===t))}static toString(e){let t="";return e.bodies.forEach((e=>{e.isStatic||(t+=`    P${e.id} x=${e.posX*C.physics.worldScale} y=${e.posY*C.physics.worldScale}\n`)})),`\nGameState tick: ${e.tick}\n  bodies:\n${t}  ${e.commands.length>0?"commands    ":""}${Y.arrayToString(e.commands)}`}static clone(e){const t=[];e.bodies.forEach((e=>{t.push(class{static clone(e){return new q(e.id,e.isStatic,e.posX,e.posY,e.velX,e.velY,e.width,e.height,e.color)}}.clone(e))}));return new J(e.tick,Y.cloneArray(e.commands),e.bodies,[...e.scores])}static toLog(e){const t=[];e.bodies.forEach((i=>{i.isStatic||t.push(new X(i.id,i.posX*C.physics.worldScale,i.posY*C.physics.worldScale,e.scores[i.id-1]))})),t.sort(((e,t)=>e.id>t.id?1:-1));const i=[];return e.commands.forEach((e=>{i.push(new A(e.playerId,e.value))})),i.sort(((e,t)=>e.playerId>t.playerId?1:-1)),new W(e.tick,t,i)}}class Z extends F{constructor(e,t,i,s,o,n){super(e,t),this.tick=e,this.commands=t,this.world=i,this.bodies=s,this.scores=o,this.playerWhoCollectedTheCoin=n}}class ee extends class{static incTick(e){e.tick++}static commandFromPlayer(e,t){return e.commands.find((e=>e.playerId===t))}static clearCommands(e){e.commands=[]}}{static extractBodies(e){const t=[];for(let i=e.getBodyList();i;i=i.getNext())t.unshift(i);return t}static bodyFromPlayer(e,t){return e.bodies.find((e=>e.getUserData().id===t))}static toString(e){let t="";return e.bodies.forEach((i=>{if(!i.isStatic()&&i.getUserData()){const s=i.getUserData().id;t+=`    P${s} x=${i.getPosition().x*C.physics.worldScale} y=${i.getPosition().y*C.physics.worldScale} ${s<3?"score="+e.scores[s-1]:""}\n`}})),`\nGameState tick: ${e.tick}\n  bodies:\n${t}  ${e.commands.length>0?"commands:":""}\n    ${Y.arrayToString(e.commands)}`}static toLog(e){const t=[];e.bodies.forEach((i=>{if(!i.isStatic()&&i.getUserData()){let s=i.getUserData();t.push(new X(s.id,i.getPosition().x*C.physics.worldScale,i.getPosition().y*C.physics.worldScale,e.scores[s.id-1]))}})),t.sort(((e,t)=>e.id>t.id?1:-1));const i=[];return e.commands.forEach((e=>{i.push(new A(e.playerId,e.value))})),i.sort(((e,t)=>e.playerId>t.playerId?1:-1)),new W(e.tick,t,i)}static buildSimpleGameState(e){const t=[];return e.bodies.forEach((e=>{if(!e.isStatic()){let i=e.getUserData();const s=new q(i.id,!1,e.getPosition().x,e.getPosition().y,e.getLinearVelocity().x,e.getLinearVelocity().y,i.size,i.size,i.color);t.push(s)}if(e.isStatic()){const i=new q(-1,!0,e.getPosition().x,e.getPosition().y,e.getLinearVelocity().x,e.getLinearVelocity().y,e.getUserData().width,e.getUserData().height,e.getUserData().color);t.push(i)}})),new J(e.tick,[],t,[...e.scores])}}class te{constructor(e,i,s){t(this,"_gameState"),t(this,"_startTime"),t(this,"_tickMs"),t(this,"_currentTick"),this.log=e,this.net=i,this.gameStateMachine=s,this._startTime=0,this._tickMs=50,this._currentTick=0,this.net.messageReceivedEmitter.addEventListener((e=>{e.kind===j.KIND_COMMAND?this.remoteCommandReceived(e.command):e.kind===j.KIND_GAMESTATE?this.gameStateReceived(e.gameState):this.log.logError(`Unknown message received: ${e}`)}))}get tickMs(){return this._tickMs}set tickMs(e){this._tickMs=e}get currentTick(){return this._currentTick}start(e){return this._startTime=I(),this._currentTick=0,e&&(this._gameState=e),this._startTime}tickBasedOnTime(){return Math.floor((I()-this._startTime)/this._tickMs)}tickTime(e){return this._startTime+e*this.tickMs}}class ie extends te{constructor(){super(...arguments),t(this,"localCommandTick",-1),t(this,"lastTickReturned",-1)}tick(){let e=null;return this.lastTickReturned<this._currentTick&&this._gameState&&(this.lastTickReturned=this._currentTick,this.log.logInfo(Q.toString(this._gameState)),e=Q.toLog(this._gameState)),e}localCommandReceived(e,t){if(this.localCommandTick<this._currentTick){this.localCommandTick=this._currentTick;const i=new U(this._currentTick,e,t);this.log.logInfo(`sending local command: ${Y.toFullString(i)}`),this.net.broadcast(new V(i))}}remoteCommandReceived(e){throw new Error("CSLockstepClientNetCode: does not support receiving remote commands")}gameStateReceived(e){this.log.logInfo(`received gamestate: ${Q.toLog(this._gameState)}`),e.tick<this._currentTick?this.log.logInfo(`ignoring old gamestate: ${e.tick}`):(this._gameState=e,this._currentTick=e.tick)}getGameStateToRender(){return this._gameState}getGameState(e){return this._gameState.tick===e?this._gameState:null}}class se extends te{constructor(){super(...arguments),t(this,"initialGameStateSent",!1),t(this,"remoteCommands",[])}tick(){let e=null;if(!this.initialGameStateSent){this.initialGameStateSent=!0;const t=ee.buildSimpleGameState(this._gameState);this.log.logInfo(`sending gamestate: ${Q.toLog(t)}`),this.net.broadcast(new K(t)),e=ee.toLog(this._gameState)}if(this.tickBasedOnTime()>this._currentTick){let t=0;const i=this.remoteCommands.length;for(let e=0;e<i;e++){let i=this.remoteCommands[e-t];i&&i.tick===this._currentTick&&(this._gameState.commands.push(i),this.remoteCommands.splice(e-t++,1))}if(this._gameState.commands.length<this.net.connectionCount)this.log.logWarn(`Waiting commands for tick ${this._currentTick}: ${this._gameState.commands.length} of ${this.net.connectionCount}`);else{this._gameState.commands.sort(((e,t)=>e.playerId>t.playerId?1:-1)),this.log.logInfo(ee.toString(this._gameState)),e=ee.toLog(this._gameState),this.gameStateMachine.compute(this._gameState),this._currentTick++,ee.incTick(this._gameState),ee.clearCommands(this._gameState);const t=ee.buildSimpleGameState(this._gameState);this.log.logInfo(`sending gamestate: ${Q.toLog(t)}`),this.net.broadcast(new K(t))}}return e}localCommandReceived(e,t){throw new Error("CSLockstepServerNetCode: does not support receiving local commands")}remoteCommandReceived(e){this.log.logInfo(`received command: ${Y.toFullString(e)}`),this.remoteCommands.push(e)}gameStateReceived(e){throw new Error("CSLockstepServerNetCode: does not support receiving game states")}getGameStateToRender(){return this._gameState}getGameState(e){return this._gameState.tick===e?this._gameState:null}}class oe extends te{constructor(){super(...arguments),t(this,"localCommand"),t(this,"localCommandDumped",!1),t(this,"remoteCommands",[])}start(e){return super.start(e)}tick(){let e=null;if(this.tickBasedOnTime()>this._currentTick){!this.localCommandDumped&&this.localCommand&&(this.localCommandDumped=!0,this._gameState.commands.push(this.localCommand));let t=0;const i=this.remoteCommands.length;for(let e=0;e<i;e++){let i=this.remoteCommands[e-t];i&&i.tick===this._currentTick&&(this._gameState.commands.push(i),this.remoteCommands.splice(e-t++,1))}this._gameState.commands.length<this.net.connectionCount+1?this.log.logWarn(`Waiting commands for tick ${this._currentTick}: ${this._gameState.commands.length} of ${this.net.connectionCount+1}`):(this._gameState.commands.sort(((e,t)=>e.playerId>t.playerId?1:-1)),this.log.logInfo(ee.toString(this._gameState)),e=ee.toLog(this._gameState),this.gameStateMachine.compute(this._gameState),this._currentTick++,ee.incTick(this._gameState),ee.clearCommands(this._gameState),this.localCommand=void 0,this.localCommandDumped=!1)}return e}localCommandReceived(e,t){if(!this.localCommand){const i=new U(this._currentTick,e,t);this.localCommand=i,this.log.logInfo(`sending local command: ${Y.toFullString(i)}`),this.net.broadcast(new V(i))}}remoteCommandReceived(e){this.log.logInfo(`received command: ${Y.toFullString(e)}`),this.remoteCommands.push(e)}gameStateReceived(e){throw new Error("P2PNaiveNetCode: Method not implemented.")}getGameStateToRender(){return this._gameState}getGameState(e){return this._gameState.tick===e?this._gameState:null}}class ne extends te{constructor(){super(...arguments),t(this,"localCommand"),t(this,"localCommandDumped",!1),t(this,"remoteCommands",[]),t(this,"prevGameState")}start(e){return this.prevGameState=e,super.start(e)}tick(){let e=null;if(this.tickBasedOnTime()>this._currentTick){!this.localCommandDumped&&this.localCommand&&(this.localCommandDumped=!0,this._gameState.commands.push(this.localCommand));let t=0;const i=this.remoteCommands.length;for(let e=0;e<i;e++){let i=this.remoteCommands[e-t];i&&i.tick===this._currentTick&&(this._gameState.commands.push(i),this.remoteCommands.splice(e-t++,1))}if(this._gameState.commands.length<this.net.connectionCount+1)this.log.logWarn(`Waiting commands for tick ${this._currentTick}: ${this._gameState.commands.length} of ${this.net.connectionCount+1}`);else{this._gameState.commands.sort(((e,t)=>e.playerId>t.playerId?1:-1));const t=this._gameState;this.log.logInfo(ee.toString(t)),e=ee.toLog(t),this.prevGameState=this.gameStateMachine.clone(t),this.gameStateMachine.compute(this._gameState),this._currentTick++,ee.incTick(this._gameState),ee.clearCommands(this._gameState),this.localCommand=void 0,this.localCommandDumped=!1}}return e}localCommandReceived(e,t){if(!this.localCommand){const i=new U(this._currentTick,e,t);this.localCommand=i,this.log.logInfo(`sending local command: ${Y.toFullString(i)}`),this.net.broadcast(new V(i))}}remoteCommandReceived(e){this.log.logInfo(`received command: ${Y.toFullString(e)}`),this.remoteCommands.push(e)}gameStateReceived(e){throw new Error("P2PDelayedNetCode: Method not implemented.")}getGameStateToRender(){return this.prevGameState?this.prevGameState:this._gameState}getGameState(e){return this._gameState.tick===e?this._gameState:this.prevGameState&&this.prevGameState.tick===e?this.prevGameState:null}}class ae{constructor(){}static build(e,t,i,s){switch(e){case"p2p-naive":return t.logInfo("Using p2p-naive netcode"),new oe(t,i,s);case"p2p-delayed":return t.logInfo("Using p2p-delayed netcode"),new ne(t,i,s);case"cs-lockstep-client":return t.logInfo("Using cs-lockstep-client netcode"),new ie(t,i,s);case"cs-lockstep-server":return t.logInfo("Using cs-lockstep-server netcode"),new se(t,i,s);default:return t.logInfo(`Netcode ${e} not found`),null}}static buildFromClass(e,t,i,s){return new e(t,i,s)}}class re{constructor(e,t,i,s,o,n){this.log=e,this.step=t,this.canvasWidth=i,this.canvasHeight=s,this.npcs=o,this.randomizer=n}buildInitialGameState(){const e=this.createPlanckWorld(),t=ee.extractBodies(e),i=new Z(0,[],e,t,new Array(C.players.length).fill(0),void 0);return this.attachWorldEvents(i),i}compute(e){const t=e;if(t.playerWhoCollectedTheCoin){t.scores[t.playerWhoCollectedTheCoin-1]+=10;const e=this.randomizer.randomInt(10,290),i=this.randomizer.randomInt(10,240),o=t.bodies.find((e=>e.getUserData()&&e.getUserData().isCoin));o&&o.setPosition(s.Vec2(e/C.physics.worldScale,i/C.physics.worldScale)),t.playerWhoCollectedTheCoin=void 0}for(let i of t.commands){if(!i||i.value===u)continue;const e=t.bodies.find((e=>(e.getUserData()?e.getUserData().id:-1)==i.playerId));if(e){const t=i.value==w||i.value==_||i.value==x?C.physics.strength:i.value==v||i.value==E||i.value==k?-1*C.physics.strength:0,o=i.value==S||i.value==E||i.value==_?C.physics.strength:i.value==y||i.value==k||i.value==x?-1*C.physics.strength:0;this.log.logInfo(`apply command value ${i.value} to P${i.playerId}: force(x=${t} y=${o})`),e.applyForce(s.Vec2(t,o),e.getWorldCenter())}}t.world.step(this.step),t.world.clearForces()}attachWorldEvents(e){e.world.on("begin-contact",(t=>{if(e.playerWhoCollectedTheCoin)return;if(t.getFixtureB().getBody().getUserData().isCoin){const i=t.getFixtureA().getBody().getUserData();i.id<=2&&(e.playerWhoCollectedTheCoin=i.id)}}))}createPlanckStaticBody(e,t,i,o,n,a){const r=e.createBody({type:"static"});r.setUserData({width:o,height:n,color:a}),r.createFixture(s.Box(o/2/C.physics.worldScale,n/2/C.physics.worldScale)),r.setPosition(s.Vec2((t+o/2)/C.physics.worldScale,(i+n/2)/C.physics.worldScale))}createPlanckWorld(){const e=s.Vec2(0,0),t=s.World(e);this.createPlanckStaticBody(t,0,0,this.canvasWidth,C.physics.borderThickness,C.border.color),this.createPlanckStaticBody(t,0,this.canvasHeight-C.physics.borderThickness,this.canvasWidth,C.physics.borderThickness,C.border.color),this.createPlanckStaticBody(t,0,0,C.physics.borderThickness,this.canvasHeight,C.border.color),this.createPlanckStaticBody(t,this.canvasWidth-C.physics.borderThickness,0,C.physics.borderThickness,this.canvasHeight,C.border.color);const i={density:0,restitution:.4};C.players.forEach((e=>{const o=t.createBody({type:"dynamic",position:s.Vec2((e.x+e.size/2)/C.physics.worldScale,(e.y+e.size/2)/C.physics.worldScale),allowSleep:!1,awake:!0});o.createFixture(s.Box(e.size/2/C.physics.worldScale,e.size/2/C.physics.worldScale),i),o.setUserData(e)}));const o=t.createBody({type:"static"});o.createFixture(s.Box(C.coin.size/2/C.physics.worldScale,C.coin.size/2/C.physics.worldScale),{isSensor:!0}),o.setPosition(s.Vec2(C.coin.x/C.physics.worldScale,C.coin.y/C.physics.worldScale)),o.setUserData({isCoin:!0,width:C.coin.size,height:C.coin.size,color:C.coin.color});const n={density:0,restitution:1};let a=20;for(let r=0;r<this.npcs;r++){const e=t.createBody({type:"dynamic",position:s.Vec2((35+r*a+10+8*(10-this.npcs))/C.physics.worldScale,(35+r*a+10+8*(10-this.npcs))/C.physics.worldScale),allowSleep:!1,awake:!0});e.createFixture(s.Box(10/C.physics.worldScale,10/C.physics.worldScale),n),e.setUserData({id:100+r,size:a,color:C.npc.color})}return t}clone(e){const t=this.cloneWorld(e.world,e.bodies);this.attachWorldEvents(e);return new Z(e.tick,Y.cloneArray(e.commands),t,ee.extractBodies(t),[...e.scores],e.playerWhoCollectedTheCoin)}cloneWorld(e,t){const i=o(n(e)),s=[];for(let o=i.getBodyList();o;o=o.getNext())s.unshift(o);for(let[o,n]of s.entries())null!==n&&n.setUserData(t[o].getUserData());return i}}class ce{constructor(){}buildInitialGameState(){return new J(0,[],[],[])}compute(e){}}class le{constructor(){t(this,"encoder",new TextEncoder),t(this,"decoder",new TextDecoder)}encode(e){return this.encoder.encode(JSON.stringify(e))}decode(e){return JSON.parse(this.decoder.decode(e))}}class he{encode(e){return a(e)}decode(e){return r(new Uint8Array(e))}}class me{encode(e){return c(e)}decode(e){return l(new Uint8Array(e))}}class de{constructor(){}static build(e,t){switch(e){case"json":return t.logInfo("Using json serializer"),new le;case"cbor-x":return t.logInfo("Using cbor-x serializer"),new he;case"msgpackr":return t.logInfo("Using msgpackr serializer"),new me;default:return t.logInfo(`Serializer ${e} not found. Fallback to json serializer`),new le}}}class pe{constructor(e,i){t(this,"running",!1),t(this,"_log"),t(this,"_gameStateHistory"),t(this,"_networkInterface"),t(this,"_networkListenersAttached",!1),t(this,"_deviceUpdatedEmitter",new P),t(this,"netcode"),t(this,"gameStateMachine"),this.isServer=e,this.playerId=i,this._log=new B,this._networkInterface=new M,this._gameStateHistory=[]}get log(){return this._log}get trafficLog(){return this._networkInterface.trafficLog}get deviceUpdatedEmitter(){return this._deviceUpdatedEmitter}get gameStateHistory(){return this._gameStateHistory}init(){this._networkListenersAttached||(this._networkListenersAttached=!0,this._networkInterface.connectionEmitter.addEventListener((e=>{0===e.peerId?this.log.logInfo("Connected to Server"):this.log.logInfo(`Connected to Player ${e.peerId}`)})),this._networkInterface.disconnectionEmitter.addEventListener((e=>{0===e.peerId?this.log.logInfo("Disconnected from Server"):this.log.logInfo(`Disconnected from Player ${e.peerId}`)})))}connect(e,t,i,s,o,n,a,r){const c=new N(this._networkInterface,this.playerId,this._log,de.build(t,this.log));c.minLatency=i,c.maxLatency=s,c.packetLoss=o;const l=new N(e._networkInterface,e.playerId,e._log,de.build(t,e.log));l.minLatency=n,l.maxLatency=a,l.packetLoss=r,this._networkInterface.connect(c,l),e._networkInterface.connect(l,c)}reset(){this._log.clear(),this._gameStateHistory=[]}play(e){let t;if(this.gameStateMachine=e.usePlanck?new re(this._log,e.tickMs/1e3,e.width,e.height,e.npcs,new b(e.randomSeed)):new ce,null===e.netcodeClass){const i=e.algorithm.name+("cs"===e.algorithm.type?this.isServer?"-server":"-client":"");t=ae.build(i,this._log,this._networkInterface,this.gameStateMachine)}else t=ae.buildFromClass(e.netcodeClass,this.log,this._networkInterface,this.gameStateMachine);if(null===t)return;this.netcode=t,this.netcode.tickMs=e.tickMs;const i=this.gameStateMachine.buildInitialGameState();this.netcode.start(i),this.running=!0,window.requestAnimationFrame((()=>{this.gameLoop()}))}stop(){this.running=!1,this._networkInterface.trafficLog.flush(),this._networkInterface.trafficLog.removeListeners(),this._networkInterface.closeConnections(),this._networkInterface.removeListeners(),this._networkListenersAttached=!1}gameStateHistoryLog(){const e=this._gameStateHistory.reverse().join("\n");return this._gameStateHistory.reverse(),e}gameLoop(){this.running&&(window.requestAnimationFrame((()=>{this.gameLoop()})),this.update(),this.draw())}update(){try{let e=this.netcode.tick();null!=e&&this._gameStateHistory.unshift(e)}catch(e){this._log.logError(e)}this._deviceUpdatedEmitter.notify()}draw(){}}class ge{constructor(e,i,s){t(this,"context"),t(this,"_debugBoxes",!0),this.log=e,this.canvas=i,this.netcode=s;const o=i.getContext("2d");if(!o)throw"Error getting context 2d";this.context=o}get debugBoxes(){return this._debugBoxes}set debugBoxes(e){this._debugBoxes=e}}class fe{constructor(e,t,i,s,o,n,a,r){this.currentTime=e,this.currentGameState=t,this.currentGameStateTime=i,this.elapsed=s,this.nextGameState=o,this.nextGameStateTime=n,this.nextElapsed=a,this.tickTimeDiff=r}}class ue extends ge{constructor(e,t,i){super(e,t,i),this.log=e,this.canvas=t,this.netcode=i}render(e){e?this.renderWithInterpolation():this.renderAsIs()}renderAsIs(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height);const e=this.netcode.getGameStateToRender();for(let t=e.world.getBodyList();t;t=t.getNext())t.getUserData()&&(t.isStatic()?this.drawStaticBody(t):this.drawDynamicBody(t));this.renderScores(e)}renderWithInterpolation(){let e=I();const t=this.netcode.getGameStateToRender(),i=this.netcode.tickTime(t.tick),s=this.netcode.getGameState(t.tick+1),o=s?this.netcode.tickTime(s.tick):void 0;o&&(e-=o-i),e>i+this.netcode.tickMs&&(e=i+this.netcode.tickMs);const n=new fe(e,t,i,(e-i)/1e3,s,s?this.netcode.tickTime(s.tick):void 0,o?(e-o)/1e3:0,o?(o-i)/1e3:this.netcode.tickMs/1e3);this.context.clearRect(0,0,this.canvas.width,this.canvas.height);for(let a=t.world.getBodyList();a;a=a.getNext())a.getUserData()&&(a.isStatic()?this.drawStaticBody(a):this.drawDynamicBodyWithInterpolation(a,n));this.renderScores(t)}drawStaticBody(e){let t=e.getUserData().width,i=e.getUserData().height;this.context.fillStyle=e.getUserData().color,this.context.fillRect(e.getPosition().x*C.physics.worldScale-t/2,e.getPosition().y*C.physics.worldScale-i/2,t,i)}drawDynamicBody(e){let t=e.getUserData();this.context.fillStyle=t.color,this.context.fillRect(e.getPosition().x*C.physics.worldScale-t.size/2,e.getPosition().y*C.physics.worldScale-t.size/2,t.size,t.size)}drawDynamicBodyWithInterpolation(e,t){let i,s,o,n=e.getUserData(),a=0,r=0;if(t.nextGameState){if(i=ee.bodyFromPlayer(t.nextGameState,e.getUserData().id),i){const s=e.getPosition(),o=i.getPosition(),n=e.getLinearVelocity(),c=i.getLinearVelocity();a=Math.sign(n.x)===Math.sign(c.x)?s.x+t.elapsed*(o.x-s.x)/t.tickTimeDiff:t.elapsed<-t.nextElapsed?s.x+n.x*t.elapsed:o.x+c.x*t.nextElapsed,r=Math.sign(n.y)===Math.sign(c.y)?s.y+t.elapsed*(o.y-s.y)/t.tickTimeDiff:t.elapsed<-t.nextElapsed?s.y+n.y*t.elapsed:o.y+c.y*t.nextElapsed}}else a=e.getPosition().x+e.getLinearVelocity().x*t.elapsed,r=e.getPosition().y+e.getLinearVelocity().y*t.elapsed;this._debugBoxes&&(s=e.getPosition().x*C.physics.worldScale-n.size/2,o=e.getPosition().y*C.physics.worldScale-n.size/2,this.context.beginPath(),this.context.rect(s,o,n.size,n.size),this.context.strokeStyle="red",this.context.stroke(),i&&(s=i.getPosition().x*C.physics.worldScale-n.size/2,o=i.getPosition().y*C.physics.worldScale-n.size/2,this.context.beginPath(),this.context.rect(s,o,n.size,n.size),this.context.strokeStyle="blue",this.context.stroke())),s=a*C.physics.worldScale-n.size/2,o=r*C.physics.worldScale-n.size/2,this.context.fillStyle=n.color,this.context.fillRect(s,o,n.size,n.size)}renderScores(e){this.context.font="16px monospace";C.players.forEach(((t,i)=>{this.context.fillStyle=C.players[i].color,this.context.fillText(`P${t.id}: ${e.scores[i]}`,10+140*i,20)}))}}class ye{constructor(e,t,i,s,o,n,a,r){this.currentTime=e,this.currentGameState=t,this.currentGameStateTime=i,this.elapsed=s,this.nextGameState=o,this.nextGameStateTime=n,this.nextElapsed=a,this.tickTimeDiff=r}}class Se extends ge{constructor(e,t,i){super(e,t,i),this.log=e,this.canvas=t,this.netcode=i}render(e){e?this.renderWithInterpolation():this.renderAsIs()}renderAsIs(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height);const e=this.netcode.getGameStateToRender();e.bodies.forEach((e=>{e.isStatic?this.drawStaticBody(e):this.drawDynamicBody(e)})),this.renderScores(e)}renderWithInterpolation(){let e=I();const t=this.netcode.getGameStateToRender();if(!t)return;const i=this.netcode.tickTime(t.tick),s=this.netcode.getGameState(t.tick+1),o=s?this.netcode.tickTime(s.tick):void 0;o&&(e-=o-i),e>i+this.netcode.tickMs&&(e=i+this.netcode.tickMs);const n=new ye(e,t,i,(e-i)/1e3,s,s?this.netcode.tickTime(s.tick):void 0,o?(e-o)/1e3:0,o?(o-i)/1e3:this.netcode.tickMs/1e3);this.context.clearRect(0,0,this.canvas.width,this.canvas.height),t.bodies.forEach((e=>{e.isStatic?this.drawStaticBody(e):this.drawDynamicBodyWithInterpolation(e,n)})),this.renderScores(t)}drawStaticBody(e){this.context.fillStyle=e.color,this.context.fillRect(e.posX*C.physics.worldScale-e.width/2,e.posY*C.physics.worldScale-e.height/2,e.width,e.height)}drawDynamicBody(e){this.context.fillStyle=e.color,this.context.fillRect(e.posX*C.physics.worldScale-e.width/2,e.posY*C.physics.worldScale-e.height/2,e.width,e.height)}drawDynamicBodyWithInterpolation(e,t){let i,s,o,n=0,a=0;t.nextGameState?(i=Q.bodyFromPlayer(t.nextGameState,e.id),i&&(n=Math.sign(e.velX)===Math.sign(i.velX)?e.posX+t.elapsed*(i.posX-e.posX)/t.tickTimeDiff:t.elapsed<-t.nextElapsed?e.posX+e.velX*t.elapsed:i.posX+i.velX*t.nextElapsed,a=Math.sign(e.velY)===Math.sign(i.velY)?e.posY+t.elapsed*(i.posY-e.posY)/t.tickTimeDiff:t.elapsed<-t.nextElapsed?e.posY+e.velY*t.elapsed:i.posY+i.velY*t.nextElapsed)):(n=e.posX+e.velX*t.elapsed,a=e.posY+e.velY*t.elapsed),this._debugBoxes&&(s=e.posX*C.physics.worldScale-e.width/2,o=e.posY*C.physics.worldScale-e.height/2,this.context.beginPath(),this.context.rect(s,o,e.width,e.height),this.context.strokeStyle="red",this.context.stroke(),i&&(s=i.posX*C.physics.worldScale-i.width/2,o=i.posY*C.physics.worldScale-i.height/2,this.context.beginPath(),this.context.rect(s,o,i.width,i.height),this.context.strokeStyle="blue",this.context.stroke())),s=n*C.physics.worldScale-e.width/2,o=a*C.physics.worldScale-e.height/2,this.context.fillStyle=e.color,this.context.fillRect(s,o,e.width,e.height)}renderScores(e){this.context.font="16px monospace";C.players.forEach(((t,i)=>{this.context.fillStyle=C.players[i].color,this.context.fillText(`P${t.id}: ${e.scores[i]}`,10+140*i,20)}))}}class ve extends class{constructor(e,t,i,s,o,n,a,r){this.algorithm=e,this.netcodeClass=t,this.tickMs=i,this.npcs=s,this.width=o,this.height=n,this.usePlanck=a,this.randomSeed=r}}{constructor(e,t,i,s,o,n,a,r,c,l){super(e,t,i,s,o,n,a,r),this.algorithm=e,this.netcodeClass=t,this.tickMs=i,this.npcs=s,this.width=o,this.height=n,this.usePlanck=a,this.randomSeed=r,this.interpolation=c,this.debugBoxes=l}}class we extends pe{constructor(e,i,s){super(e,i),t(this,"renderer"),t(this,"_interpolation",!0),this.isServer=e,this.playerId=i,this.canvas=s}get debugBoxes(){return this.renderer.debugBoxes}set debugBoxes(e){this.renderer.debugBoxes=e}get interpolation(){return this._interpolation}set interpolation(e){this._interpolation=e}play(e){super.play(e),this._interpolation=e.interpolation,this.renderer=e.usePlanck?new ue(this.log,this.canvas,this.netcode):new Se(this.log,this.canvas,this.netcode),this.renderer.debugBoxes=e.debugBoxes}draw(){this.renderer.render(this._interpolation)}}const ke=new class{constructor(){t(this,"pressedKeys",[]),document.onkeydown=document.onkeyup=e=>{this.pressedKeys[e.keyCode]="keydown"===e.type}}isPressed(e){return this.pressedKeys[e]}};class xe extends we{constructor(e,t,i,s,o,n){super(!1,e,n),this.playerId=e,this.keyUp=t,this.keyDown=i,this.keyLeft=s,this.keyRight=o,this.canvas=n}update(){const e=(ke.isPressed(this.keyUp)?y:ke.isPressed(this.keyDown)?S:u)+(ke.isPressed(this.keyLeft)?v:ke.isPressed(this.keyRight)?w:u);this.netcode.localCommandReceived(this.playerId,e),super.update()}}class Ee extends we{constructor(e,t){super(!0,e,t),this.playerId=e,this.canvas=t}}class _e extends pe{constructor(e){super(!1,e),t(this,"lastCommandTime",0),t(this,"commandValue",u),this.playerId=e}update(){if(0===this.lastCommandTime||I()>this.lastCommandTime+1e3){const e=T(0,1)?y:T(0,1)?S:u,t=T(0,1)?v:T(0,1)?w:u;this.commandValue=e+t}this.netcode.localCommandReceived(this.playerId,this.commandValue),super.update()}}(new class{constructor(){t(this,"deviceServer"),t(this,"devicePlayer1"),t(this,"devicePlayer2"),t(this,"p2pmode",!0),t(this,"panelControl"),t(this,"panelCanvas1"),t(this,"panelGamestates1"),t(this,"panelLog1"),t(this,"panelCanvas2"),t(this,"panelGamestates2"),t(this,"panelLog2"),t(this,"panelCanvasS"),t(this,"panelGamestatesS"),t(this,"panelLogS"),t(this,"panelTrafficChart"),t(this,"uplotChartPanel"),this.deviceServer=new Ee(0,document.getElementById("serverGameArea")),this.devicePlayer1=new xe(C.players[0].id,C.players[0].keyUp,C.players[0].keyDown,C.players[0].keyLeft,C.players[0].keyRight,document.getElementById("player1GameArea")),this.devicePlayer2=new xe(C.players[1].id,C.players[1].keyUp,C.players[1].keyDown,C.players[1].keyLeft,C.players[1].keyRight,document.getElementById("player2GameArea"))}build(){this.createWindows(),this.bootstrapAngular()}createWindows(){this.panelControl=h.create({id:"panelControl",headerTitle:"Control Panel",theme:"dimgrey",headerControls:{close:"remove",size:"xs"},panelSize:{width:"18em",height:"100%"},position:{my:"left-top",at:"left-top",offsetX:"0",offsetY:"0"},content:document.getElementById("controlPanel")}),this.panelGamestates1=h.create({id:"panelGamestates1",headerTitle:"Player 1 Game States",theme:"DarkSlateBlue",contentOverflow:"auto",headerControls:{close:"remove",size:"xs"},resizeit:{handles:"n,s"},panelSize:{width:"22em",height:"50%"},position:{my:"left-top",at:"left-top",offsetX:"calc(100vw - 22em)",offsetY:"0"},content:document.getElementById("player1GameStates")}),this.panelCanvas1=h.create({id:"panelCanvas1",headerTitle:"Player 1 Canvas",theme:"DarkSlateBlue",contentOverflow:"hide",headerControls:{close:"remove",size:"xs"},panelSize:{width:"310px",height:"calc(250px + 4.5em)"},position:{my:"left-top",at:"left-top",offsetX:"calc(18em + (100vw - 40em - 620px) / 3)",offsetY:"0"},content:document.getElementById("player1Canvas")}),this.panelLog1=h.create({id:"panelLog1",headerTitle:"Player 1 Logs",theme:"DarkSlateBlue",contentOverflow:"auto",headerControls:{close:"remove",size:"xs"},panelSize:{width:"calc(100vw - 40em)",height:"calc((100vh - 250px - 4.5em) / 2)"},position:{my:"left-top",at:"left-top",offsetX:"18em",offsetY:"calc(250px + 4.5em)"},content:document.getElementById("player1Logs")}),this.panelGamestates2=h.create({id:"panelGamestates2",headerTitle:"Player 2 Game States",theme:"OliveDrab",contentOverflow:"auto",headerControls:{close:"remove",size:"xs"},panelSize:{width:"350px",height:"50%"},position:{my:"left-top",at:"left-top",offsetX:"calc(100vw - 22em)",offsetY:"50%"},content:document.getElementById("player2GameStates")}),this.panelCanvas2=h.create({id:"panelCanvas2",headerTitle:"Player 2 Canvas",theme:"OliveDrab",contentOverflow:"hide",headerControls:{close:"remove",size:"xs"},panelSize:{width:"310px",height:"calc(250px + 4.5em)"},position:{my:"left-top",at:"left-top",offsetX:"calc(100vw - 22em - 310px - (100vw - 40em - 620px) / 3)",offsetY:"0"},content:document.getElementById("player2Canvas")}),this.panelLog2=h.create({id:"panelLog2",headerTitle:"Player 2 Logs",theme:"OliveDrab",contentOverflow:"auto",headerControls:{close:"remove",size:"xs"},panelSize:{width:"calc(100vw - 40em)",height:"calc((100vh - 250px - 4.5em) / 2)"},position:{my:"left-top",at:"left-top",offsetX:"18em",offsetY:"calc(250px + 4.5em + (100vh - 250px - 4.5em) / 2)"},content:document.getElementById("player2Logs")}),this.panelGamestatesS=h.create({id:"panelGamestatesS",headerTitle:"Server Game States",theme:"black",contentOverflow:"auto",headerControls:{close:"remove",size:"xs"},panelSize:{width:"350px",height:"50%"},position:{my:"left-top",at:"left-top",offsetX:"calc(100vw - 350px)",offsetY:"50%"},content:document.getElementById("serverGameStates")}),this.panelCanvasS=h.create({id:"panelCanvasS",headerTitle:'Server "Canvas"',theme:"black",contentOverflow:"hide",headerControls:{close:"remove",size:"xs"},panelSize:{width:"310px",height:"calc(250px + 4.5em)"},position:{my:"left-top",at:"left-top",offsetX:"calc(50vw + 350px)",offsetY:"0"},content:document.getElementById("serverCanvas")}),this.panelLogS=h.create({id:"panelLogS",headerTitle:"Server Logs",theme:"black",contentOverflow:"auto",headerControls:{close:"remove",size:"xs"},panelSize:{width:"calc(100vw - 40em)",height:"calc((100vh - 250px - 4.5em) / 2)"},position:{my:"left-top",at:"left-top",offsetX:"350px",offsetY:"75%"},content:document.getElementById("serverLogs")}),this.panelTrafficChart=h.create({id:"panelTrafficChart",headerTitle:"Network Traffic",theme:"dimgrey",contentOverflow:"auto",headerControls:{close:"remove",size:"xs"},panelSize:{width:"calc(100vw - 25em)",height:"calc(100vh - 250px - 4.5em)"},position:{my:"left-top",at:"left-top",offsetX:"1000vw",offsetY:"1000vh"},content:document.getElementById("trafficChart")}),this.uplotChartPanel=document.querySelector("#panelTrafficChart > div.jsPanel-content")}resetLayout(){this.panelControl.reposition({my:"left-top",at:"left-top",offsetX:"0",offsetY:"0"}),this.panelControl.resize({width:"18em",height:"100%"}),this.p2pmode?(this.panelGamestates1.reposition({my:"left-top",at:"left-top",offsetX:"calc(100vw - 22em)",offsetY:"0"}),this.panelGamestates1.resize({width:"22em",height:"50%"}),this.panelCanvas1.reposition({my:"left-top",at:"left-top",offsetX:"calc(18em + (100vw - 40em - 620px) / 3)",offsetY:"0"}),this.panelCanvas1.resize({width:"310px",height:"calc(250px + 4.5em)"}),this.panelLog1.reposition({my:"left-top",at:"left-top",offsetX:"18em",offsetY:"calc(250px + 4.5em)"}),this.panelLog1.resize({width:"calc(100vw - 40em)",height:"calc((100vh - 250px - 4.5em) / 2)"}),this.panelGamestates2.reposition({my:"left-top",at:"left-top",offsetX:"calc(100vw - 22em)",offsetY:"50%"}),this.panelGamestates2.resize({width:"22em",height:"50%"}),this.panelCanvas2.reposition({my:"left-top",at:"left-top",offsetX:"calc(100vw - 22em - 310px - (100vw - 40em - 620px) / 3)",offsetY:"0"}),this.panelCanvas2.resize({width:"310px",height:"calc(250px + 4.5em)"}),this.panelLog2.reposition({my:"left-top",at:"left-top",offsetX:"18em",offsetY:"calc(250px + 4.5em + (100vh - 250px - 4.5em) / 2)"}),this.panelLog2.resize({width:"calc(100vw - 40em)",height:"calc((100vh - 250px - 4.5em) / 2)"}),this.panelGamestatesS.reposition({my:"left-top",at:"left-top",offsetX:"1000vw",offsetY:"1000vh"}),this.panelCanvasS.reposition({my:"left-top",at:"left-top",offsetX:"1000vw",offsetY:"1000vh"}),this.panelLogS.reposition({my:"left-top",at:"left-top",offsetX:"1000vw",offsetY:"1000vh"})):(this.panelGamestates1.reposition({my:"left-top",at:"left-top",offsetX:"calc(100vw - 22em)",offsetY:"0"}),this.panelGamestates1.resize({width:"22em",height:"33%"}),this.panelCanvas1.reposition({my:"left-top",at:"left-top",offsetX:"18em",offsetY:"0"}),this.panelCanvas1.resize({width:"310px",height:"calc(250px + 4.5em)"}),this.panelLog1.reposition({my:"left-top",at:"left-top",offsetX:"18em",offsetY:"calc(250px + 4.5em)"}),this.panelLog1.resize({width:"calc(100vw - 40em - 4em)",height:"calc(100vh - 250px - 4.5em - 4em)"}),this.panelGamestates2.reposition({my:"left-top",at:"left-top",offsetX:"calc(100vw - 22em)",offsetY:"33%"}),this.panelGamestates2.resize({width:"22em",height:"33%"}),this.panelCanvas2.reposition({my:"left-top",at:"left-top",offsetX:"calc(18em + 310px)",offsetY:"0"}),this.panelCanvas2.resize({width:"310px",height:"calc(250px + 4.5em)"}),this.panelLog2.reposition({my:"left-top",at:"left-top",offsetX:"20em",offsetY:"calc(250px + 4.5em + 2em)"}),this.panelLog2.resize({width:"calc(100vw - 40em - 4em)",height:"calc(100vh - 250px - 4.5em - 4em)"}),this.panelGamestatesS.reposition({my:"left-top",at:"left-top",offsetX:"calc(100vw - 22em)",offsetY:"66%"}),this.panelGamestatesS.resize({width:"22em",height:"33%"}),this.panelCanvasS.reposition({my:"left-top",at:"left-top",offsetX:"calc(18em + 620px)",offsetY:"0"}),this.panelCanvasS.resize({width:"310px",height:"calc(250px + 4.5em)"}),this.panelLogS.reposition({my:"left-top",at:"left-top",offsetX:"22em",offsetY:"calc(250px + 4.5em + 4em)"}),this.panelLogS.resize({width:"calc(100vw - 40em - 4em)",height:"calc(100vh - 250px - 4.5em - 4em)"})),this.panelGamestates1.front(),this.panelGamestates2.front(),this.panelGamestatesS.front(),this.panelLog1.front(),this.panelLog2.front(),this.panelLogS.front(),this.panelCanvas1.front(),this.panelCanvas2.front(),this.panelCanvasS.front()}saveFile(e,t){const i=new Date,s=m.exports.createWriteStream(`${i.getFullYear()}${i.getMonth()}${i.getDate()}${i.getHours()}${i.getMinutes()}${i.getSeconds()}-${e}.log`).getWriter(),o=(new TextEncoder).encode(t);s.write(o),s.close()}showError(e,t){h.create({dragit:!1,resizeit:!1,headerControls:"closeonly  xs",position:"center-top 0 15 down",contentSize:"330 auto",content:`<p>${t}</p>`,theme:"warning filled",headerTitle:`${e}`})}bootstrapAngular(){d.module("app",[]).controller("mainCtrl",["$scope","$timeout",(e,t)=>{e.info={showSpinner:!1,btnStopEnabled:!1,btnPlayEnabled:!0,btnSaveEnabled:!0,playing:!1,tick:C.network.tickMs,netcodes:C.netcodes,algorithm:C.netcodes[0],serializers:C.serializers,serializer:C.serializers[0],latency1:{min:C.network.minLatency1,max:C.network.maxLatency1},packetLoss1:C.network.packetLoss1,latency2:{min:C.network.minLatency2,max:C.network.maxLatency2},packetLoss2:C.network.packetLoss2,npcs:0,realtimeGameStates:!0,realtimeLogs:!1,interpolation:!0,debugBoxes:!0,syncScrollGs1:!0,syncScrollGs2:!0,syncScrollGsS:!0,syncScrollLog1:!0,syncScrollLog2:!0,syncScrollLogS:!0,logsPlayer1:[],logsPlayer2:[],logsServer:[],gamestatesPlayer1:[],gamestatesPlayer2:[],gamestatesServer:[],deviceNPCs:[],uplot:void 0,uplotP2POpts:{width:this.uplotChartPanel.clientWidth-20,height:this.uplotChartPanel.clientHeight-50,pxAlign:0,scales:{x:{time:!1}},series:[{label:"(sec)"},{label:"P1 In",stroke:"#483D8B"},{label:"P1 Out",stroke:"blue"},{label:"P2 In",stroke:"#6B8E23"},{label:"P2 Out",stroke:"green"}]},uplotCSOpts:{width:this.uplotChartPanel.clientWidth-20,height:this.uplotChartPanel.clientHeight-50,pxAlign:0,scales:{x:{time:!1}},series:[{label:"(sec)"},{label:"P1 In",stroke:"#483D8B"},{label:"P1 Out",stroke:"blue"},{label:"P2 In",stroke:"#6B8E23"},{label:"P2 Out",stroke:"green"},{label:"SRV In",stroke:"black"},{label:"SRV Out",stroke:"gray"}]},uplotData:[]};const i="p2p"===e.info.algorithm.type;this.p2pmode=i,this.resetLayout(),e.resetLayout=()=>{this.resetLayout()};const s=document.getElementById("player1GameStates"),o=document.getElementById("player2GameStates"),n=document.getElementById("serverGameStates");d.element(s.parentElement).bind("scroll",(()=>{e.info.syncScrollGs1&&(e.info.syncScrollGs2&&(o.parentElement.scrollTop=s.parentElement.scrollTop),e.info.syncScrollGsS&&(n.parentElement.scrollTop=s.parentElement.scrollTop))})),d.element(o.parentElement).bind("scroll",(()=>{e.info.syncScrollGs2&&(e.info.syncScrollGs1&&(s.parentElement.scrollTop=o.parentElement.scrollTop),e.info.syncScrollGsS&&(n.parentElement.scrollTop=o.parentElement.scrollTop))})),d.element(n.parentElement).bind("scroll",(()=>{e.info.syncScrollGsS&&(e.info.syncScrollGs1&&(s.parentElement.scrollTop=n.parentElement.scrollTop),e.info.syncScrollGs2&&(o.parentElement.scrollTop=n.parentElement.scrollTop))}));const a=document.getElementById("player1Logs"),r=document.getElementById("player2Logs"),c=document.getElementById("serverLogs");d.element(a.parentElement).bind("scroll",(()=>{e.info.syncScrollLog1&&(e.info.syncScrollLog2&&(r.parentElement.scrollTop=a.parentElement.scrollTop),e.info.syncScrollLogS&&(c.parentElement.scrollTop=a.parentElement.scrollTop))})),d.element(r.parentElement).bind("scroll",(()=>{e.info.syncScrollLog2&&(e.info.syncScrollLog1&&(a.parentElement.scrollTop=r.parentElement.scrollTop),e.info.syncScrollLogS&&(c.parentElement.scrollTop=r.parentElement.scrollTop))})),d.element(c.parentElement).bind("scroll",(()=>{e.info.syncScrollLogS&&(e.info.syncScrollLog1&&(a.parentElement.scrollTop=c.parentElement.scrollTop),e.info.syncScrollLog2&&(r.parentElement.scrollTop=c.parentElement.scrollTop))})),this.deviceServer.deviceUpdatedEmitter.addEventListener((()=>{(e.info.realtimeGameStates||e.info.realtimeLogs)&&e.$apply()})),this.devicePlayer1.deviceUpdatedEmitter.addEventListener((()=>{(e.info.realtimeGameStates||e.info.realtimeLogs)&&e.$apply()})),this.devicePlayer2.deviceUpdatedEmitter.addEventListener((()=>{(e.info.realtimeGameStates||e.info.realtimeLogs)&&e.$apply()}));const l='<button class="jsPanel-btn jsPanel-btn-menu jsPanel-btn-md tooltip bottom" aria-label="Sync scroll"><span class="fas fa-arrows-alt-v toolbar-icon" style="vertical-align: text-top"></span><input type="checkbox" checked /></button>',h='<button class="jsPanel-btn jsPanel-btn-menu jsPanel-btn-md tooltip bottom" aria-label="Download"><span class="fas fa-download toolbar-icon"></span></button>';this.panelGamestates1.addControl({html:l,name:"sync",position:1,handler:()=>{e.info.syncScrollGs1=!e.info.syncScrollGs1}}),this.panelGamestates1.addControl({html:h,name:"download",position:2,handler:()=>{e.saveGamestates1()}}),this.panelGamestates2.addControl({html:l,name:"sync",position:1,handler:()=>{e.info.syncScrollGs2=!e.info.syncScrollGs2}}),this.panelGamestates2.addControl({html:h,name:"download",position:2,handler:()=>{e.saveGamestates2()}}),this.panelGamestatesS.addControl({html:l,name:"sync",position:1,handler:()=>{e.info.syncScrollGsS=!e.info.syncScrollGsS}}),this.panelGamestatesS.addControl({html:h,name:"download",position:2,handler:()=>{e.saveGamestatesS()}}),this.panelLog1.addControl({html:l,name:"sync",position:1,handler:()=>{e.info.syncScrollLog1=!e.info.syncScrollLog1}}),this.panelLog1.addControl({html:h,name:"download",position:2,handler:()=>{e.saveLogs1()}}),this.panelLog2.addControl({html:l,name:"sync",position:1,handler:()=>{e.info.syncScrollLog2=!e.info.syncScrollLog2}}),this.panelLog2.addControl({html:h,name:"download",position:2,handler:()=>{e.saveLogs2()}}),this.panelLogS.addControl({html:l,name:"sync",position:1,handler:()=>{e.info.syncScrollLogS=!e.info.syncScrollLogS}}),this.panelLogS.addControl({html:h,name:"download",position:2,handler:()=>{e.saveLogsS()}}),e.changeAlgorithm=()=>{if("custom"===e.info.algorithm.type)return;const t="p2p"===e.info.algorithm.type;t!==this.p2pmode&&(this.p2pmode=t,this.resetLayout())},["jspanelresizestop","jspanelmaximized","jspanelnormalized"].forEach((t=>{document.addEventListener(t,(t=>{"panelTrafficChart"===t.panel.id&&e.info.uplot.setSize({width:this.uplotChartPanel.clientWidth,height:this.uplotChartPanel.clientHeight-50})}),!1)})),e.showTrafficChart=()=>{e.info.uplot=new p(this.p2pmode?e.info.uplotP2POpts:e.info.uplotCSOpts,e.info.uplotData,this.uplotChartPanel),this.panelTrafficChart.reposition({my:"left-top",at:"left-top",offsetX:"23em",offsetY:"calc(250px + 4.5em)"}),this.panelTrafficChart.resize({width:"calc(100vw - 25em)",height:"calc(100vh - 250px - 4.5em)"}),this.panelTrafficChart.front()},e.stop=()=>{e.info.showSpinner=!0,t((()=>{this.deviceServer.stop(),this.devicePlayer1.stop(),this.devicePlayer2.stop(),e.info.deviceNPCs.forEach((e=>{e.stop()})),e.info.btnStopEnabled=!1,e.info.btnPlayEnabled=!0,e.info.playing=!1,e.showTrafficChart(),t((()=>{e.info.showSpinner=!1}))}))},e.play=async()=>{if("custom"===e.info.algorithm.type){if(!e.info.algorithmUrl)return void this.showError("Loading algorithm","Empty Algorithm URL");const o=await fetch(e.info.algorithmUrl),n=await o.text();try{window.currentTimestamp=I,window.BaseNetCode=te,window.Command=U,window.CommandMessage=V,window.GameStateMessage=K,window.CommandUtils=Y,window.SimpleGameStateUtils=Q,window.PlanckGameStateUtils=ee;const{type:s,name:o,ClientNetCode:a,ServerNetCode:r}=await(t=()=>import(`data:text/javascript;charset=utf-8,${encodeURIComponent(n)}`),i=[],i&&0!==i.length?Promise.all(i.map((e=>{if((e=`/netcode-workbench/${e}`)in g)return;g[e]=!0;const t=e.endsWith(".css"),i=t?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${e}"]${i}`))return;const s=document.createElement("link");return s.rel=t?"stylesheet":"modulepreload",t||(s.as="script",s.crossOrigin=""),s.href=e,document.head.appendChild(s),t?new Promise(((e,t)=>{s.addEventListener("load",e),s.addEventListener("error",t)})):void 0}))).then((()=>t())):t()),c=new L(o,s);this.p2pmode="p2p"===s,this.resetLayout(),this.p2pmode?e.internalPlay(c,a,null):e.internalPlay(c,a,r)}catch(s){this.showError("Loading algorithm",s)}}else e.internalPlay(e.info.algorithm,null,null);var t,i},e.internalPlay=(t,i,s)=>{this.deviceServer.reset(),this.devicePlayer1.reset(),this.devicePlayer2.reset(),e.info.deviceNPCs.forEach((e=>{e.reset()})),e.info.uplot&&(e.info.uplot.destroy(),e.info.uplot=void 0),this.panelTrafficChart.reposition({my:"left-top",at:"left-top",offsetX:"1000vw",offsetY:"1000vh"}),e.info.uplotData=this.p2pmode?[[],[],[],[],[]]:[[],[],[],[],[],[],[]];let o=0;this.devicePlayer1.trafficLog.incomingEmitter.addEventListener((t=>{this.devicePlayer1.log.logInfo(`incoming ${t.timestamp} ${t.size} bytes`),0===o&&(o=t.timestamp);const i=t.timestamp-o,s=e.info.uplotData[0].indexOf(i);-1===s?(e.info.uplotData[0].push(i),e.info.uplotData[1].push(t.size),e.info.uplotData[2].push(0),e.info.uplotData[3].push(0),e.info.uplotData[4].push(0),this.p2pmode||(e.info.uplotData[5].push(0),e.info.uplotData[6].push(0))):e.info.uplotData[1][s]=t.size})),this.devicePlayer1.trafficLog.outgoingEmitter.addEventListener((t=>{this.devicePlayer1.log.logInfo(`outgoing ${t.timestamp} ${t.size} bytes`),0===o&&(o=t.timestamp);const i=t.timestamp-o,s=e.info.uplotData[0].indexOf(i);-1===s?(e.info.uplotData[0].push(i),e.info.uplotData[1].push(0),e.info.uplotData[2].push(t.size),e.info.uplotData[3].push(0),e.info.uplotData[4].push(0),this.p2pmode||(e.info.uplotData[5].push(0),e.info.uplotData[6].push(0))):e.info.uplotData[2][s]=t.size})),this.devicePlayer2.trafficLog.incomingEmitter.addEventListener((t=>{this.devicePlayer2.log.logInfo(`incoming ${t.timestamp} ${t.size} bytes`),0===o&&(o=t.timestamp);const i=t.timestamp-o,s=e.info.uplotData[0].indexOf(i);-1===s?(e.info.uplotData[0].push(i),e.info.uplotData[1].push(0),e.info.uplotData[2].push(0),e.info.uplotData[3].push(t.size),e.info.uplotData[4].push(0),this.p2pmode||(e.info.uplotData[5].push(0),e.info.uplotData[6].push(0))):e.info.uplotData[3][s]=t.size})),this.devicePlayer2.trafficLog.outgoingEmitter.addEventListener((t=>{this.devicePlayer2.log.logInfo(`outgoing ${t.timestamp} ${t.size} bytes`),0===o&&(o=t.timestamp);const i=t.timestamp-o,s=e.info.uplotData[0].indexOf(i);-1===s?(e.info.uplotData[0].push(i),e.info.uplotData[1].push(0),e.info.uplotData[2].push(0),e.info.uplotData[3].push(0),e.info.uplotData[4].push(t.size),this.p2pmode||(e.info.uplotData[5].push(0),e.info.uplotData[6].push(0))):e.info.uplotData[4][s]=t.size})),this.deviceServer.trafficLog.incomingEmitter.addEventListener((t=>{this.deviceServer.log.logInfo(`incoming ${t.timestamp} ${t.size} bytes`),0===o&&(o=t.timestamp);const i=t.timestamp-o,s=e.info.uplotData[0].indexOf(i);-1===s?(e.info.uplotData[0].push(i),e.info.uplotData[1].push(0),e.info.uplotData[2].push(0),e.info.uplotData[3].push(0),e.info.uplotData[4].push(0),this.p2pmode||(e.info.uplotData[5].push(t.size),e.info.uplotData[6].push(0))):e.info.uplotData[5][s]=t.size})),this.deviceServer.trafficLog.outgoingEmitter.addEventListener((t=>{this.deviceServer.log.logInfo(`outgoing ${t.timestamp} ${t.size} bytes`),0===o&&(o=t.timestamp);const i=t.timestamp-o,s=e.info.uplotData[0].indexOf(i);-1===s?(e.info.uplotData[0].push(i),e.info.uplotData[1].push(0),e.info.uplotData[2].push(0),e.info.uplotData[3].push(0),e.info.uplotData[4].push(0),this.p2pmode||(e.info.uplotData[5].push(0),e.info.uplotData[6].push(t.size))):e.info.uplotData[6][s]=t.size}));const n=[T(0,16378),T(0,16378),T(0,16378),T(0,16378)];e.info.deviceNPCs=[];for(let a=0;a<e.info.npcs;a++)e.info.deviceNPCs.push(new _e(a+100));if(this.p2pmode){this.devicePlayer1.init(),this.devicePlayer2.init(),e.info.deviceNPCs.forEach((e=>{e.init()})),this.devicePlayer1.connect(this.devicePlayer2,e.info.serializer.name,e.info.latency1.min,e.info.latency1.max,e.info.packetLoss1,e.info.latency2.min,e.info.latency2.max,e.info.packetLoss2);for(let t=0;t<e.info.deviceNPCs.length;t++){const i=e.info.deviceNPCs[t];this.devicePlayer1.connect(i,e.info.serializer.name,e.info.latency1.min,e.info.latency1.max,e.info.packetLoss1,e.info.latency1.min,e.info.latency1.max,e.info.packetLoss1),this.devicePlayer2.connect(i,e.info.serializer.name,e.info.latency2.min,e.info.latency2.max,e.info.packetLoss2,e.info.latency2.min,e.info.latency2.max,e.info.packetLoss2);for(let s=t+1;s<e.info.deviceNPCs.length;s++){let t=e.info.deviceNPCs[s];i.connect(t,e.info.serializer.name,e.info.latency1.min,e.info.latency1.max,e.info.packetLoss1,e.info.latency2.min,e.info.latency2.max,e.info.packetLoss2)}}const s=new ve(t,i,e.info.tick,e.info.npcs,C.canvas.width,C.canvas.height,!0,n,e.info.interpolation,e.info.debugBoxes);this.devicePlayer1.play(s),this.devicePlayer2.play(s),e.info.deviceNPCs.forEach((e=>{e.play(s)}))}else{this.devicePlayer1.init(),this.devicePlayer2.init(),this.deviceServer.init(),e.info.deviceNPCs.forEach((e=>{e.init()})),this.devicePlayer1.connect(this.deviceServer,e.info.serializer.name,e.info.latency1.min,e.info.latency1.max,e.info.packetLoss1,e.info.latency1.min,e.info.latency1.max,e.info.packetLoss1),this.devicePlayer2.connect(this.deviceServer,e.info.serializer.name,e.info.latency2.min,e.info.latency2.max,e.info.packetLoss2,e.info.latency2.min,e.info.latency2.max,e.info.packetLoss2),e.info.deviceNPCs.forEach((t=>{t.connect(this.deviceServer,e.info.serializer.name,e.info.latency1.min,e.info.latency1.max,e.info.packetLoss1,e.info.latency2.min,e.info.latency2.max,e.info.packetLoss2)}));const o=new ve(t,s,e.info.tick,e.info.npcs,C.canvas.width,C.canvas.height,!0,n,!1,!1),a=new ve(t,i,e.info.tick,e.info.npcs,C.canvas.width,C.canvas.height,!1,n,e.info.interpolation,e.info.debugBoxes);this.deviceServer.play(o),this.devicePlayer1.play(a),this.devicePlayer2.play(a),e.info.deviceNPCs.forEach((e=>{e.play(a)}))}e.info.btnStopEnabled=!0,e.info.btnPlayEnabled=!1,e.info.playing=!0,e.info.gamestatesServer=this.deviceServer.gameStateHistory,e.info.gamestatesPlayer1=this.devicePlayer1.gameStateHistory,e.info.gamestatesPlayer2=this.devicePlayer2.gameStateHistory,e.info.logsServer=this.deviceServer.log.traces,e.info.logsPlayer1=this.devicePlayer1.log.traces,e.info.logsPlayer2=this.devicePlayer2.log.traces},e.changeInterpolation=()=>{this.devicePlayer1.interpolation=e.info.interpolation,this.devicePlayer2.interpolation=e.info.interpolation},e.changeDebugBoxes=()=>{this.devicePlayer1.debugBoxes=e.info.debugBoxes,this.devicePlayer2.debugBoxes=e.info.debugBoxes},e.saveAll=()=>{let t=`\n--------------------\nPLAYER 1 GAME STATES\n--------------------\n${this.devicePlayer1.gameStateHistoryLog()}\n-------------\nPLAYER 1 LOGS\n-------------\n${this.devicePlayer1.log}\n\n--------------------\nPLAYER 2 GAME STATES\n--------------------\n${this.devicePlayer2.gameStateHistoryLog()}\n-------------\nPLAYER 2 LOGS\n-------------\n${this.devicePlayer2.log}`;this.p2pmode||(t+=`-----------------\nSERVER GAME STATES\n------------------\n${this.deviceServer.gameStateHistoryLog()}\n-----------\nSERVER LOGS\n-----------\n${this.deviceServer.log}`),this.saveFile(e.info.algorithm.name,t)},e.saveGamestates1=()=>{this.saveFile(`${e.info.algorithm.name}-p1-states`,this.devicePlayer1.gameStateHistoryLog())},e.saveLogs1=()=>{this.saveFile(`${e.info.algorithm.name}-p1-logs`,this.devicePlayer1.log.toString())},e.saveGamestates2=()=>{this.saveFile(`${e.info.algorithm.name}-p2-states`,this.devicePlayer2.gameStateHistoryLog())},e.saveLogs2=()=>{this.saveFile(`${e.info.algorithm.name}-p2-logs`,this.devicePlayer2.log.toString())},e.saveGamestatesS=()=>{this.saveFile(`${e.info.algorithm.name}-srv-states`,this.deviceServer.gameStateHistoryLog())},e.saveLogsS=()=>{this.saveFile(`${e.info.algorithm.name}-srv-logs`,this.deviceServer.log.toString())}}])}}).build();
