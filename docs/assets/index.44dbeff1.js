var e=Object.defineProperty,t=(t,s,i)=>(((t,s,i)=>{s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[s]=i})(t,"symbol"!=typeof s?s+"":s,i),i);export function __vite_legacy_guard(){import("data:text/javascript,")}import{f as s,t as i,l as o,j as n,a,S as r}from"./vendor.e74f4cfd.js";!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver((e=>{for(const s of e)if("childList"===s.type)for(const e of s.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)})).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerpolicy&&(t.referrerPolicy=e.referrerpolicy),"use-credentials"===e.crossorigin?t.credentials="include":"anonymous"===e.crossorigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();const l=0,c=1,h=2,m=10,d=20,p=11,g=21,y=12,f=22,u={canvas:{width:300,height:250},network:{tickMs:50,minLatency1:10,maxLatency1:30,packetLoss1:0,minLatency2:10,maxLatency2:30,packetLoss2:0},netcodes:[{name:"p2p-naive",type:"p2p"},{name:"p2p-stibbons",type:"p2p"},{name:"cs-lockstep",type:"cs"}],players:[{id:1,color:"#483D8B",x:10,y:10,size:20,keyUp:87,keyDown:83,keyLeft:65,keyRight:68},{id:2,color:"#6B8E23",x:270,y:220,size:20,keyUp:38,keyDown:40,keyLeft:37,keyRight:39}],physics:{worldScale:30,strength:10,borderThickness:5}};class v{constructor(){t(this,"_listeners",[])}addEventListener(e){this._listeners.includes(e)||this._listeners.push(e)}removeEventListener(e){const t=this._listeners.indexOf(e);-1!==t&&this._listeners.splice(t,1)}removeListeners(){this._listeners=[]}notify(e){this._listeners.forEach((t=>{t(e)}))}}const S=()=>(new Date).getTime();class w{constructor(e){t(this,"connections",[]),t(this,"_connectionEmitter",new v),t(this,"_disconnectionEmitter",new v),t(this,"_messageSentEmitter",new v),t(this,"_messageReceivedEmitter",new v),this.log=e}get connectionEmitter(){return this._connectionEmitter}get disconnectionEmitter(){return this._disconnectionEmitter}get messageSentEmitter(){return this._messageSentEmitter}get messageReceivedEmitter(){return this._messageReceivedEmitter}connect(e,t){this.attachListeners(e),this.connections.push(e),e.connect(t),0===t.peerId?this.log.logInfo("Connected to Server"):this.log.logInfo(`Connected to Player ${t.peerId}`)}attachListeners(e){e.connectionEmitter.addEventListener((e=>{this._connectionEmitter.notify(e)})),e.disconnectionEmitter.addEventListener((e=>{this._disconnectionEmitter.notify(e)})),e.messageReceivedEmitter.addEventListener((e=>{this._messageReceivedEmitter.notify(e)})),e.messageSentEmitter.addEventListener((e=>{this._messageSentEmitter.notify(e)}))}findConnection(e){return this.connections.find((t=>t.peer.peerId===e))}closeConnections(){this.connections.forEach((e=>{0===e.peer.peerId?this.log.logInfo("Disconnected from Server"):this.log.logInfo(`Disconnected from Player ${e.peer.peerId}`),this._disconnectionEmitter.notify(e)})),this.connections=[]}resetEmitters(){this._connectionEmitter.removeListeners(),this._disconnectionEmitter.removeListeners(),this._messageSentEmitter.removeListeners(),this._messageReceivedEmitter.removeListeners()}broadcast(e){this.connections.forEach((t=>{t.send(e)}))}send(e,t){var s;null==(s=this.findConnection(e))||s.send(t)}}class _{constructor(e,s){t(this,"_peer"),t(this,"_minLatency",0),t(this,"_maxLatency",0),t(this,"_packetLoss",0),t(this,"_totalSent",0),t(this,"_totalLost",0),t(this,"_connectionEmitter",new v),t(this,"_disconnectionEmitter",new v),t(this,"_messageSentEmitter",new v),t(this,"_messageReceivedEmitter",new v),this.peerId=e,this.log=s}get connectionEmitter(){return this._connectionEmitter}get disconnectionEmitter(){return this._disconnectionEmitter}get messageSentEmitter(){return this._messageSentEmitter}get messageReceivedEmitter(){return this._messageReceivedEmitter}get peer(){return this._peer}set minLatency(e){this._minLatency=e}set maxLatency(e){this._maxLatency=e}set packetLoss(e){this._packetLoss=e}connect(e){this._peer=e,this._connectionEmitter.notify(e)}send(e){if(e.timestampOrigin=S(),e.origin=this.peerId,e.destination=this._peer.peerId,this._packetLoss>0&&this._totalLost+1<this._totalSent*this._packetLoss/100)return this.log.logWarn(`Message for tick ${e.tick} lost`),void this._totalLost++;var t,s;this._totalSent++,this._messageSentEmitter.notify(e),0===this.maxLatency?this._peer.receive(e):setTimeout((()=>{this._peer.receive(e)}),(t=this._minLatency,s=this._maxLatency,Math.floor(Math.random()*(s-t+1)+t)))}receive(e){e.timestampDestination=S(),this._messageReceivedEmitter.notify(e)}}var x,k;(k=x||(x={})).INFO="INFO",k.WARN="WARN",k.ERROR="ERROR";class L{constructor(e,t,s){this.level=e,this.timestamp=t,this.text=s}toString(){const e=new Date;return e.setTime(this.timestamp),`${e.getHours().toString().padStart(2,"0")}:${e.getMinutes().toString().padStart(2,"0")}:${e.getSeconds().toString().padStart(2,"0")}.${e.getMilliseconds().toString().padStart(3,"0")} ${this.level.padEnd(5)} ${this.text}`}}class E{constructor(){t(this,"_traces",[])}get traces(){return this._traces}log(e,t){this._traces.unshift(new L(e,S(),t))}logInfo(e){this.log(x.INFO,e)}logWarn(e){this.log(x.WARN,e)}logError(e){this.log(x.ERROR,e)}clear(){this._traces=[]}toString(){const e=this._traces.reverse().join("\n");return this._traces.reverse(),e}}class G{constructor(e,s,i){t(this,"_tick"),t(this,"_playerId"),t(this,"_value"),this._tick=e,this._playerId=s,this._value=i}get tick(){return this._tick}get playerId(){return this._playerId}get value(){return this._value}clone(e){return new G(this._tick+(e?1:0),this._playerId,this._value)}toString(){return`P${this._playerId}:${this._value}`}toFullString(){return`tick ${this._tick} P${this._playerId}:${this._value}`}}class C{constructor(e,t,s){this.id=e,this.x=t,this.y=s}toString(){return`P${this.id} x=${this.x} y=${this.y}`}}class P{constructor(e,t){this.playerId=e,this.value=t}toString(){return`P${this.playerId}:${this.value}`}}class b{constructor(e,t,s){this.tick=e,this.players=t,this.commands=s}toString(){return`tick: ${this.tick}\n  ${this.players.join("\n  ")}\n  Commands: ${this.commands.join(" ")}`}}class I extends class{constructor(e,s,i){t(this,"_timestampOrigin"),t(this,"_timestampDestination"),this.tick=e,this.origin=s,this.destination=i}get timestampOrigin(){return this._timestampOrigin}set timestampOrigin(e){this._timestampOrigin=e}get timestampDestination(){return this._timestampDestination}set timestampDestination(e){this._timestampDestination=e}}{constructor(e,s,i){super(e.tick,s,i),t(this,"_command"),this._command=e}get command(){return this._command}}class $ extends class{constructor(e){t(this,"_tick"),t(this,"_peerCount"),t(this,"_commands"),this._tick=e,this._commands=[]}get tick(){return this._tick}get peerCount(){return this._peerCount}set peerCount(e){this._peerCount=e}get commands(){return this._commands}incTick(){this._tick++}commandFromPlayer(e){return this._commands.find((t=>t.playerId===e))}clearCommands(){this._commands=[]}}{constructor(e,s){super(e),t(this,"_world"),t(this,"_bodies"),this._world=s,this._bodies=[];for(let t=s.getBodyList();t;t=t.getNext())this._bodies.unshift(t)}get world(){return this._world}get bodies(){return this._bodies}bodyFromPlayer(e){return this._bodies.find((t=>t.getUserData().id===e))}toString(){let e="";return this._bodies.forEach((t=>{!t.isStatic()&&t.getUserData()&&(e+=`    P${t.getUserData().id} x=${t.getPosition().x*u.physics.worldScale} y=${t.getPosition().y*u.physics.worldScale}\n`)})),`\nGameState tick: ${this._tick}\n  bodies:\n${e}  commands:\n    ${this._commands.join("\n    ")}`}clone(){const e=this.cloneWorld(this._world,this._bodies),t=new $(this._tick,e);return this._commands.forEach((e=>t.commands.push(e.clone(!1)))),t}cloneWorld(e,t){const o=s(i(e)),n=[];for(let s=o.getBodyList();s;s=s.getNext())n.unshift(s);for(let[s,i]of n.entries())null!==i&&i.setUserData(t[s].getUserData());return o}toLog(){const e=[];this._bodies.forEach((t=>{if(!t.isStatic()&&t.getUserData()){let s=t.getUserData();e.push(new C(s.id,t.getPosition().x*u.physics.worldScale,t.getPosition().y*u.physics.worldScale))}})),e.sort(((e,t)=>e.id>t.id?1:-1));const t=[];return this._commands.forEach((e=>{t.push(new P(e.playerId,e.value))})),t.sort(((e,t)=>e.playerId>t.playerId?1:-1)),new b(this._tick,e,t)}}class T{constructor(e,s,i){t(this,"_initialGameState"),t(this,"_startTime"),t(this,"_tickMs"),t(this,"_currentTick"),this.log=e,this.net=s,this.gameStateMachine=i,this._startTime=0,this._tickMs=50,this._currentTick=0,this.net.messageReceivedEmitter.addEventListener((e=>{this.remoteCommandReceived(e.command)}))}get tickMs(){return this._tickMs}set tickMs(e){this._tickMs=e}get currentTick(){return this._currentTick}start(e){return this._startTime=S(),this._currentTick=0,this._initialGameState=e,this._startTime}tickBasedOnTime(){return Math.floor((S()-this._startTime)/this._tickMs)}tickTime(e){return this._startTime+e*this.tickMs}}class B extends T{localCommandReceived(e,t){throw new Error("Method not implemented.")}remoteCommandReceived(e){throw new Error("Method not implemented.")}getGameStateToRender(){throw new Error("Method not implemented.")}getGameState(e){throw new Error("Method not implemented.")}tick(){throw new Error("Method not implemented.")}}class D extends T{localCommandReceived(e,t){throw new Error("Method not implemented.")}remoteCommandReceived(e){throw new Error("Method not implemented.")}getGameStateToRender(){throw new Error("Method not implemented.")}getGameState(e){throw new Error("Method not implemented.")}tick(){throw new Error("Method not implemented.")}}class z extends T{constructor(){super(...arguments),t(this,"localCommand"),t(this,"localCommandDumped",!1),t(this,"remoteCommands",[])}start(e){return super.start(e)}tick(){let e=null;if(this.tickBasedOnTime()>this._currentTick){!this.localCommandDumped&&this.localCommand&&(this.localCommandDumped=!0,this._initialGameState.commands.push(this.localCommand));let t=0;const s=this.remoteCommands.length;for(let e=0;e<s;e++){let s=this.remoteCommands[e];s&&s.tick===this._initialGameState.tick&&(this._initialGameState.commands.push(s),this.remoteCommands.splice(e-t++,1))}this._initialGameState.commands.length<this._initialGameState.peerCount?this.log.logWarn(`Waiting commands for tick ${this._currentTick}: ${this._initialGameState.commands.length} of ${this._initialGameState.peerCount}`):(this._initialGameState.commands.sort(((e,t)=>e.playerId>t.playerId?1:-1)),this.log.logInfo(this._initialGameState.toString()),e=this._initialGameState.toLog(),this.gameStateMachine.compute(this._initialGameState),this._currentTick++,this._initialGameState.incTick(),this._initialGameState.clearCommands(),this.localCommand=void 0,this.localCommandDumped=!1)}return e}localCommandReceived(e,t){let s;return this.localCommand||(s=new G(this._currentTick,e,t),this.log.logInfo(`local command: ${s.toFullString()}`),this.localCommand=s),s}remoteCommandReceived(e){this.log.logInfo(`received command: ${e.toFullString()}`),this.remoteCommands.push(e)}getGameStateToRender(){return this._initialGameState}getGameState(e){return this._initialGameState.tick===e?this._initialGameState:null}}class R extends T{constructor(){super(...arguments),t(this,"localCommand"),t(this,"localCommandDumped",!1),t(this,"remoteCommands",[]),t(this,"prevGameState")}start(e){return super.start(e)}tick(){let e=null;if(this.tickBasedOnTime()>this._currentTick){!this.localCommandDumped&&this.localCommand&&(this.localCommandDumped=!0,this._initialGameState.commands.push(this.localCommand));let t=0;const s=this.remoteCommands.length;for(let e=0;e<s;e++){let s=this.remoteCommands[e];s&&s.tick===this._initialGameState.tick&&(this._initialGameState.commands.push(s),this.remoteCommands.splice(e-t++,1))}this._initialGameState.commands.length<this._initialGameState.peerCount?this.log.logWarn(`Waiting commands for tick ${this._currentTick}: ${this._initialGameState.commands.length} of ${this._initialGameState.peerCount}`):(this._initialGameState.commands.sort(((e,t)=>e.playerId>t.playerId?1:-1)),this.log.logInfo(this._initialGameState.toString()),e=this._initialGameState.toLog(),this.prevGameState=this._initialGameState.clone(),this.gameStateMachine.compute(this._initialGameState),this._currentTick++,this._initialGameState.incTick(),this._initialGameState.clearCommands(),this.localCommand=void 0,this.localCommandDumped=!1)}return e}localCommandReceived(e,t){let s;return this.localCommand||(s=new G(this._currentTick,e,t),this.log.logInfo(`local command: ${s.toFullString()}`),this.localCommand=s),s}remoteCommandReceived(e){this.log.logInfo(`received command: ${e.toFullString()}`),this.remoteCommands.push(e)}getGameStateToRender(){return this.prevGameState?this.prevGameState:this._initialGameState}getGameState(e){return this._initialGameState.tick===e?this._initialGameState:this.prevGameState&&this.prevGameState.tick===e?this.prevGameState:null}}class M{constructor(e,t,s,i,o,n,a,r){this.currentTime=e,this.currentGameState=t,this.currentGameStateTime=s,this.elapsed=i,this.nextGameState=o,this.nextGameStateTime=n,this.nextElapsed=a,this.tickTimeDiff=r}}class Y extends class{constructor(e,s,i){t(this,"context"),t(this,"_debugBoxes",!0),this.log=e,this.canvas=s,this.netcode=i;const o=s.getContext("2d");if(!o)throw"Error getting context 2d";this.context=o}get debugBoxes(){return this._debugBoxes}set debugBoxes(e){this._debugBoxes=e}}{constructor(e,t,s){super(e,t,s),this.log=e,this.canvas=t,this.netcode=s}render(e){e?this.renderWithInterpolation():this.renderAsIs()}renderAsIs(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height);for(let e=this.netcode.getGameStateToRender().world.getBodyList();e;e=e.getNext())e.getUserData()&&(e.isStatic()?this.drawStaticBody(e):this.drawDynamicBody(e))}renderWithInterpolation(){let e=S();const t=this.netcode.getGameStateToRender(),s=this.netcode.tickTime(t.tick),i=this.netcode.getGameState(t.tick+1),o=i?this.netcode.tickTime(i.tick):void 0;o&&(e-=o-s),e>s+this.netcode.tickMs&&(e=s+this.netcode.tickMs);const n=new M(e,t,s,(e-s)/1e3,i,i?this.netcode.tickTime(i.tick):void 0,o?(e-o)/1e3:0,o?(o-s)/1e3:this.netcode.tickMs/1e3);this.context.clearRect(0,0,this.canvas.width,this.canvas.height);for(let a=t.world.getBodyList();a;a=a.getNext())a.getUserData()&&(a.isStatic()?this.drawStaticBody(a):this.drawDynamicBodyWithInterpolation(a,n))}drawStaticBody(e){let t=e.getUserData().width,s=e.getUserData().height;this.context.fillStyle="#708090",this.context.fillRect(e.getPosition().x*u.physics.worldScale-t/2,e.getPosition().y*u.physics.worldScale-s/2,t,s)}drawDynamicBody(e){let t=e.getUserData();this.context.fillStyle=t.color,this.context.fillRect(e.getPosition().x*u.physics.worldScale-t.size/2,e.getPosition().y*u.physics.worldScale-t.size/2,t.size,t.size)}drawDynamicBodyWithInterpolation(e,t){let s,i,o,n=e.getUserData(),a=0,r=0;if(t.nextGameState){if(s=t.nextGameState.bodyFromPlayer(e.getUserData().id),s){const i=e.getPosition(),o=s.getPosition(),n=e.getLinearVelocity(),l=s.getLinearVelocity();a=Math.sign(n.x)===Math.sign(l.x)?i.x+t.elapsed*(o.x-i.x)/t.tickTimeDiff:t.elapsed<-t.nextElapsed?i.x+n.x*t.elapsed:o.x+l.x*t.nextElapsed,r=Math.sign(n.y)===Math.sign(l.y)?i.y+t.elapsed*(o.y-i.y)/t.tickTimeDiff:t.elapsed<-t.nextElapsed?i.y+n.y*t.elapsed:o.y+l.y*t.nextElapsed}}else a=e.getPosition().x+e.getLinearVelocity().x*t.elapsed,r=e.getPosition().y+e.getLinearVelocity().y*t.elapsed;this._debugBoxes&&(i=e.getPosition().x*u.physics.worldScale-n.size/2,o=e.getPosition().y*u.physics.worldScale-n.size/2,this.context.beginPath(),this.context.rect(i,o,n.size,n.size),this.context.strokeStyle="red",this.context.stroke(),s&&(i=s.getPosition().x*u.physics.worldScale-n.size/2,o=s.getPosition().y*u.physics.worldScale-n.size/2,this.context.beginPath(),this.context.rect(i,o,n.size,n.size),this.context.strokeStyle="blue",this.context.stroke())),i=a*u.physics.worldScale-n.size/2,o=r*u.physics.worldScale-n.size/2,this.context.fillStyle=n.color,this.context.fillRect(i,o,n.size,n.size)}}class U{constructor(e,t){this.log=e,this.step=t}compute(e){const t=e;for(let s of t.commands){if(!s||s.value===l)continue;const e=t.bodies.find((e=>(e.getUserData()?e.getUserData().id:-1)==s.playerId));if(e){const t=s.value==d||s.value==f||s.value==g?u.physics.strength:s.value==m||s.value==y||s.value==p?-1*u.physics.strength:0,i=s.value==h||s.value==y||s.value==f?u.physics.strength:s.value==c||s.value==p||s.value==g?-1*u.physics.strength:0;this.log.logInfo(`apply command value ${s.value} to P${s.playerId}: force(x=${t} y=${i})`),e.applyForce(o.Vec2(t,i),e.getWorldCenter())}}t.world.step(this.step),t.world.clearForces()}}class O{constructor(e,s,i){t(this,"running",!1),t(this,"_log"),t(this,"_gameStateHistory"),t(this,"_networkInterface"),t(this,"_deviceUpdatedEmitter",new v),t(this,"netcode"),t(this,"gameStateMachine"),t(this,"renderer"),t(this,"_npcs",0),t(this,"_interpolation",!0),this.isServer=e,this.playerId=s,this.canvas=i,this._log=new E,this._networkInterface=new w(this._log),this._gameStateHistory=[]}get log(){return this._log}get deviceUpdatedEmitter(){return this._deviceUpdatedEmitter}get gameStateHistory(){return this._gameStateHistory}get interpolation(){return this._interpolation}set interpolation(e){this._interpolation=e}get debugBoxes(){return this.renderer.debugBoxes}set debugBoxes(e){this.renderer.debugBoxes=e}connect(e,t,s,i,o,n,a){const r=new _(this.playerId,this._log);r.minLatency=t,r.maxLatency=s,r.packetLoss=i;const l=new _(e.playerId,e._log);l.minLatency=o,l.maxLatency=n,l.packetLoss=a,this._networkInterface.connect(r,l),e._networkInterface.connect(l,r)}reset(){this._log.clear(),this._gameStateHistory=[]}play(e,t,s,i,o){this.gameStateMachine=new U(this._log,t/1e3);let n=e.name+("cs"===e.type?this.isServer?"-server":"-client":"");const a=class{constructor(){}static build(e,t,s,i){switch(e){case"p2p-naive":return t.logInfo("Using p2p-naive netcode"),new z(t,s,i);case"p2p-stibbons":return t.logInfo("Using p2p-stibbons netcode"),new R(t,s,i);case"cs-lockstep-client":return t.logInfo("Using cs-lockstep-client netcode"),new B(t,s,i);case"cs-lockstep-server":return t.logInfo("Using cs-lockstep-server netcode"),new D(t,s,i);default:return t.logInfo(`Netcode ${e} not found`),null}}}.build(n,this._log,this._networkInterface,this.gameStateMachine);if(null===a)return;this.netcode=a,this._npcs=s,this._interpolation=i;const r=this.createWorld(),l=new $(0,r);l.peerCount=2,this.netcode.tickMs=t,this.netcode.start(l),this.renderer=new Y(this.log,this.canvas,this.netcode),this.renderer.debugBoxes=o,this.running=!0,window.requestAnimationFrame((()=>{this.gameLoop()}))}stop(){this.running=!1,this._networkInterface.closeConnections(),this._networkInterface.resetEmitters()}gameStateHistoryLog(){const e=this._gameStateHistory.reverse().join("\n");return this._gameStateHistory.reverse(),e}createStaticBody(e,t,s,i,n){const a=e.createBody({type:"static"});a.setUserData({width:i,height:n}),a.createFixture(o.Box(i/2/u.physics.worldScale,n/2/u.physics.worldScale)),a.setPosition(o.Vec2((t+i/2)/u.physics.worldScale,(s+n/2)/u.physics.worldScale))}createWorld(){const e=o.Vec2(0,0),t=o.World(e);this.createStaticBody(t,0,0,this.canvas.width,u.physics.borderThickness),this.createStaticBody(t,0,this.canvas.height-u.physics.borderThickness,this.canvas.width,u.physics.borderThickness),this.createStaticBody(t,0,0,u.physics.borderThickness,this.canvas.height),this.createStaticBody(t,this.canvas.width-u.physics.borderThickness,0,u.physics.borderThickness,this.canvas.height);const s={density:0,restitution:.4};u.players.forEach((e=>{const i=t.createBody({type:"dynamic",position:o.Vec2((e.x+e.size/2)/u.physics.worldScale,(e.y+e.size/2)/u.physics.worldScale),allowSleep:!1,awake:!0});i.createFixture(o.Box(e.size/2/u.physics.worldScale,e.size/2/u.physics.worldScale),s),i.setUserData(e)}));const i={density:0,restitution:1};let n=20;for(let a=0;a<this._npcs;a++){const e=t.createBody({type:"dynamic",position:o.Vec2((35+a*n+10)/u.physics.worldScale,(35+a*n+10)/u.physics.worldScale),allowSleep:!1,awake:!0});e.createFixture(o.Box(10/u.physics.worldScale,10/u.physics.worldScale),i),e.setUserData({id:100+a,size:n,color:"black"})}return t}gameLoop(){this.running&&(window.requestAnimationFrame((()=>{this.gameLoop()})),this.update(),this.draw())}update(){try{let e=this.netcode.tick();null!=e&&this._gameStateHistory.unshift(e)}catch(e){this._log.logError(e)}this._deviceUpdatedEmitter.notify()}draw(){this.renderer.render(this._interpolation)}}const W=new class{constructor(){t(this,"pressedKeys",[]),document.onkeydown=document.onkeyup=e=>{this.pressedKeys[e.keyCode]="keydown"===e.type}}isPressed(e){return this.pressedKeys[e]}};class X extends O{constructor(e,t,s,i,o,n){super(!1,e,n),this.playerId=e,this.keyUp=t,this.keyDown=s,this.keyLeft=i,this.keyRight=o,this.canvas=n}update(){const e=(W.isPressed(this.keyUp)?c:W.isPressed(this.keyDown)?h:l)+(W.isPressed(this.keyLeft)?m:W.isPressed(this.keyRight)?d:l),t=this.netcode.localCommandReceived(this.playerId,e);t&&(this.log.logInfo(`sending command: ${t.toFullString()}`),this._networkInterface.broadcast(new I(t))),super.update()}}class H extends O{constructor(e,t){super(!0,e,t),this.playerId=e,this.canvas=t}}(new class{constructor(){t(this,"deviceServer"),t(this,"devicePlayer1"),t(this,"devicePlayer2"),t(this,"p2pmode",!0),t(this,"panelControl"),t(this,"panelCanvas1"),t(this,"panelGamestates1"),t(this,"panelLog1"),t(this,"panelCanvas2"),t(this,"panelGamestates2"),t(this,"panelLog2"),t(this,"panelCanvasS"),t(this,"panelGamestatesS"),t(this,"panelLogS"),this.deviceServer=new H(0,document.getElementById("serverGameArea")),this.devicePlayer1=new X(u.players[0].id,u.players[0].keyUp,u.players[0].keyDown,u.players[0].keyLeft,u.players[0].keyRight,document.getElementById("player1GameArea")),this.devicePlayer2=new X(u.players[1].id,u.players[1].keyUp,u.players[1].keyDown,u.players[1].keyLeft,u.players[1].keyRight,document.getElementById("player2GameArea"))}build(){this.createWindows(),this.bootstrapAngular()}createWindows(){this.panelControl=n.create({headerTitle:"Control Panel",theme:"dimgrey",headerControls:{close:"remove",size:"xs"},panelSize:{width:"18em",height:"100%"},position:{my:"left-top",at:"left-top",offsetX:"0",offsetY:"0"},content:document.getElementById("controlPanel")}),this.panelGamestates1=n.create({headerTitle:"Player 1 Game States",theme:"DarkSlateBlue",contentOverflow:"auto",headerControls:{close:"remove",size:"xs"},resizeit:{handles:"n,s"},panelSize:{width:"22em",height:"50%"},position:{my:"left-top",at:"left-top",offsetX:"calc(100vw - 22em)",offsetY:"0"},content:document.getElementById("player1GameStates")}),this.panelCanvas1=n.create({headerTitle:"Player 1 Canvas",theme:"DarkSlateBlue",contentOverflow:"hide",headerControls:{close:"remove",size:"xs"},panelSize:{width:"310px",height:"calc(250px + 4.5em)"},position:{my:"left-top",at:"left-top",offsetX:"calc(18em + (100vw - 40em - 620px) / 3)",offsetY:"0"},content:document.getElementById("player1Canvas")}),this.panelLog1=n.create({headerTitle:"Player 1 Logs",theme:"DarkSlateBlue",contentOverflow:"auto",headerControls:{close:"remove",size:"xs"},panelSize:{width:"calc(100vw - 40em)",height:"calc((100vh - 250px - 4.5em) / 2)"},position:{my:"left-top",at:"left-top",offsetX:"18em",offsetY:"calc(250px + 4.5em)"},content:document.getElementById("player1Logs")}),this.panelGamestates2=n.create({headerTitle:"Player 2 Game States",theme:"OliveDrab",contentOverflow:"auto",headerControls:{close:"remove",size:"xs"},panelSize:{width:"350px",height:"50%"},position:{my:"left-top",at:"left-top",offsetX:"calc(100vw - 22em)",offsetY:"50%"},content:document.getElementById("player2GameStates")}),this.panelCanvas2=n.create({headerTitle:"Player 2 Canvas",theme:"OliveDrab",contentOverflow:"hide",headerControls:{close:"remove",size:"xs"},panelSize:{width:"310px",height:"calc(250px + 4.5em)"},position:{my:"left-top",at:"left-top",offsetX:"calc(100vw - 22em - 310px - (100vw - 40em - 620px) / 3)",offsetY:"0"},content:document.getElementById("player2Canvas")}),this.panelLog2=n.create({headerTitle:"Player 2 Logs",theme:"OliveDrab",contentOverflow:"auto",headerControls:{close:"remove",size:"xs"},panelSize:{width:"calc(100vw - 40em)",height:"calc((100vh - 250px - 4.5em) / 2)"},position:{my:"left-top",at:"left-top",offsetX:"18em",offsetY:"calc(250px + 4.5em + (100vh - 250px - 4.5em) / 2)"},content:document.getElementById("player2Logs")}),this.panelGamestatesS=n.create({headerTitle:"Server Game States",theme:"black",contentOverflow:"auto",headerControls:{close:"remove",size:"xs"},panelSize:{width:"350px",height:"50%"},position:{my:"left-top",at:"left-top",offsetX:"calc(100vw - 350px)",offsetY:"50%"},content:document.getElementById("serverGameStates")}),this.panelCanvasS=n.create({headerTitle:'Server "Canvas"',theme:"black",contentOverflow:"hide",headerControls:{close:"remove",size:"xs"},panelSize:{width:"310px",height:"calc(250px + 4.5em)"},position:{my:"left-top",at:"left-top",offsetX:"calc(50vw + 350px)",offsetY:"0"},content:document.getElementById("serverCanvas")}),this.panelLogS=n.create({headerTitle:"Server Logs",theme:"black",contentOverflow:"auto",headerControls:{close:"remove",size:"xs"},panelSize:{width:"calc(100vw - 40em)",height:"calc((100vh - 250px - 4.5em) / 2)"},position:{my:"left-top",at:"left-top",offsetX:"350px",offsetY:"75%"},content:document.getElementById("serverLogs")})}resetLayout(){this.panelControl.reposition({my:"left-top",at:"left-top",offsetX:"0",offsetY:"0"}),this.panelControl.resize({width:"18em",height:"100%"}),this.p2pmode?(this.panelGamestates1.reposition({my:"left-top",at:"left-top",offsetX:"calc(100vw - 22em)",offsetY:"0"}),this.panelGamestates1.resize({width:"22em",height:"50%"}),this.panelCanvas1.reposition({my:"left-top",at:"left-top",offsetX:"calc(18em + (100vw - 40em - 620px) / 3)",offsetY:"0"}),this.panelCanvas1.resize({width:"310px",height:"calc(250px + 4.5em)"}),this.panelLog1.reposition({my:"left-top",at:"left-top",offsetX:"18em",offsetY:"calc(250px + 4.5em)"}),this.panelLog1.resize({width:"calc(100vw - 40em)",height:"calc((100vh - 250px - 4.5em) / 2)"}),this.panelGamestates2.reposition({my:"left-top",at:"left-top",offsetX:"calc(100vw - 22em)",offsetY:"50%"}),this.panelGamestates2.resize({width:"22em",height:"50%"}),this.panelCanvas2.reposition({my:"left-top",at:"left-top",offsetX:"calc(100vw - 22em - 310px - (100vw - 40em - 620px) / 3)",offsetY:"0"}),this.panelCanvas2.resize({width:"310px",height:"calc(250px + 4.5em)"}),this.panelLog2.reposition({my:"left-top",at:"left-top",offsetX:"18em",offsetY:"calc(250px + 4.5em + (100vh - 250px - 4.5em) / 2)"}),this.panelLog2.resize({width:"calc(100vw - 40em)",height:"calc((100vh - 250px - 4.5em) / 2)"}),this.panelGamestatesS.reposition({my:"left-top",at:"left-top",offsetX:"1000vw",offsetY:"1000vh"}),this.panelCanvasS.reposition({my:"left-top",at:"left-top",offsetX:"1000vw",offsetY:"1000vh"}),this.panelLogS.reposition({my:"left-top",at:"left-top",offsetX:"1000vw",offsetY:"1000vh"})):(this.panelGamestates1.reposition({my:"left-top",at:"left-top",offsetX:"calc(100vw - 22em)",offsetY:"0"}),this.panelGamestates1.resize({width:"22em",height:"33%"}),this.panelCanvas1.reposition({my:"left-top",at:"left-top",offsetX:"18em",offsetY:"0"}),this.panelCanvas1.resize({width:"310px",height:"calc(250px + 4.5em)"}),this.panelLog1.reposition({my:"left-top",at:"left-top",offsetX:"18em",offsetY:"calc(250px + 4.5em)"}),this.panelLog1.resize({width:"calc(100vw - 40em - 4em)",height:"calc(100vh - 250px - 4.5em - 4em)"}),this.panelGamestates2.reposition({my:"left-top",at:"left-top",offsetX:"calc(100vw - 22em)",offsetY:"33%"}),this.panelGamestates2.resize({width:"22em",height:"33%"}),this.panelCanvas2.reposition({my:"left-top",at:"left-top",offsetX:"calc(18em + 310px)",offsetY:"0"}),this.panelCanvas2.resize({width:"310px",height:"calc(250px + 4.5em)"}),this.panelLog2.reposition({my:"left-top",at:"left-top",offsetX:"20em",offsetY:"calc(250px + 4.5em + 2em)"}),this.panelLog2.resize({width:"calc(100vw - 40em - 4em)",height:"calc(100vh - 250px - 4.5em - 4em)"}),this.panelGamestatesS.reposition({my:"left-top",at:"left-top",offsetX:"calc(100vw - 22em)",offsetY:"66%"}),this.panelGamestatesS.resize({width:"22em",height:"33%"}),this.panelCanvasS.reposition({my:"left-top",at:"left-top",offsetX:"calc(18em + 620px)",offsetY:"0"}),this.panelCanvasS.resize({width:"310px",height:"calc(250px + 4.5em)"}),this.panelLogS.reposition({my:"left-top",at:"left-top",offsetX:"22em",offsetY:"calc(250px + 4.5em + 4em)"}),this.panelLogS.resize({width:"calc(100vw - 40em - 4em)",height:"calc(100vh - 250px - 4.5em - 4em)"})),this.panelGamestates1.front(),this.panelGamestates2.front(),this.panelGamestatesS.front(),this.panelLog1.front(),this.panelLog2.front(),this.panelLogS.front(),this.panelCanvas1.front(),this.panelCanvas2.front(),this.panelCanvasS.front()}bootstrapAngular(){a.module("app",[]).controller("mainCtrl",["$scope",e=>{e.info={btnStopEnabled:!1,btnPlayEnabled:!0,btnSaveEnabled:!0,tick:u.network.tickMs,netcodes:u.netcodes,algorithm:u.netcodes[0],latency1:{min:u.network.minLatency1,max:u.network.maxLatency1},packetLoss1:u.network.packetLoss1,latency2:{min:u.network.minLatency2,max:u.network.maxLatency2},packetLoss2:u.network.packetLoss2,npcs:0,realtimeGameStates:!1,realtimeLogs:!1,interpolation:!0,debugBoxes:!0,syncScrollGs1:!0,syncScrollGs2:!0,syncScrollLog1:!0,syncScrollLog2:!0,logsPlayer1:[],logsPlayer2:[],gamestatesPlayer1:[],gamestatesPlayer2:[]};const t="p2p"===e.info.algorithm.type;this.p2pmode=t,this.resetLayout(),e.resetLayout=()=>{this.resetLayout()};const s=document.getElementById("player1GameStates"),i=document.getElementById("player2GameStates");a.element(s.parentElement).bind("scroll",(()=>{e.info.syncScrollGs1&&(i.parentElement.scrollTop=s.parentElement.scrollTop)})),a.element(i.parentElement).bind("scroll",(()=>{e.info.syncScrollGs2&&(s.parentElement.scrollTop=i.parentElement.scrollTop)}));const o=document.getElementById("player1Logs"),n=document.getElementById("player2Logs");a.element(o.parentElement).bind("scroll",(()=>{e.info.syncScrollLog1&&(n.parentElement.scrollTop=o.parentElement.scrollTop)})),a.element(n.parentElement).bind("scroll",(()=>{e.info.syncScrollLog2&&(o.parentElement.scrollTop=n.parentElement.scrollTop)})),this.deviceServer.deviceUpdatedEmitter.addEventListener((()=>{e.$apply()})),this.devicePlayer1.deviceUpdatedEmitter.addEventListener((()=>{e.$apply()})),this.devicePlayer2.deviceUpdatedEmitter.addEventListener((()=>{e.$apply()}));const l='<button class="jsPanel-btn jsPanel-btn-menu jsPanel-btn-md tooltip bottom" aria-label="Sync scroll"><span class="fas fa-arrows-alt-v toolbar-icon" style="vertical-align: text-top"></span><input type="checkbox" checked /></button>',c='<button class="jsPanel-btn jsPanel-btn-menu jsPanel-btn-md tooltip bottom" aria-label="Download"><span class="fas fa-download toolbar-icon"></span></button>';this.panelGamestates1.addControl({html:l,name:"sync",position:1,handler:()=>{e.info.syncScrollGs1=!e.info.syncScrollGs1}}),this.panelGamestates1.addControl({html:c,name:"download",position:2,handler:()=>{e.saveGamestates1()}}),this.panelGamestates2.addControl({html:l,name:"sync",position:1,handler:()=>{e.info.syncScrollGs2=!e.info.syncScrollGS2}}),this.panelGamestates2.addControl({html:c,name:"download",position:2,handler:()=>{e.saveGamestates2()}}),this.panelLog1.addControl({html:l,name:"sync",position:1,handler:()=>{e.info.syncScrollLog1=!e.info.syncScrollLog1}}),this.panelLog1.addControl({html:c,name:"download",position:2,handler:()=>{e.saveLogs1()}}),this.panelLog2.addControl({html:l,name:"sync",position:1,handler:()=>{e.info.syncScrollLog2=!e.info.syncScrollLog2}}),this.panelLog2.addControl({html:c,name:"download",position:2,handler:()=>{e.saveLogs2()}}),e.changeAlgorithm=()=>{const t="p2p"===e.info.algorithm.type;t!==this.p2pmode&&(this.p2pmode=t,this.resetLayout())},e.stop=()=>{this.deviceServer.stop(),this.devicePlayer1.stop(),this.devicePlayer2.stop(),e.info.btnStopEnabled=!1,e.info.btnPlayEnabled=!0,e.info.realtimeGameStates||(e.info.gamestatesServer=this.deviceServer.gameStateHistory,e.info.gamestatesPlayer1=this.devicePlayer1.gameStateHistory,e.info.gamestatesPlayer2=this.devicePlayer2.gameStateHistory),e.info.realtimeLogs||(e.info.logsServer=this.deviceServer.log.traces,e.info.logsPlayer1=this.devicePlayer1.log.traces,e.info.logsPlayer2=this.devicePlayer2.log.traces)},e.play=()=>{this.deviceServer.reset(),this.devicePlayer1.reset(),this.devicePlayer2.reset(),"p2p"===e.info.algorithm.type?(this.devicePlayer1.connect(this.devicePlayer2,e.info.latency1.min,e.info.latency1.max,e.info.packetLoss1,e.info.latency2.min,e.info.latency2.max,e.info.packetLoss2),this.devicePlayer1.play(e.info.algorithm,e.info.tick,e.info.npcs,e.info.interpolation,e.info.debugBoxes),this.devicePlayer2.play(e.info.algorithm,e.info.tick,e.info.npcs,e.info.interpolation,e.info.debugBoxes)):(this.devicePlayer1.connect(this.deviceServer,e.info.latency1.min,e.info.latency1.max,e.info.packetLoss1,e.info.latency1.min,e.info.latency1.max,e.info.packetLoss1),this.devicePlayer2.connect(this.deviceServer,e.info.latency2.min,e.info.latency2.max,e.info.packetLoss2,e.info.latency2.min,e.info.latency2.max,e.info.packetLoss2),this.deviceServer.play(e.info.algorithm,e.info.tick,e.info.npcs,e.info.interpolation,e.info.debugBoxes),this.devicePlayer1.play(e.info.algorithm,e.info.tick,e.info.npcs,e.info.interpolation,e.info.debugBoxes),this.devicePlayer2.play(e.info.algorithm,e.info.tick,e.info.npcs,e.info.interpolation,e.info.debugBoxes)),e.info.btnStopEnabled=!0,e.info.btnPlayEnabled=!1,e.checkRealtimeInfo()},e.checkRealtimeInfo=()=>{e.info.realtimeGameStates?(e.info.gamestatesServer=this.deviceServer.gameStateHistory,e.info.gamestatesPlayer1=this.devicePlayer1.gameStateHistory,e.info.gamestatesPlayer2=this.devicePlayer2.gameStateHistory):(e.info.gamestatesServer=[],e.info.gamestatesPlayer1=[],e.info.gamestatesPlayer2=[]),e.info.realtimeLogs?(e.info.logsServer=this.deviceServer.log.traces,e.info.logsPlayer1=this.devicePlayer1.log.traces,e.info.logsPlayer2=this.devicePlayer2.log.traces):(e.info.logsServer=[],e.info.logsPlayer1=[],e.info.logsPlayer2=[])},e.changeInterpolation=()=>{this.devicePlayer1.interpolation=e.info.interpolation,this.devicePlayer2.interpolation=e.info.interpolation},e.changeDebugBoxes=()=>{this.devicePlayer1.debugBoxes=e.info.debugBoxes,this.devicePlayer2.debugBoxes=e.info.debugBoxes},e.saveAll=()=>{const t=new Date,s=r.exports.createWriteStream(`${t.getFullYear()}${t.getMonth()}${t.getDate()}${t.getHours()}${t.getMinutes()}${t.getSeconds()}-${e.info.algorithm}.log`).getWriter(),i=new TextEncoder,o=`--------------------\nPLAYER 1 GAME STATES\n--------------------\n${this.devicePlayer1.gameStateHistoryLog()}\n-------------\nPLAYER 1 LOGS\n-------------\n${this.devicePlayer1.log}\n\n--------------------\nPLAYER 2 GAME STATES\n--------------------\n${this.devicePlayer2.gameStateHistoryLog()}\n-------------\nPLAYER 2 LOGS\n-------------\n${this.devicePlayer2.log}`,n=i.encode(o);s.write(n),s.close()},e.saveGamestates1=()=>{const t=new Date,s=r.exports.createWriteStream(`${t.getFullYear()}${t.getMonth()}${t.getDate()}${t.getHours()}${t.getMinutes()}${t.getSeconds()}-${e.info.algorithm}-p1states.log`).getWriter(),i=(new TextEncoder).encode(this.devicePlayer1.gameStateHistoryLog());s.write(i),s.close()},e.saveLogs1=()=>{const t=new Date,s=r.exports.createWriteStream(`${t.getFullYear()}${t.getMonth()}${t.getDate()}${t.getHours()}${t.getMinutes()}${t.getSeconds()}-${e.info.algorithm}-p1logs.log`).getWriter(),i=(new TextEncoder).encode(this.devicePlayer1.log.toString());s.write(i),s.close()},e.saveGamestates2=()=>{const t=new Date,s=r.exports.createWriteStream(`${t.getFullYear()}${t.getMonth()}${t.getDate()}${t.getHours()}${t.getMinutes()}${t.getSeconds()}-${e.info.algorithm}-p2states.log`).getWriter(),i=(new TextEncoder).encode(this.devicePlayer2.gameStateHistoryLog());s.write(i),s.close()},e.saveLogs2=()=>{const t=new Date,s=r.exports.createWriteStream(`${t.getFullYear()}${t.getMonth()}${t.getDate()}${t.getHours()}${t.getMinutes()}${t.getSeconds()}-${e.info.algorithm}-p2logs.log`).getWriter(),i=(new TextEncoder).encode(this.devicePlayer2.log.toString());s.write(i),s.close()}}])}}).build();
